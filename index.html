<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Studio - Album Lab</title>
    
    <!-- LIBRERÍAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- HTML2CANVAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Dosis:wght@400;600;800&family=Cinzel:wght@700&family=Merriweather&family=Luckiest+Guy&family=Fredoka:wght@400;600&family=Permanent+Marker&family=Bangers&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <!-- REACT -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- 1. PALETA "NEON GLASS" (GEN Z AESTHETIC) --- */
        :root {
            --bg-main: #F3F4F6;
            --sidebar-bg: rgba(255, 255, 255, 0.85);
            --accent-primary: #6366f1; /* Indigo moderno */
            --accent-secondary: #ec4899; /* Pink pop */
            --accent-tertiary: #06b6d4; /* Cyan electric */
            --hot-orange: #F97316;
            --pop-pink: #EC4899;
            --shadow-grape: #6D28D9;
            --shadow-lime: #4D7C0F;
            --shadow-cyan: #0097bd;
            --shadow-orange: #C2410C;
            --shadow-pink: #BE185D;
            --dark-text: #1e293b;
            --muted-text: #64748b;
            --book-width: 460px; --book-height: 600px; --paper-texture: #fdfbf7; --text-color: #2c3e50; --accent-color: #5d4037; --gold-color: #d4af37; --endpaper-bg: #a5d6a7; --endpaper-dot: #ffffff; 
            
            /* MOODBOARD VARS */
            --mat-yellow: #FFEB3B;
            --mat-red: #F44336;
            --mat-blue: #2196F3;
            --mat-green: #4CAF50;
            --rim-color: #FFD700; 

            /* STORYBOARD VARS */
            --sb-bg: #f0f4f8;
            --sb-yellow: #FFEA00;
            --sb-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        
        body { 
            font-family: 'Outfit', sans-serif; 
            color: var(--dark-text); 
            background-color: var(--bg-main);
        }
        
        h1, h2, .brand-title, .module-title, .pop-title { font-family: 'Dosis', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
        .kids-title { font-family: 'Luckiest Guy', cursive; letter-spacing: 1px; }
        .section-label { font-family: 'Outfit', sans-serif; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; font-size: 0.75rem; color: #94a3b8; margin-top: 1.5rem; margin-bottom: 0.5rem; padding-left: 1rem; }

        /* Glassmorphism Panels */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5); 
            border-radius: 24px; 
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.05); 
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .glass-panel:hover { box-shadow: 0 12px 40px rgba(31, 38, 135, 0.1); transform: translateY(-2px); }

        /* Botones "Pill" Modernos */
        .btn-modern, .btn-gummy { 
            border: none; outline: none; cursor: pointer; 
            font-family: 'Outfit', sans-serif; font-weight: 600; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            padding: 10px 24px; border-radius: 100px; 
            color: white; transition: all 0.2s ease; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-modern:hover, .btn-gummy:hover { transform: scale(1.03); filter: brightness(1.1); }
        .btn-modern:active, .btn-gummy:active { transform: scale(0.97); }
        
        .btn-grape { background: var(--hyper-grape); box-shadow: 0 4px 0 #6D28D9; }
        .btn-lime { background: var(--lime-punch); box-shadow: 0 4px 0 #4D7C0F; }
        .btn-cyan { background: var(--electric-cyan); box-shadow: 0 4px 0 #0097bd; }
        .btn-orange { background: var(--hot-orange); box-shadow: 0 4px 0 #C2410C; }
        .btn-pink { background: var(--pop-pink); box-shadow: 0 4px 0 #BE185D; }
        .btn-indigo { background: #6366f1; box-shadow: 0 4px 0 #4338ca; }
        
        .bg-gradient-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .bg-gradient-accent { background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); }
        .bg-gradient-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-gradient-dark { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }

        /* LOGIN STYLES */
        .login-split-wrapper { display: flex; width: 100%; height: 100%; background: white; overflow: hidden; }
        .login-visual-side { flex: 1.2; background-image: url('https://github.com/libroalbum/crear-libro-album-digital/blob/main/bienvenida.png?raw=true'); background-size: cover; background-position: center; position: relative; }
        .visual-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%); padding: 60px 40px; color: white; display: flex; flex-direction: column; justify-content: flex-end; }
        .login-form-side { flex: 0 0 500px; display: flex; flex-direction: column; justify-content: center; padding: 60px; background-color: #ffffff; position: relative; overflow-y: auto; }
        .login-brand-title { font-family: 'Luckiest Guy', cursive; font-size: 3rem; color: var(--accent-primary); margin-bottom: 10px; line-height: 1; text-transform: uppercase; letter-spacing: 1px; }
        .login-description { font-size: 1.1rem; color: #64748b; margin-bottom: 30px; line-height: 1.6; }
        .features-mini { display: flex; gap: 15px; margin-bottom: 40px; }
        .feature-pill { background: #f1f5f9; padding: 8px 15px; border-radius: 12px; font-size: 0.85rem; color: #475569; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .feature-pill i { color: var(--accent-secondary); }
        .login-box { background: white; padding: 30px; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); }
        .input-field-clean { width: 100%; padding: 14px 15px 14px 45px; border: 2px solid #f1f5f9; border-radius: 12px; font-family: 'Outfit', sans-serif; font-size: 1rem; color: #334155; background: #f8fafc; transition: all 0.2s; }
        .input-field-clean:focus { border-color: var(--accent-primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); outline: none; }
        .btn-login-clean { background-color: #0284c7; color: white; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1rem; padding: 14px; width: 100%; border-radius: 12px; border: none; cursor: pointer; margin-top: 10px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.2); }
        .btn-login-clean:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(2, 132, 199, 0.3); }

        @media (max-width: 900px) {
            .login-split-wrapper { flex-direction: column; }
            .login-visual-side { flex: 0 0 30vh; order: -1; }
            .visual-overlay { padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); }
            .login-form-side { flex: 1; padding: 30px 20px; width: 100%; }
            .login-brand-title { font-size: 2.5rem; }
            .features-mini { flex-wrap: wrap; }
        }
        
        /* LAYOUT SIDEBAR */
        .classroom-container { display: flex; height: 100%; width: 100%; }
        .classroom-sidebar { width: 280px; background: var(--sidebar-bg); backdrop-filter: blur(10px); border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; padding: 25px; z-index: 50; flex-shrink: 0; overflow-y: auto; }
        .sidebar-logo { font-family: 'Dosis', sans-serif; font-weight: 800; font-size: 1.8rem; background: linear-gradient(to right, #6366f1, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 30px; text-align: left; letter-spacing: -1px; }
        .menu-item { padding: 10px 16px; margin-bottom: 4px; border-radius: 12px; cursor: pointer; font-weight: 500; color: #64748b; display: flex; align-items: center; gap: 12px; transition: all 0.2s; font-family: 'Outfit', sans-serif; font-size: 0.95rem; }
        .menu-item:hover { background: white; color: var(--accent-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.03); transform: translateX(4px); }
        .menu-item.active { background: var(--accent-primary); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .menu-item.active i { color: white; }
        .menu-item i { width: 24px; text-align: center; font-size: 1.1rem; transition: 0.2s; }

        /* AJUSTE SOLICITADO: FONDO DEL TABLERO */
        .classroom-content { flex: 1; background-color: #F0F4F8; overflow-y: auto; padding: 30px 50px; position: relative; display: flex; flex-direction: column; }
        
        /* Dashboard Grid System */
        .bento-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 20px; }
        .activity-card { background: white; border-radius: 20px; padding: 20px; border: 1px solid #f1f5f9; position: relative; overflow: hidden; transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; height: 220px; }
        .activity-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); border-color: var(--accent-primary); }
        .activity-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: var(--card-color, #cbd5e1); }
        .ac-icon { width: 50px; height: 50px; border-radius: 14px; background: #f8fafc; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--card-color); margin-bottom: 15px; }
        .ac-title { font-family: 'Dosis', sans-serif; font-weight: 700; font-size: 1.4rem; color: var(--dark-text); line-height: 1.1; }
        .ac-desc { font-size: 0.85rem; color: #94a3b8; margin-top: 5px; line-height: 1.4; }
        .ac-arrow { align-self: flex-end; width: 30px; height: 30px; border-radius: 50%; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; color: #cbd5e1; transition: 0.2s; }
        .activity-card:hover .ac-arrow { background: var(--card-color); border-color: var(--card-color); color: white; }

        /* TOP BAR PROFILE */
        .top-bar-glass { position: sticky; top: 0; z-index: 40; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; flex-shrink: 0; }
        .page-header-title { font-size: 2rem; font-weight: 800; color: var(--accent-primary); font-family: 'Dosis'; letter-spacing: -1px; line-height: 1; }
        
        .user-chip { display: flex; align-items: center; gap: 12px; background: white; padding: 6px 8px 6px 15px; border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .user-chip:hover { transform: translateY(-2px); border-color: var(--accent-primary); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #e2e8f0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.1; margin-right: 5px; }
        .user-name { font-weight: 700; font-size: 0.9rem; color: var(--dark-text); font-family: 'Outfit'; }
        .user-role { font-size: 0.7rem; color: var(--accent-primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* EDITOR STYLES */
        .canvas-grid { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #2b2d42; background-image: radial-gradient(#3d405b 1px, transparent 1px); background-size: 30px 30px; width: 100%; height: 100%; }
        .sidebar-editor { width: 70px; height: 100%; background: #1e1e24; border-right: 1px solid #333; display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 40; gap: 15px; flex-shrink: 0; }
        .icon-chunk { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.1); }
        .icon-chunk:hover { background: var(--accent-primary); transform: scale(1.1); }
        
        /* ESTILOS DEL LIBRO */
        #stage { perspective: 2500px; display: flex; align-items: center; justify-content: center; transition: transform 0.5s ease; transform-style: preserve-3d; }
        .book { position: relative; width: var(--book-width); height: var(--book-height); transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .book::before { content: ''; position: absolute; z-index: -1; width: 96%; height: 96%; left: 5%; top: 5%; background: rgba(0,0,0,0.2); filter: blur(20px); border-radius: 20px; transition: all 0.8s ease-in-out; opacity: 0.5; }
        .book.opened { transform: translateX(50%); } .book.opened::before { width: 196%; left: -95%; opacity: 0.4; background: rgba(0,0,0,0.15); } .book.closed-back { transform: translateX(100%); } .book.closed-back::before { width: 96%; left: -99%; }
        .paper { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: left center; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); transform-style: preserve-3d; }
        .paper.flipped { transform: rotateY(-180deg); z-index: 0; }
        .front, .back { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background-color: var(--paper-texture); backface-visibility: hidden; overflow: hidden; border-radius: 2px 5px 5px 2px; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .front { z-index: 2; border-right: 1px solid rgba(0,0,0,0.1); } .back { z-index: 1; transform: rotateY(180deg); border-left: 1px solid rgba(0,0,0,0.1); border-radius: 5px 2px 2px 5px; }
        .front::after { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 25px; background: linear-gradient(to right, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%); pointer-events: none; z-index: 10; }
        .back::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 25px; background: linear-gradient(to left, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%); pointer-events: none; z-index: 10; }
        .image-page { background-size: cover; background-position: center; background-color: #fff; }
        .text-page { background-color: #fffefae6; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; }
        .inline-input-title { font-family: 'Cinzel', serif; color: var(--accent-color); font-size: 1.4rem; background: transparent; border: 1px dashed transparent; text-align: center; width: 100%; margin-bottom: 5px; outline: none; padding: 5px; border-bottom: 2px solid var(--gold-color); }
        .inline-input-text { font-family: 'Merriweather', serif; font-size: 0.95rem; line-height: 1.8; color: #555; font-style: italic; background: transparent; border: 1px dashed transparent; text-align: center; width: 100%; outline: none; resize: none; overflow: hidden; padding: 5px; }
        .endpaper { background-color: var(--endpaper-bg); background-size: cover; background-position: center; background-repeat: no-repeat; }
        .page-number { position: absolute; bottom: 20px; font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-color); font-weight: bold; pointer-events: none; }
        .front .page-number { right: 20px; } .back .page-number { left: 20px; }
        
        .edit-overlay { position: absolute; inset: 0; background: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(4px); z-index: 20; }
        .editor-mode .front:hover .edit-overlay, .editor-mode .back:hover .edit-overlay { opacity: 1; }
        .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); width: 50px; height: 50px; border-radius: 50%; background: white; border: none; color: var(--dark-text); font-size: 1.2rem; cursor: pointer; transition: 0.2s; z-index: 90; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .nav-btn:hover { transform: translateY(-55%) scale(1.1); background: var(--accent-primary); color: white; }
        .prev-btn { left: 40px; } .next-btn { right: 40px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); text-align: center; animation: floatUp 0.3s ease-out; }
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 900px) {
            :root { --book-width: 35vw; --book-height: calc(35vw * 1.35); }
            .classroom-container { flex-direction: column; }
            .classroom-sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; border-right: none; border-bottom: 1px solid #e2e8f0; background: white; gap: 10px; align-items: center; }
            .sidebar-logo { display: none; }
            .menu-item { margin-bottom: 0; white-space: nowrap; font-size: 0.85rem; padding: 8px 12px; flex-shrink: 0; }
            .section-label { display: none; } 
            .classroom-content { padding: 15px; }
            .bento-grid { grid-template-columns: 1fr; }
            .user-info { display: none; }
            .user-avatar { width: 32px; height: 32px; }
            #stage { transform: scale(1); }
            .book-showcase { height: 300px; }
            .nav-btn { width: 35px; height: 35px; font-size: 0.9rem; }
            .prev-btn { left: 5px; } .next-btn { right: 5px; }
        }

        /* ESTILOS DE LA BURBUJA (NUEVO) */
        .ped-unit-container { display: flex; flex-direction: column; width: 280px; position: fixed; top: 75px; right: 20px; z-index: 9999; animation: slideInRight 0.6s ease-out; align-items: flex-end; }
        .ped-cloud { background-color: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); border: 2px solid var(--accent-primary); position: relative; margin-bottom: 15px; text-align: right; }
        .ped-cloud::after { content: ''; position: absolute; top: 100%; right: 40px; left: auto; border-width: 12px 12px 0 12px; border-style: solid; border-color: #fff transparent transparent transparent; }
        .ped-cloud::before { content: ''; position: absolute; top: 100%; right: 37px; left: auto; border-width: 15px 15px 0 15px; border-style: solid; border-color: var(--accent-primary) transparent transparent transparent; z-index: -1; }
        .ped-cloud h3 { font-family: 'Cinzel', serif; color: var(--accent-primary); font-size: 1.1rem; margin: 0 0 10px 0; border-bottom: 2px solid var(--gold-color); display: inline-block; padding-bottom: 3px; font-weight: 700; }
        .ped-cloud p { font-family: 'Outfit', sans-serif; font-size: 0.9rem; color: #4b5563; line-height: 1.5; margin: 0; }
        .ped-character { width: 130px; height: auto; margin-right: 10px; transform: scaleX(-1); filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- ESTILOS MOODBOARD --- */
        .moodboard-wrapper {
            position: relative; width: 100%; height: 100%; background-color: #263238; 
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px; overflow: hidden; display: flex; align-items: center; justify-content: center;
            border-radius: 20px;
        }
        #doodle-mat {
            position: relative; width: 95%; height: 90%; max-width: 1600px; background-color: var(--mat-blue);
            background-image: linear-gradient(90deg, var(--mat-red) 25%, var(--mat-yellow) 25%, var(--mat-yellow) 50%, var(--mat-blue) 50%, var(--mat-blue) 75%, var(--mat-green) 75%);
            background-size: 100px 100%; display: flex; flex-direction: column; padding: 60px; padding-top: 0;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6); border-radius: 20px;
        }
        #mat-header {
            background-color: var(--mat-red); width: calc(100% + 120px); margin-left: -60px; height: 80px;
            display: flex; align-items: center; justify-content: center; border-bottom: 5px solid rgba(0,0,0,0.1);
            position: relative; z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 20px 20px 0 0;
        }
        #mat-title { font-family: 'Bangers', cursive; font-size: 3rem; color: #fff; text-shadow: 2px 2px 0px #333, 4px 4px 0px rgba(0,0,0,0.2); letter-spacing: 2px; }
        #canvas-area {
            flex-grow: 1; width: 100%; background-color: white; border-radius: 0 0 15px 15px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.15); position: relative; z-index: 2; overflow: hidden;
            background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 25px 25px;
            display: flex; justify-content: center; align-items: flex-start;
        }
        #instruction-text { margin-top: 20px; font-family: 'Fredoka', sans-serif; color: #ccc; font-size: 1.2rem; text-align: center; pointer-events: none; user-select: none; z-index: 0; }
        #toolbar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95);
            padding: 8px 20px; border-radius: 50px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); display: flex; gap: 15px; z-index: 5000;
            border: 3px solid var(--rim-color); transition: z-index 0.3s;
        }
        .tool-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #555; transition: 0.2s; position: relative; }
        .tool-btn i { font-size: 1.4rem; margin-bottom: 2px; background: #f0f0f0; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; box-shadow: 0 3px 5px rgba(0,0,0,0.15); }
        .tool-btn:hover i { transform: translateY(-5px) scale(1.1); color: white; }
        #btn-text:hover i { background: var(--mat-red); }
        #btn-image:hover i { background: var(--mat-blue); }
        #btn-clear:hover i { background: #ff5252; }
        #btn-save:hover i { background: var(--mat-green); }
        #btn-save-cloud:hover i { background: #6366f1; }
        
        .board-item {
            position: absolute; display: inline-block; cursor: grab; transition: box-shadow 0.2s; transform-origin: center center;
            background: white; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border-radius: 4px;
            min-width: 100px; min-height: 100px; border: 1px solid #eee; z-index: 100;
        }
        .board-item:active { cursor: grabbing; }
        .board-item.selected { box-shadow: 0 0 0 3px var(--mat-blue), 0 15px 40px rgba(0,0,0,0.3); z-index: 1000 !important; }
        .board-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; display: block; }
        .board-item.text-item { background: rgba(255,255,255,0.9); padding: 10px; border: 1px solid #eee; }
        .text-content { font-family: 'Permanent Marker', cursive; font-size: 1.5rem; color: #333; outline: none; background: transparent; width: 100%; height: 100%; text-align: center; cursor: text; user-select: text; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        .handle-btn { width: 30px; height: 30px; border-radius: 50%; position: absolute; display: none; align-items: center; justify-content: center; font-size: 1rem; color: white; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; z-index: 2000; }
        .board-item.selected .handle-btn { display: flex; }
        .delete-handle { background: #ff5252; top: -18px; left: -18px; }
        .resize-handle { background: var(--mat-blue); top: -18px; right: -18px; cursor: nwse-resize; }
        .rotate-handle { background: var(--mat-yellow); color: #333; top: -30px; left: 50%; transform: translateX(-50%); cursor: grab; }
        .rotate-handle:active { cursor: grabbing; }

        /* --- ESTILOS STORYBOARD --- */
        .storyboard-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; background-color: var(--sb-bg); background-image: radial-gradient(var(--dot-color) 2px, transparent 2px); background-size: 30px 30px; overflow-y: auto; padding: 20px; }
        
        #sb-toolbar {
            position: sticky; top: 10px; margin-bottom: 30px; z-index: 2000;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            display: flex; gap: 12px; align-items: center;
            border: 2px solid white; flex-wrap: wrap; justify-content: center;
        }
        
        .btn-main {
            border: none; padding: 10px 20px; border-radius: 30px;
            font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 0.95rem;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; align-items: center; gap: 8px; white-space: nowrap;
            color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-main:hover { transform: translateY(-2px); }
        .btn-main:active { transform: scale(0.95); }
        #btn-add { background: linear-gradient(135deg, #FF4081, #F50057); }
        #btn-save { background: linear-gradient(135deg, #00E5FF, #00B0FF); }
        #btn-save-cloud { background: linear-gradient(135deg, #6366f1, #8b5cf6); }

        #sb-board {
            width: 100%; display: grid;
            grid-template-columns: repeat(auto-fit, 240px); grid-auto-rows: 250px; 
            gap: 25px; justify-content: center; padding-bottom: 50px;
        }

        .note {
            position: relative; width: 100%; height: 100%;
            background-color: var(--sb-yellow); border-radius: 16px; 
            box-shadow: var(--sb-shadow); padding: 10px 15px 15px 15px; 
            display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s;
            cursor: grab; overflow: hidden;
        }
        .note.sortable-dragging { opacity: 0.5; transform: scale(0.95); border: 2px dashed #333; cursor: grabbing; }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .page-toggle { font-size: 0.75rem; font-weight: 700; color: rgba(0,0,0,0.6); display: flex; align-items: center; gap: 4px; cursor: pointer; background: rgba(255,255,255,0.4); padding: 2px 6px; border-radius: 8px; }
        .scene-badge { background: rgba(255,255,255,0.6); border-radius: 12px; padding: 2px 8px; font-size: 0.8rem; font-weight: 700; color: #444; display: flex; align-items: center; gap: 5px; }
        .scene-number-input { width: 30px; border: none; background: transparent; font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 0.9rem; color: #222; text-align: center; outline: none; }
        .note-body { flex-grow: 1; display: flex; flex-direction: column; gap: 6px; overflow: hidden; }
        .field-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: rgba(0,0,0,0.6); margin-bottom: 1px; display: flex; align-items: center; gap: 5px; }
        .editable-area {
            width: 100%; background: rgba(255,255,255,0.4); border-radius: 8px; padding: 6px 8px; 
            font-size: 0.7rem; line-height: 1.25; color: #222; font-weight: 500; outline: none; 
            border: 1px solid transparent; min-height: 40px; flex-grow: 1; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto;
        }
        .editable-area:focus { background: rgba(255,255,255,0.8); }
        .editable-area:empty:before { content: attr(placeholder); color: rgba(0,0,0,0.3); font-style: italic; }
        .note-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; opacity: 0; transition: opacity 0.2s; }
        .note:hover .note-controls { opacity: 1; }
        .color-picker { display: flex; gap: 4px; }
        .color-dot { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.6); transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.2); }
        .btn-delete { background: rgba(255,255,255,0.5); border: none; color: #d32f2f; font-size: 1rem; cursor: pointer; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .btn-delete:hover { background: rgba(255, 82, 82, 0.3); }

        /* INTRO OVERLAYS - MOODBOARD & STORYBOARD */
        .mb-intro-overlay, .sb-intro-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; 
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .mb-intro-modal {
            background: #fff; width: 90%; max-width: 550px; padding: 40px;
            border-radius: 20px; text-align: center; border: 5px solid var(--rim-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); font-family: 'Lato', sans-serif;
            position: relative; animation: popIn 0.5s;
        }
        .sb-intro-modal {
            background: #fff; width: 90%; max-width: 500px; padding: 40px 30px;
            border-radius: 20px; text-align: center; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 4px solid var(--gold-color);
            font-family: 'Lato', sans-serif; animation: popIn 0.5s;
        }
        .intro-character-circle {
            width: 120px; height: 120px; background: var(--endpaper-bg); 
            border-radius: 50%; margin: -70px auto 20px auto; 
            border: 5px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            overflow: hidden; display: flex; align-items: flex-end; justify-content: center;
        }
        .intro-character-img { width: 80%; height: auto; }
        .intro-title { font-family: 'Cinzel', serif; color: var(--accent-color); font-size: 2rem; margin-bottom: 20px; }
        .intro-text { color: #555; line-height: 1.6; font-size: 1.1rem; margin-bottom: 30px; }
        .action-btn {
            background: var(--accent-color); color: white; padding: 12px 30px; border: none;
            border-radius: 30px; font-size: 1.1rem; cursor: pointer; font-family: 'Cinzel', serif;
            transition: 0.3s;
        }
        .action-btn:hover { transform: scale(1.05); background: var(--rim-color); color: #333; }
        @keyframes popIn { from{transform:scale(0.8);opacity:0;} to{transform:scale(1);opacity:1;} }
    </style>
</head>
<body>
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyAThH-edUt4Ep9BR-Xuy5Zjmgl9Nky1keU",
            authDomain: "libroalbum.firebaseapp.com",
            projectId: "libroalbum",
            storageBucket: "libroalbum.firebasestorage.app",
            messagingSenderId: "395438498580",
            appId: "1:395438498580:web:9b9fa76328fb034dee9801",
            measurementId: "G-C9LFEFG2Z0"
        };

        let app, auth, db, storage;
        try { 
            app = initializeApp(firebaseConfig); 
            auth = getAuth(app); 
            db = getFirestore(app); 
            storage = getStorage(app); 
        } catch (e) { console.error(e); }

        // --- UTILS DE SUBIDA ---
        const uploadImageToStorage = async (file, path) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 800; let width = img.width; let height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(async (blob) => {
                            if (!blob) return reject("Error al procesar imagen");
                            try {
                                const storageRef = ref(storage, path);
                                const snapshot = await uploadBytes(storageRef, blob);
                                const url = await getDownloadURL(snapshot.ref);
                                resolve(url);
                            } catch (err) { reject(err); }
                        }, 'image/jpeg', 0.8);
                    }; img.src = e.target.result;
                }; reader.readAsDataURL(file);
            });
        };

        const MASTER_TEMPLATE = {
            title: "Nuevo Libro",
            pages: [
                { id: 'c1', type: 'structure', front: { type: 'image-page', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20portada.png?raw=true' }, back: { type: 'endpaper', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20paginas%20guardas.png?raw=true' } },
                { id: 'c2', type: 'structure', front: { type: 'endpaper', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20paginas%20guardas.png?raw=true' }, back: { type: 'text-page', title: 'Hoja de Respeto', text: '(Título de la Obra)' } },
                { id: 'c3', type: 'structure', front: { type: 'text-page', title: 'Créditos', text: 'Autor: Tu Nombre\nAño: 2024' }, back: { type: 'text-page', title: 'Dedicatoria', text: 'Para...' } },
                { id: 'p1', type: 'content', front: { type: 'image-page', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20cuerpo.png?raw=true' }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20cuerpo.png?raw=true' } },
                { id: 'end', type: 'structure', front: { type: 'endpaper', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20paginas%20guardas.png?raw=true' }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20contraportada.png?raw=true' } }
            ]
        };

        // --- COMPONENTE MOODBOARD ---
        function MoodboardComponent({ user }) {
            const canvasRef = useRef(null);
            const [isSaving, setIsSaving] = useState(false);
            const [showIntro, setShowIntro] = useState(true); // Restaurado el estado del modal
            const zIndexCounter = useRef(100);

            useEffect(() => {
                const loadData = async () => {
                    if (!user) return;
                    try {
                        const docSnap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'moodboards', 'main'));
                        if (docSnap.exists()) { restoreBoard(docSnap.data().items); }
                    } catch (e) { console.error("Error cargando moodboard", e); }
                };
                loadData();
                const handlePaste = (e) => {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            const blob = items[i].getAsFile();
                            uploadImageToStorage(blob, `users/${user.uid}/moodboard/paste_${Date.now()}`)
                                .then(url => createImageElement(url))
                                .catch(err => alert("Error al pegar imagen: " + err));
                        }
                    }
                };
                document.addEventListener('paste', handlePaste);
                return () => document.removeEventListener('paste', handlePaste);
            }, [user]);

            const createBoardElement = (type) => {
                const div = document.createElement('div');
                div.className = 'board-item';
                div.style.zIndex = zIndexCounter.current++;
                div.style.transform = `rotate(0deg)`;
                div.style.left = '50px'; div.style.top = '50px'; 

                if (type === 'text') {
                    div.classList.add('text-item');
                    const p = document.createElement('div');
                    p.contentEditable = false; p.className = 'text-content'; p.innerText = "¡Doble clic para editar!";
                    div.ondblclick = (e) => { e.stopPropagation(); p.contentEditable = true; p.focus(); div.draggable = false; };
                    p.onblur = () => { p.contentEditable = false; };
                    p.onmousedown = (e) => { if(p.isContentEditable) e.stopPropagation(); };
                    div.appendChild(p); addControls(div);
                }
                
                const startDrag = (e) => {
                    if (type === 'text' && div.querySelector('.text-content').isContentEditable) return;
                    if (e.target.classList.contains('handle-btn') || e.target.closest('.handle-btn')) return;
                    document.querySelectorAll('.board-item').forEach(i => i.classList.remove('selected'));
                    div.classList.add('selected');
                    let startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    let startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                    let startLeft = div.offsetLeft; let startTop = div.offsetTop;
                    const move = (ev) => {
                        ev.preventDefault();
                        const cx = ev.type.includes('mouse') ? ev.clientX : ev.touches[0].clientX;
                        const cy = ev.type.includes('mouse') ? ev.clientY : ev.touches[0].clientY;
                        div.style.left = (startLeft + cx - startX) + 'px';
                        div.style.top = (startTop + cy - startY) + 'px';
                    };
                    const stop = () => {
                        document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop);
                        document.removeEventListener('touchmove', move); document.removeEventListener('touchend', stop);
                    };
                    document.addEventListener('mousemove', move); document.addEventListener('mouseup', stop);
                    document.addEventListener('touchmove', move, { passive: false }); document.addEventListener('touchend', stop);
                };
                div.onmousedown = startDrag; div.ontouchstart = startDrag;
                return div;
            };

            const addControls = (el) => {
                const delBtn = document.createElement('div'); delBtn.className = 'handle-btn delete-handle'; delBtn.innerHTML = '<i class="fas fa-times"></i>';
                delBtn.onclick = (e) => { e.stopPropagation(); el.remove(); };
                el.appendChild(delBtn);
                const rotBtn = document.createElement('div'); rotBtn.className = 'handle-btn rotate-handle'; rotBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                rotBtn.onmousedown = (e) => {
                    e.stopPropagation();
                    const rect = el.getBoundingClientRect(); const centerX = rect.left + rect.width / 2; const centerY = rect.top + rect.height / 2;
                    const move = (ev) => {
                        const cx = ev.clientX; const cy = ev.clientY;
                        const angle = Math.atan2(cy - centerY, cx - centerX);
                        el.style.transform = `rotate(${angle}rad)`;
                    };
                    const stop = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
                    document.addEventListener('mousemove', move); document.addEventListener('mouseup', stop);
                };
                el.appendChild(rotBtn);
            };

            const addText = () => { const el = createBoardElement('text'); canvasRef.current.appendChild(el); };
            const createImageElement = (src) => {
                const el = createBoardElement('image'); const img = document.createElement('img');
                img.src = src; img.ondragstart = () => false;
                el.appendChild(img); addControls(el); canvasRef.current.appendChild(el);
            };
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    uploadImageToStorage(file, `users/${user.uid}/moodboard/upl_${Date.now()}`)
                        .then(url => createImageElement(url)).catch(err => alert("Error: " + err));
                }
            };
            const clearBoard = () => { if(confirm("¿Borrar todo?")) canvasRef.current.innerHTML = '<p id="instruction-text">Copia y pega aquí los recursos que necesites para crear tu tablero de ideas</p>'; };
            const downloadImage = () => {
                document.querySelectorAll('.board-item').forEach(i => i.classList.remove('selected'));
                html2canvas(document.querySelector('.moodboard-wrapper'), { useCORS: true, scale: 2 }).then(canvas => {
                    const link = document.createElement('a'); link.download = 'mi-moodboard.png'; link.href = canvas.toDataURL(); link.click();
                });
            };
            const saveToCloud = async () => {
                setIsSaving(true);
                const items = [];
                canvasRef.current.querySelectorAll('.board-item').forEach(el => {
                    const isText = el.classList.contains('text-item');
                    items.push({
                        type: isText ? 'text' : 'image',
                        left: el.style.left, top: el.style.top,
                        transform: el.style.transform, zIndex: el.style.zIndex,
                        width: el.style.width, height: el.style.height,
                        content: isText ? el.querySelector('.text-content').innerText : el.querySelector('img').src
                    });
                });
                try {
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'moodboards', 'main'), { items });
                    alert("¡Trabajo guardado en la nube!");
                } catch(e) { alert("Error al guardar: " + e.message); }
                setIsSaving(false);
            };
            const restoreBoard = (items) => {
                if(!items) return;
                canvasRef.current.innerHTML = '<p id="instruction-text">Copia y pega aquí los recursos que necesites para crear tu tablero de ideas</p>';
                items.forEach(item => {
                    const el = createBoardElement(item.type);
                    el.style.left = item.left; el.style.top = item.top; el.style.transform = item.transform; el.style.zIndex = item.zIndex;
                    if(item.width) el.style.width = item.width; if(item.height) el.style.height = item.height;
                    if (item.type === 'text') { el.querySelector('.text-content').innerText = item.content; } 
                    else { const img = document.createElement('img'); img.src = item.content; img.ondragstart = () => false; el.appendChild(img); addControls(el); }
                    canvasRef.current.appendChild(el);
                });
            };

            return (
                <div className="moodboard-wrapper">
                    {showIntro && (
                        <div className="mb-intro-overlay">
                            <div className="mb-intro-modal">
                                <div className="intro-character-circle">
                                    <img src="https://raw.githubusercontent.com/libroalbum/libro-lbum-pedag-gico/main/images/personaje%20derecha.png" className="intro-character-img" alt="Guía"/>
                                </div>
                                <h2 className="intro-title">¡Bienvenido a tu Moodboard!</h2>
                                <p className="intro-text">
                                    Este es tu lienzo infinito de inspiración. Aquí podrás reunir imágenes, textos y colores para dar vida a la atmósfera de tu historia.
                                    <br/><br/>
                                    <strong>¡Tip Mágico!</strong> ✨ Copia imágenes de internet y pégalas (Ctrl+V) directamente.
                                </p>
                                <button className="action-btn" onClick={() => setShowIntro(false)}>¡A Crear!</button>
                            </div>
                        </div>
                    )}
                    <div id="doodle-mat">
                        <div id="mat-header"><h1 id="mat-title">MOOD BOARD</h1></div>
                        <div id="canvas-area" ref={canvasRef} onClick={(e) => { if(e.target.id === 'canvas-area') document.querySelectorAll('.board-item').forEach(i => i.classList.remove('selected')); }}>
                            <p id="instruction-text">Copia y pega aquí los recursos que necesites para crear tu tablero de ideas</p>
                        </div>
                        <div id="toolbar">
                            <button className="tool-btn" onClick={addText}><i className="fas fa-font"></i></button>
                            <label className="tool-btn"><i className="fas fa-image"></i><input type="file" hidden accept="image/*" onChange={handleImageUpload}/></label>
                            <button className="tool-btn" onClick={clearBoard}><i className="fas fa-trash-alt"></i></button>
                            <button className="tool-btn" onClick={downloadImage}><i className="fas fa-download"></i></button>
                            <button className="tool-btn" id="btn-save-cloud" onClick={saveToCloud} disabled={isSaving}><i className={`fas ${isSaving ? 'fa-spinner fa-spin' : 'fa-cloud-upload-alt'}`}></i></button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE STORYBOARD (NUEVO Y ADAPTADO) ---
        function StoryboardComponent({ user }) {
            const boardRef = useRef(null);
            const [isSaving, setIsSaving] = useState(false);
            const [showIntro, setShowIntro] = useState(true); // Restaurado modal
            
            const colors = [
                { bg: '#FFEB3B', name: 'Amarillo Sol' }, { bg: '#FF4081', name: 'Fucsia Neón' }, 
                { bg: '#00E5FF', name: 'Azul Eléctrico' }, { bg: '#76FF03', name: 'Verde Lima' }, 
                { bg: '#E040FB', name: 'Morado Vivo' }, { bg: '#FF9100', name: 'Naranja Fuego' }
            ];

            useEffect(() => {
                const loadData = async () => {
                    if (!user) return;
                    try {
                        const docSnap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'storyboards', 'main'));
                        if (docSnap.exists()) {
                            restoreBoard(docSnap.data().notes);
                        } else {
                            // Inicialización masiva para el Grid (Como en el original)
                            const initialNotesCount = 10;
                            const sampleData = [
                                { scene: "Intro: Parque soleado", dialog: "¡Qué buen día!" },
                                { scene: "Aparece el villano", dialog: "¡Jajaja!" },
                                { scene: "El héroe llega volando", dialog: "¡Alto ahí!" },
                                { scene: "Persecución", dialog: "(Sin diálogo)" },
                                { scene: "Final feliz", dialog: "¡Ganamos!" }
                            ];
                            for (let i = 0; i < initialNotesCount; i++) {
                                const data = sampleData[i] || { scene: "", dialog: "" };
                                const colorIndex = i % colors.length;
                                createNote(data.scene, data.dialog, colors[colorIndex].bg, i + 1);
                            }
                        }
                    } catch (e) { console.error("Error storyboard", e); }
                };
                loadData();
            }, [user]);

            const createNote = (sceneText, dialogText, colorCode, sceneNum) => {
                const note = document.createElement('div');
                note.className = 'note';
                note.style.backgroundColor = colorCode;
                note.setAttribute('draggable', 'true');
                note.innerHTML = `
                    <div class="note-header">
                        <label class="page-toggle"><input type="checkbox"> Doble Pág.</label>
                        <div class="scene-badge"># <input type="number" class="scene-number-input" value="${sceneNum}" min="1"></div>
                    </div>
                    <div class="note-body">
                        <div class="field-label"><i class="fa-solid fa-video"></i> Descripción de escena</div>
                        <div class="editable-area scene-input" contenteditable="true" placeholder="Describe el lugar...">${sceneText || ''}</div>
                        <div class="field-label" style="margin-top: 8px;"><i class="fa-solid fa-comments"></i> Diálogo</div>
                        <div class="editable-area dialogue-input" contenteditable="true" placeholder="¿Qué dicen?">${dialogText || ''}</div>
                    </div>
                    <div class="note-controls">
                        <div class="color-picker">
                            ${colors.map(c => `<div class="color-dot" style="background-color: ${c.bg}" data-color="${c.bg}" title="${c.name}"></div>`).join('')}
                        </div>
                        <button class="btn-delete" title="Borrar nota"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                `;
                
                note.querySelector('.btn-delete').onclick = () => { note.style.transform = "scale(0)"; setTimeout(() => note.remove(), 200); };
                note.querySelectorAll('.color-dot').forEach(dot => {
                    dot.onclick = () => { note.style.backgroundColor = dot.dataset.color; };
                });
                
                note.addEventListener('dragstart', (e) => { e.dataTransfer.effectAllowed = 'move'; e.target.classList.add('sortable-dragging'); setTimeout(() => e.target.style.opacity = '0.5', 0); });
                note.addEventListener('dragend', (e) => { e.target.classList.remove('sortable-dragging'); e.target.style.opacity = '1'; });
                
                note.querySelectorAll('.editable-area, input').forEach(input => {
                    input.addEventListener('mousedown', (e) => { note.setAttribute('draggable', 'false'); e.stopPropagation(); });
                    input.addEventListener('mouseup', () => note.setAttribute('draggable', 'true'));
                    input.addEventListener('mouseleave', () => note.setAttribute('draggable', 'true'));
                });

                if (boardRef.current) boardRef.current.appendChild(note);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                const draggingItem = document.querySelector('.sortable-dragging');
                if(!draggingItem) return;
                const siblings = [...boardRef.current.querySelectorAll('.note:not(.sortable-dragging)')];
                const nextSibling = siblings.find(sibling => {
                    const rect = sibling.getBoundingClientRect();
                    return e.clientX < rect.left + rect.width / 2;
                });
                boardRef.current.insertBefore(draggingItem, nextSibling);
            };

            const addNewNote = () => {
                const count = boardRef.current.querySelectorAll('.note').length;
                const randomColor = colors[Math.floor(Math.random() * colors.length)].bg;
                createNote("", "", randomColor, count + 1);
            };

            const saveToCloud = async () => {
                setIsSaving(true);
                const notesData = [];
                if (boardRef.current) {
                    boardRef.current.querySelectorAll('.note').forEach(note => {
                        notesData.push({
                            color: note.style.backgroundColor,
                            isDouble: note.querySelector('input[type="checkbox"]').checked,
                            sceneNum: note.querySelector('.scene-number-input').value,
                            sceneText: note.querySelector('.scene-input').innerText,
                            dialogText: note.querySelector('.dialogue-input').innerText
                        });
                    });
                }
                try {
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'storyboards', 'main'), { notes: notesData });
                    alert("¡Storyboard guardado en la nube!");
                } catch(e) { alert("Error al guardar: " + e.message); }
                setIsSaving(false);
            };

            const restoreBoard = (notes) => {
                if (boardRef.current) {
                    boardRef.current.innerHTML = '';
                    notes.forEach(n => {
                        createNote(n.sceneText, n.dialogText, n.color, n.sceneNum);
                        const lastNote = boardRef.current.lastElementChild;
                        if(lastNote && n.isDouble) lastNote.querySelector('input[type="checkbox"]').checked = true;
                    });
                }
            };

            const downloadImage = () => {
                html2canvas(document.querySelector('.storyboard-wrapper'), { scale: 2 }).then(canvas => {
                    const link = document.createElement('a'); link.download = 'mi-storyboard.png'; link.href = canvas.toDataURL(); link.click();
                });
            };

            return (
                <div className="storyboard-wrapper">
                    {showIntro && (
                        <div className="sb-intro-overlay">
                            <div className="sb-intro-modal">
                                <button className="absolute top-4 right-4 text-gray-400 hover:text-red-500" onClick={() => setShowIntro(false)}><i className="fas fa-times"></i></button>
                                <div className="intro-character-circle">
                                    <img src="https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/personaje%20derecha.png?raw=true" className="intro-character-img" alt="Guía"/>
                                </div>
                                <h2 className="intro-title">¡Hola, Aventurero!</h2>
                                <p className="intro-text">
                                    Bienvenido a tu taller creativo. Aquí construirás el <strong>Storyboard</strong> para tu libro álbum digital.
                                    <br/><br/>
                                    Usa este espacio para describir <strong>cómo imaginas cada escena</strong> y escribe los <strong>diálogos</strong> de tus personajes.
                                </p>
                                <button className="action-btn" onClick={() => setShowIntro(false)}>Comenzar a Crear</button>
                            </div>
                        </div>
                    )}
                    <div id="sb-toolbar">
                        <button className="btn-main" id="btn-add" onClick={addNewNote}><i className="fa-solid fa-plus"></i> Nueva Nota</button>
                        <button className="btn-main" id="btn-save" onClick={downloadImage}><i className="fa-solid fa-download"></i> Descargar</button>
                        <button className="btn-main" id="btn-save-cloud" onClick={saveToCloud} disabled={isSaving}>
                            <i className={`fas ${isSaving ? 'fa-spinner fa-spin' : 'fa-cloud-upload-alt'}`}></i> Guardar en Nube
                        </button>
                    </div>
                    <div id="sb-board" ref={boardRef} onDragOver={handleDragOver}></div>
                </div>
            );
        }

        // --- COMPONENTS BOOKVIEWER & REGISTRATION BUBBLE ---
        function BookViewer({ pages, activeIdx, setActiveIdx, isEditor, onUpdatePage }) {
            const audioRef = useRef(null);
            const [localIdx, setLocalIdx] = useState(activeIdx); 
            const currentIdx = isEditor ? activeIdx : localIdx;
            const isOpen = currentIdx >= 0 && currentIdx < pages.length - 1;
            const isClosedBack = currentIdx === pages.length - 1;
            const changePage = (newIdx) => { if(audioRef.current) { audioRef.current.currentTime=0; audioRef.current.play().catch(()=>{}); } if(isEditor) setActiveIdx(newIdx); else setLocalIdx(newIdx); };
            
            useEffect(() => {
                const handleKeyDown = (e) => { 
                    if (e.key === "ArrowRight" && currentIdx < pages.length-1) changePage(currentIdx+1); 
                    if (e.key === "ArrowLeft" && currentIdx >= 0) changePage(currentIdx-1); 
                };
                window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentIdx, pages]);

            const isEditableImage = (idx, side) => { if (idx === 1 && side === 'back') return false; if (idx === 2) return false; return true; };
            const isEditableTitle = (idx, side) => { if (idx === 2) return false; return true; };
            const isEditableText = (idx, side) => { if (idx === 1 && side === 'back') return false; return true; };

            /* MANEJADOR DE SUBIDA OPTIMIZADO PARA LIBRO */
            const handleBookImageUpload = async (e, pageIdx, side) => {
                const file = e.target.files[0];
                if (!file) return;
                if(!auth.currentUser) return alert("Debes iniciar sesión");
                
                const btn = e.target.parentElement;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
                
                try {
                    const path = `users/${auth.currentUser.uid}/uploads/${Date.now()}_${file.name}`;
                    const url = await uploadImageToStorage(file, path);
                    onUpdatePage(pageIdx, side, 'bg', url);
                } catch(error) {
                    alert("Error al subir imagen: " + error.message);
                } finally {
                    btn.innerHTML = originalText;
                }
            };

            const renderEditOverlay = (pageIdx, side, currentBg) => {
                if (!isEditor || !isEditableImage(pageIdx, side)) return null;
                return (
                    <div className="edit-overlay">
                        <div className="upload-card">
                            <label className="btn-modern bg-gradient-accent" style={{width:'100%', fontSize:'0.9rem', padding:'8px'}}>
                                <i className="fas fa-camera mr-2"></i> {currentBg ? 'Cambiar' : 'Subir'}
                                <input type="file" accept="image/*" className="hidden" onChange={(e) => handleBookImageUpload(e, pageIdx, side)} />
                            </label>
                            <input className="input-field-clean" placeholder="O pega enlace..." value={currentBg && currentBg.startsWith('http') ? currentBg : ''} onClick={(e) => e.stopPropagation()} onChange={(e) => onUpdatePage(pageIdx, side, 'bg', e.target.value)} style={{fontSize:'0.8rem', marginTop:'10px', padding:'8px'}} />
                            {currentBg && <button className="remove-btn" style={{marginTop:'10px', color:'#ef4444', fontWeight:'bold'}} onClick={(e) => { e.stopPropagation(); onUpdatePage(pageIdx, side, 'bg', ''); }}>ELIMINAR</button>}
                        </div>
                    </div>
                );
            };

            return (
                <div style={{width:'100%', height:'100%', display:'flex', justifyContent:'center', alignItems:'center', position:'relative'}}>
                    <audio ref={audioRef} src="https://raw.githubusercontent.com/libroalbum/libro-lbum-pedag-gico/main/images/sonido%20deslizar.mp3"></audio>
                    <div id="stage">
                        <div className={`book ${isOpen ? 'opened' : ''} ${isClosedBack ? 'closed-back' : ''}`}>
                            {pages.map((p, i) => {
                                const zIndex = currentIdx >= i ? i + 1 : pages.length - i;
                                return (
                                    <div key={p.id} className={`paper ${i <= currentIdx ? 'flipped' : ''}`} style={{zIndex}}>
                                        <div className={`front ${p.front.type}`} style={p.front.bg ? {backgroundImage:`url(${p.front.bg})`}:{}}>
                                            {renderEditOverlay(i, 'front', p.front.bg)}
                                            {p.front.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center relative z-10">
                                                    <input disabled={!isEditor || !isEditableTitle(i, 'front')} value={p.front.title} onChange={(e)=>onUpdatePage(i, 'front', 'title', e.target.value)} className="inline-input-title" />
                                                    <textarea disabled={!isEditor || !isEditableText(i, 'front')} value={p.front.text} onChange={(e)=>onUpdatePage(i, 'front', 'text', e.target.value)} className="inline-input-text" rows="6" />
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2}</span>}
                                        </div>
                                        <div className={`back ${p.back.type}`} style={p.back.bg ? {backgroundImage:`url(${p.back.bg})`}:{}}>
                                            {renderEditOverlay(i, 'back', p.back.bg)}
                                            {p.back.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center relative z-10">
                                                    <input disabled={!isEditor || !isEditableTitle(i, 'back')} value={p.back.title} onChange={(e)=>onUpdatePage(i, 'back', 'title', e.target.value)} className="inline-input-title" />
                                                    <textarea disabled={!isEditor || !isEditableText(i, 'back')} value={p.back.text} onChange={(e)=>onUpdatePage(i, 'back', 'text', e.target.value)} className="inline-input-text" rows="6" />
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2+1}</span>}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                    {currentIdx >= 0 && <button className="nav-btn prev-btn" onClick={() => changePage(currentIdx - 1)}><i className="fas fa-arrow-left"></i></button>}
                    {currentIdx < pages.length - 1 && <button className="nav-btn next-btn" onClick={() => changePage(currentIdx + 1)}><i className="fas fa-arrow-right"></i></button>}
                </div>
            );
        }

        function RegistrationBubble({ onClose }) {
            return (
                <div className="ped-unit-container">
                    <div className="ped-cloud">
                        <div onClick={onClose} className="absolute top-2 left-2 cursor-pointer text-gray-400 hover:text-red-500"><i className="fas fa-times"></i></div>
                        <h3>¡Hola, Creador!</h3>
                        <p>Estás viendo una vista previa pública.<br/> <a href="/" className="text-indigo-600 font-bold hover:underline">Regístrate gratis</a> para crear y guardar tus propias historias.</p>
                        <div className="mt-3">
                            <button onClick={()=>window.location.href=window.location.pathname} className="btn-modern bg-gradient-primary text-xs px-4 py-2 w-full shadow-md">
                                ¡CREAR MI CUENTA!
                            </button>
                        </div>
                    </div>
                    <img src="https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/personaje%20izquierda.png?raw=true" 
                         alt="Personaje Guía" 
                         className="ped-character" />
                </div>
            );
        }

        // --- VISOR PÚBLICO ---
        function PublicActivityViewer({ activity }) {
            const [zoom, setZoom] = useState(1);
            const [showGuide, setShowGuide] = useState(true);
            const handleZoomIn = () => setZoom(p => Math.min(p + 0.1, 1.5));
            const handleZoomOut = () => setZoom(p => Math.max(p - 0.1, 0.5));
            const resetZoom = () => setZoom(1);

            const getTitle = () => {
                const map = {
                    'guia': "Libro Guía", 'reference_book': "Libro Guía",
                    'moodboard': "Moodboard", 'storyboard': "Storyboard",
                    'quiz': "Quiz Time", 'ficha': "Ficha Personajes", 
                    'ficha_personajes': "Ficha Personajes", 'ficha_narrativa': "Ficha Narrativa",
                    'padlet': "Muro Colaborativo", 'muro': "Muro Colaborativo"
                };
                return map[activity] || "Actividad";
            };

            const renderContent = () => {
                const iframeStyle = { width: `${100/zoom}%`, height: `${100/zoom}%`, transform: `scale(${zoom})`, transformOrigin: '0 0', transition: '0.2s' };
                const wrapperClass = "flex-1 bg-white rounded-2xl overflow-hidden shadow-lg border border-gray-200 relative";

                if(activity === 'guia' || activity === 'reference_book') 
                    return <div className={wrapperClass}><iframe src="https://libroalbum.github.io/libro-lbum-pedag-gico/" className="w-full h-full border-none"></iframe></div>;
                
                if(activity === 'moodboard') 
                    return <div className={wrapperClass}><div style={iframeStyle}><iframe src="https://libroalbum.github.io/mooboard/" className="w-full h-full border-none"></iframe></div></div>;
                
                if(activity === 'storyboard') 
                    return <div className={wrapperClass}><div style={iframeStyle}><iframe src="https://libroalbum.github.io/tablero/" className="w-full h-full border-none"></iframe></div></div>;
                
                if(activity === 'padlet' || activity === 'muro') 
                    return <div className={wrapperClass}><div style={iframeStyle}><iframe src="https://padlet.com/embed/kz78sfkwdm9abosj" className="w-full h-full border-none" allow="camera;microphone;geolocation;display-capture"></iframe></div></div>;

                if(activity === 'quiz') return (
                    <div className="flex-1 bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden relative group">
                        <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/Kahoot-1.png?raw=true" className="w-full h-full object-cover blur-sm opacity-50"/>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <a href="https://create.kahoot.it/share/quiz-interactivo/f8f5983d-25e9-44e7-aa46-eab37837811f" target="_blank" className="btn-modern bg-gradient-primary text-xl px-10 py-4"><i className="fas fa-play mr-2"></i> INICIAR QUIZ</a>
                        </div>
                    </div>
                );

                if(activity === 'ficha' || activity === 'ficha_personajes') return (
                    <div className="flex-1 bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden relative group">
                        <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20de%20personajes.png?raw=true" className="w-full h-full object-contain"/>
                        <div className="absolute inset-0 bg-black/10 flex items-center justify-center">
                            <a href="https://docs.google.com/forms/d/e/1FAIpQLSdeATljdt5PMVoLzJ1x6S7sItasYY9hW2aiClLJpE1Yr1OyQw/viewform" target="_blank" className="btn-modern bg-gradient-primary text-xl px-10 py-4"><i className="fas fa-pen mr-2"></i> COMPLETAR</a>
                        </div>
                    </div>
                );

                if(activity === 'ficha_narrativa') return (
                    <div className="flex-1 bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden relative group">
                        <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20narrativa.jpg?raw=true" className="w-full h-full object-cover blur-sm opacity-50"/>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <a href="https://www.canva.com/design/DAG4JQ_26mk/yYHgZbuApHUSdalSG2938g/view" target="_blank" className="btn-modern bg-gradient-primary text-xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform decoration-none flex items-center gap-3" style={{textDecoration: 'none'}}><i className="fas fa-pen-nib"></i> RELLENAR LA FICHA</a>
                        </div>
                    </div>
                );

                return <div>404</div>;
            };

            return (
                <div className="h-screen w-full bg-gray-50 flex flex-col font-sans relative">
                    {showGuide && <RegistrationBubble onClose={() => setShowGuide(false)} />}
                    <div className="h-16 bg-white border-b shadow-sm sticky top-0 z-50 px-6 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="font-bold text-xl text-indigo-600 tracking-tight">CREATOR STUDIO</div>
                            <span className="text-gray-300">/</span>
                            <div className="font-semibold text-gray-600 uppercase tracking-widest text-sm">{getTitle()}</div>
                        </div>
                        <div className="flex items-center gap-3">
                            {['moodboard','storyboard','padlet','muro'].includes(activity) && (
                                <div className="flex bg-gray-100 rounded-lg p-1 mr-4">
                                    <button onClick={handleZoomOut} className="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-white rounded-md transition"><i className="fas fa-minus"></i></button>
                                    <button onClick={resetZoom} className="px-2 text-xs font-bold text-gray-500">{Math.round(zoom*100)}%</button>
                                    <button onClick={handleZoomIn} className="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-white rounded-md transition"><i className="fas fa-plus"></i></button>
                                </div>
                            )}
                            <button onClick={() => window.location.href = window.location.pathname} className="btn-modern bg-gradient-primary text-xs px-4 py-2">REGISTRARME</button>
                        </div>
                    </div>
                    <div className="flex-1 p-6 overflow-hidden flex flex-col relative">
                        {renderContent()}
                    </div>
                </div>
            );
        }

        // --- EDITOR COMPONENT ---
        function Editor({ user, setView }) {
            const [book, setBook] = useState(null);
            const [activeIdx, setActiveIdx] = useState(-1); 
            
            useEffect(() => { 
                const bid = localStorage.getItem('currentBookId'); 
                if(!bid || !db) return; 
                getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', bid)).then(snap => { 
                    if(snap.exists()) setBook({id: snap.id, ...snap.data()}); 
                }); 
            }, []);

            const save = async () => { 
                try { 
                    await updateDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', book.id), { pages: book.pages, title: book.title }); 
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), { 
                        featuredBookId: book.id,
                        publishedBook: { 
                            title: book.title,
                            pages: book.pages
                        }
                    }, { merge: true });
                    alert("¡GUARDADO Y PUBLICADO CORRECTAMENTE!"); 
                } catch (e) { alert("Error: " + e.message); } 
            };

            const resetBook = async () => {
                if(!confirm("¿Estás seguro de reiniciar el libro? Se perderán todos los cambios actuales.")) return;
                const resetState = { ...MASTER_TEMPLATE, createdAt: new Date().toISOString() }; 
                setBook({ id: book.id, ...resetState }); 
                try {
                    await updateDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', book.id), resetState);
                    alert("¡Libro reiniciado a la plantilla original!");
                } catch(e) {
                    alert("Error al reiniciar: " + e.message);
                }
            };

            const handlePageUpdate = (idx, side, field, val) => { 
                const newPages = [...book.pages]; 
                newPages[idx][side][field] = val; 
                setBook({...book, pages: newPages}); 
            };

            const addPage = () => { 
                const np = [...book.pages]; 
                const bodyImg = 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20cuerpo.png?raw=true';
                np.splice(np.length-1, 0, { 
                    id: Date.now(), 
                    type: 'content', 
                    front: { type: 'image-page', bg: bodyImg }, 
                    back: { type: 'image-page', bg: bodyImg } 
                }); 
                setBook({...book, pages: np}); 
            };

            if(!book) return <div className="flex h-full items-center justify-center text-white">Cargando Libro...</div>;

            return (
                <div className="flex h-full w-full relative overflow-hidden">
                    <div className="sidebar-editor">
                        <div className="icon-chunk" onClick={()=>setView('dashboard')} title="Volver"><i className="fas fa-arrow-left"></i></div>
                        <div className="icon-chunk" onClick={save} title="Guardar"><i className="fas fa-save text-green-400"></i></div>
                        <div className="icon-chunk" onClick={resetBook} title="Reiniciar Libro"><i className="fas fa-undo-alt text-red-400"></i></div>
                        <div className="mt-auto"><div className="icon-chunk" onClick={addPage} title="Agregar Página"><i className="fas fa-plus text-blue-400"></i></div></div>
                    </div>
                    <div className="canvas-grid editor-mode">
                        <BookViewer pages={book.pages} activeIdx={activeIdx} setActiveIdx={setActiveIdx} isEditor={true} onUpdatePage={handlePageUpdate} />
                    </div>
                </div>
            );
        }

        // --- PUBLIC GALLERY COMPONENT ---
        function PublicGallery({ uid }) {
            const [portfolio, setPortfolio] = useState({});
            const [book, setBook] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState({ name: 'Creador' });
            const [showGuide, setShowGuide] = useState(true); 

            useEffect(() => {
                if(!db) return;
                const load = async () => {
                    const docSnap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', uid));
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        setPortfolio(data);
                        if (data.publishedBook) {
                            setBook(data.publishedBook);
                        } else if (data.featuredBookId) {
                            try {
                                const bookSnap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', uid, 'books', data.featuredBookId));
                                if(bookSnap.exists()) setBook({id: bookSnap.id, ...bookSnap.data()});
                            } catch(err) { console.log("No se pudo cargar libro privado", err); }
                        }
                    }
                    const profileSnap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', uid, 'profile', 'user_info'));
                    if(profileSnap.exists()) setUserProfile(profileSnap.data());
                    setLoading(false);
                }; 
                load();
            }, [uid]);

            if(loading) return <div className="flex h-screen items-center justify-center text-indigo-500 font-bold">Cargando Portafolio...</div>;

            return (
                <div className="h-full overflow-y-auto bg-gray-50 relative">
                    {showGuide && <RegistrationBubble onClose={() => setShowGuide(false)} />}
                    <div className="bg-white border-b shadow-sm sticky top-0 z-50 px-8 py-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-black text-gray-800 font-dosis">PORTAFOLIO</h1>
                            <p className="text-gray-500 text-sm">De: {userProfile.name}</p>
                        </div>
                        <button onClick={()=>window.location.href=window.location.pathname} className="btn-modern bg-gradient-primary text-xs px-4">CREAR MI CUENTA</button>
                    </div>

                    <div className="max-w-6xl mx-auto p-8">
                        <div className="bg-white rounded-3xl p-8 border border-gray-100 shadow-lg mb-8 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-20 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                            <div className="relative z-10">
                                <div className="w-full h-[500px] relative z-10">
                                    {book ? <div className="transform scale-90 origin-top h-full"><BookViewer pages={book.pages} activeIdx={-1} setActiveIdx={()=>{}} isEditor={false} /></div> : <div className="text-center text-gray-400 mt-20">Este creador aún no ha publicado su libro.</div>}
                                </div>
                            </div>
                        </div>

                        <h3 className="text-xl font-bold text-gray-400 uppercase tracking-widest mb-6">Galería de Evidencias</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="bg-white rounded-3xl p-6 border border-gray-200 shadow-md">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 bg-purple-100 text-purple-600 rounded-lg"><i className="fas fa-palette"></i></div>
                                    <h4 className="font-bold text-gray-700">Moodboard</h4>
                                </div>
                                <div className="aspect-video bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center">
                                    {portfolio.moodboard ? <img src={portfolio.moodboard} className="w-full h-full object-cover" /> : <span className="text-gray-400 text-sm">Sin evidencia</span>}
                                </div>
                            </div>
                            <div className="bg-white rounded-3xl p-6 border border-gray-200 shadow-md">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 bg-orange-100 text-orange-600 rounded-lg"><i className="fas fa-film"></i></div>
                                    <h4 className="font-bold text-gray-700">Storyboard</h4>
                                </div>
                                <div className="aspect-video bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center">
                                    {portfolio.storyboard ? <img src={portfolio.storyboard} className="w-full h-full object-cover" /> : <span className="text-gray-400 text-sm">Sin evidencia</span>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- LOGIN SCREEN ---
        function LoginScreen({ setUser }) {
            const [email, setEmail] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [isRegister, setIsRegister] = useState(false);
            const [isReset, setIsReset] = useState(false);

            const handleAuth = async (e) => { 
                e.preventDefault(); 
                try { 
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password); 
                    else await signInWithEmailAndPassword(auth, email, password); 
                } catch (err) { alert(err.message); } 
            };

            const handleGoogleLogin = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    alert(error.message);
                }
            };

            const handleReset = async (e) => {
                e.preventDefault();
                if (!email) return alert("Escribe tu correo.");
                try { await sendPasswordResetEmail(auth, email); alert("Revisa tu correo."); setIsReset(false); } catch (err) { alert(err.message); }
            };

            return (
                <div className="login-split-wrapper">
                    <div className="login-visual-side">
                        <div className="visual-overlay">
                            <h2 className="text-4xl font-bold font-dosis mb-2">Tu Imaginación no tiene límites</h2>
                            <p className="text-lg opacity-90 font-outfit">Crea, diseña y comparte tus historias con el mundo.</p>
                        </div>
                    </div>
                    <div className="login-form-side">
                        <div className="w-full max-w-md">
                            <h1 className="login-brand-title">CREATOR STUDIO</h1>
                            <p className="login-description">La plataforma definitiva para crear tu Libro Álbum Digital.<br/>Empieza tu aventura creativa ahora.</p>
                            <div className="features-mini">
                                <div className="feature-pill"><i className="fas fa-magic"></i> Edición Fácil</div>
                                <div className="feature-pill"><i className="fas fa-palette"></i> Arte & Color</div>
                                <div className="feature-pill"><i className="fas fa-share-alt"></i> Compartir</div>
                            </div>
                            <div className="login-box">
                                {isReset ? (
                                    <form onSubmit={handleReset} className="space-y-4">
                                        <input className="input-field-clean" placeholder="Tu correo para recuperar" value={email} onChange={e=>setEmail(e.target.value)} />
                                        <button className="btn-modern bg-gradient-primary w-full py-3 text-lg">Enviar Enlace</button>
                                        <div onClick={()=>setIsReset(false)} className="text-center text-gray-500 text-sm cursor-pointer hover:text-indigo-500 mt-4 font-bold">Cancelar</div>
                                    </form>
                                ) : (
                                    <form onSubmit={handleAuth} className="space-y-4">
                                        <div className="relative">
                                            <i className="fas fa-envelope absolute left-4 top-4 text-gray-400"></i>
                                            <input className="input-field-clean" placeholder="Correo electrónico" value={email} onChange={e=>setEmail(e.target.value)} />
                                        </div>
                                        <div className="relative">
                                            <i className="fas fa-lock absolute left-4 top-4 text-gray-400"></i>
                                            <input className="input-field-clean" type="password" placeholder="Contraseña" value={password} onChange={e=>setPassword(e.target.value)} />
                                        </div>
                                        <div className="text-right"><span className="text-xs text-indigo-500 font-bold cursor-pointer hover:underline" onClick={()=>setIsReset(true)}>¿Olvidaste tu contraseña?</span></div>
                                        <button className="btn-modern bg-gradient-primary w-full py-3 text-lg shadow-lg mt-2">{isRegister ? 'Crear Cuenta Gratis' : 'Ingresar al Estudio'}</button>
                                        
                                        <div className="relative flex py-2 items-center">
                                            <div className="flex-grow border-t border-gray-200"></div>
                                            <span className="flex-shrink-0 mx-4 text-gray-400 text-xs">O continúa con</span>
                                            <div className="flex-grow border-t border-gray-200"></div>
                                        </div>
                                        <button type="button" onClick={handleGoogleLogin} className="btn-modern bg-white text-gray-700 w-full py-3 text-lg border border-gray-200 hover:bg-gray-50">
                                            <i className="fab fa-google text-red-500"></i> Google
                                        </button>

                                        <div className="mt-6 text-center"><span className="text-sm text-indigo-600 cursor-pointer hover:text-indigo-800 font-bold border-b-2 border-indigo-100 hover:border-indigo-600 transition" onClick={()=>setIsRegister(!isRegister)}>{isRegister ? '¿Ya tienes cuenta? Inicia Sesión' : '¿Eres nuevo? Regístrate aquí'}</span></div>
                                    </form>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD ---
        function Dashboard({ user, setView }) {
            const [activeSection, setActiveSection] = useState('inicio');
            const [books, setBooks] = useState([]);
            const [portfolioData, setPortfolioData] = useState({});
            const [userProfile, setUserProfile] = useState({ name: user.email ? user.email.split('@')[0] : 'Creador', photo: user.photoURL || '' });
            const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
            const [zoom, setZoom] = useState(1);

            useEffect(() => { 
                if(!user) return; 
                const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books')); 
                onSnapshot(q, (snap) => setBooks(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), (doc) => { if(doc.exists()) setPortfolioData(doc.data()); });
                onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'profile', 'user_info'), (doc) => { 
                    if(doc.exists()) setUserProfile(doc.data()); 
                    else if(user.displayName || user.photoURL) {
                        setUserProfile({ name: user.displayName || 'Creador', photo: user.photoURL || '' });
                    }
                });
            }, [user]);

            const saveProfile = async () => {
                await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'profile', 'user_info'), userProfile, { merge: true });
                setIsProfileModalOpen(false);
            };

            const handleProfilePic = async (e) => {
                const file = e.target.files[0];
                if(file) {
                    try {
                        const path = `users/${user.uid}/profile/avatar_${Date.now()}`;
                        const url = await uploadImageToStorage(file, path);
                        setUserProfile({...userProfile, photo: url});
                    } catch (error) { alert("Error al subir perfil: " + error.message); }
                }
            };

            const handleMyBook = async () => {
                if (books.length > 0) {
                    localStorage.setItem('currentBookId', books[0].id);
                    setView('editor');
                } else {
                    const ref = await addDoc(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books'), { ...MASTER_TEMPLATE, createdAt: new Date().toISOString() });
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), { featuredBookId: ref.id }, { merge: true });
                    localStorage.setItem('currentBookId', ref.id);
                    setView('editor');
                }
            };

            const uploadEvidence = async (type, e) => {
                const file = e.target.files[0]; if(!file) return;
                const container = e.target.parentElement;
                const overlay = container.querySelector('.absolute.inset-0');
                if(overlay) overlay.innerHTML = '<i class="fas fa-spinner fa-spin text-white text-3xl"></i>';

                try {
                    const path = `users/${user.uid}/portfolio/${type}_${Date.now()}`;
                    const url = await uploadImageToStorage(file, path);
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), { [type]: url }, { merge: true });
                    alert("¡Imagen subida correctamente!");
                } catch(err) {
                    alert("Error: " + err.message);
                } finally {
                    if(overlay) overlay.innerHTML = '<i class="fas fa-upload text-white text-3xl"></i>';
                }
            };

            const getSectionTitle = () => {
                const titles = {
                    'inicio': 'Mi Estudio',
                    'portafolio': 'Mi Portafolio',
                    'reference_book': 'Libro Guía',
                    'moodboard': 'Moodboard',
                    'ficha_personajes': 'Personajes',
                    'storyboard': 'Storyboard',
                    'ficha_narrativa': 'Ficha Narrativa',
                    'padlet': 'Muro Social',
                    'quiz': 'Quiz Time'
                };
                return titles[activeSection] || 'Creator Studio';
            };

            const renderActivityContent = () => {
                const frameStyle = { width: `${100/zoom}%`, height: `${100/zoom}%`, transform: `scale(${zoom})`, transformOrigin: '0 0' };
                const containerClass = "flex-1 bg-white rounded-3xl overflow-hidden shadow-sm border-4 relative h-full"; 

                switch(activeSection) {
                    case 'inicio':
                        return (
                            <div className="animate-fade-in h-full overflow-y-auto">
                                <div className="glass-panel p-8 mb-8 flex flex-col md:flex-row gap-8 items-center">
                                    <div className="flex-1">
                                        <h2 className="text-3xl font-bold mb-4 text-gray-800">Bienvenido al Estudio, {userProfile.name}</h2>
                                        <p className="text-gray-600 mb-6 text-lg leading-relaxed">Este es tu espacio creativo profesional. Aquí tienes todas las herramientas para construir, diseñar y publicar tu propio Libro Álbum Digital.<br/><br/>Empieza revisando el video introductorio o salta directo a una misión.</p>
                                        <button onClick={handleMyBook} className="btn-modern bg-gradient-primary text-lg px-8 py-3"><i className="fas fa-rocket mr-2"></i> {books.length > 0 ? 'Continuar mi Libro' : 'Crear Nuevo Libro'}</button>
                                    </div>
                                    <div className="w-full md:w-1/2 aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-white transform rotate-1 hover:rotate-0 transition duration-500">
                                        <iframe className="w-full h-full" src="https://www.youtube.com/embed/Ex037JX3-BI?si=rZx7OSizIczac_-8" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                                    </div>
                                </div>
                                <h3 className="text-xl font-bold text-gray-400 uppercase tracking-widest mb-4">Acceso Rápido a Misiones</h3>
                                <div className="bento-grid">
                                    <div className="activity-card" style={{'--card-color': '#8b5cf6'}} onClick={()=>setActiveSection('moodboard')}><div><div className="ac-icon"><i className="fas fa-palette"></i></div><div className="ac-title">Moodboard</div><div className="ac-desc">Define el estilo visual.</div></div><div className="ac-arrow"><i className="fas fa-arrow-right"></i></div></div>
                                    <div className="activity-card" style={{'--card-color': '#ec4899'}} onClick={()=>setActiveSection('ficha_personajes')}><div><div className="ac-icon"><i className="fas fa-users"></i></div><div className="ac-title">Personajes</div><div className="ac-desc">Crea a tus protagonistas.</div></div><div className="ac-arrow"><i className="fas fa-arrow-right"></i></div></div>
                                    <div className="activity-card" style={{'--card-color': '#f97316'}} onClick={()=>setActiveSection('storyboard')}><div><div className="ac-icon"><i className="fas fa-film"></i></div><div className="ac-title">Storyboard</div><div className="ac-desc">Planea escena por escena.</div></div><div className="ac-arrow"><i className="fas fa-arrow-right"></i></div></div>
                                    <div className="activity-card" style={{'--card-color': '#06b6d4'}} onClick={()=>setActiveSection('padlet')}><div><div className="ac-icon"><i className="fas fa-comments"></i></div><div className="ac-title">Muro Social</div><div className="ac-desc">Comparte con la clase.</div></div><div className="ac-arrow"><i className="fas fa-arrow-right"></i></div></div>
                                </div>
                            </div>
                        );
                    
                    case 'portafolio':
                        return (
                            <div className="h-full flex flex-col">
                                <div className="flex-1 overflow-y-auto pr-2">
                                    <div className="bg-white rounded-3xl p-8 border border-gray-100 shadow-sm mb-8 text-center relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                                        <div className="relative z-10">
                                            <div className="w-full max-w-4xl mx-auto h-[500px] mt-8 relative">
                                                {books.length > 0 ? (<div className="transform scale-90 origin-top h-full"><BookViewer pages={books[0].pages} activeIdx={-1} setActiveIdx={()=>{}} isEditor={false} /></div>) : <div className="h-full flex items-center justify-center text-gray-400">No has creado tu libro aún.</div>}
                                            </div>
                                        </div>
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-400 uppercase tracking-widest mb-4">Evidencias del Proceso</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
                                            <div className="bg-white rounded-2xl p-4 border border-gray-200 relative group cursor-pointer overflow-hidden h-80" onClick={()=>document.getElementById('upl-mood').click()}>
                                                <div className="absolute top-4 left-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-full text-xs font-bold z-10">MOODBOARD</div>
                                                {portfolioData.moodboard ? <img src={portfolioData.moodboard} className="w-full h-full object-cover rounded-xl"/> : <div className="w-full h-full flex items-center justify-center text-gray-300 font-bold">SUBIR IMAGEN</div>}
                                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i className="fas fa-upload text-white text-3xl"></i></div>
                                                <input type="file" id="upl-mood" className="hidden" onChange={(e)=>uploadEvidence('moodboard', e)}/>
                                            </div>
                                            <div className="bg-white rounded-2xl p-4 border border-gray-200 relative group cursor-pointer overflow-hidden h-80" onClick={()=>document.getElementById('upl-story').click()}>
                                                <div className="absolute top-4 left-4 bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold z-10">STORYBOARD</div>
                                                {portfolioData.storyboard ? <img src={portfolioData.storyboard} className="w-full h-full object-cover rounded-xl"/> : <div className="w-full h-full flex items-center justify-center text-gray-300 font-bold">SUBIR IMAGEN</div>}
                                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i className="fas fa-upload text-white text-3xl"></i></div>
                                                <input type="file" id="upl-story" className="hidden" onChange={(e)=>uploadEvidence('storyboard', e)}/>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'reference_book':
                        return <div className="h-full flex flex-col"><div className={containerClass}><iframe src="https://libroalbum.github.io/libro-lbum-pedag-gico/" className="w-full h-full border-none"></iframe></div></div>;
                    
                    case 'moodboard':
                        return (
                            <div className="h-full flex flex-col">
                                <div className="flex-1 rounded-3xl overflow-hidden shadow-sm border-4 border-white relative h-full">
                                    <MoodboardComponent user={user} />
                                </div>
                            </div>
                        );
                    
                    case 'storyboard':
                        return (
                            <div className="h-full flex flex-col">
                                <div className="flex-1 rounded-3xl overflow-hidden shadow-sm border-4 border-white relative h-full">
                                    <StoryboardComponent user={user} />
                                </div>
                            </div>
                        );
                    
                    case 'padlet':
                        return <div className="h-full flex flex-col"><div className={containerClass}><div style={frameStyle}><iframe src="https://padlet.com/embed/kz78sfkwdm9abosj" className="w-full h-full border-none" allow="camera;microphone;geolocation;display-capture"></iframe></div></div></div>;

                    case 'quiz':
                        return (
                            <div className="h-full flex flex-col">
                                <div className={`${containerClass} border-indigo-100 group`}>
                                    <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/Kahoot-1.png?raw=true" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                        <a href="https://create.kahoot.it/share/quiz-interactivo/f8f5983d-25e9-44e7-aa46-eab37837811f" target="_blank" className="btn-modern bg-gradient-primary text-2xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform" style={{textDecoration: 'none'}}><i className="fas fa-play-circle mr-3"></i> HACER QUIZ</a>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'ficha_narrativa':
                        return (
                            <div className="h-full flex flex-col">
                                <div className={`${containerClass} border-indigo-100 group`}>
                                    <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20narrativa.jpg?raw=true" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <a href="https://www.canva.com/design/DAG4JQ_26mk/yYHgZbuApHUSdalSG2938g/view" target="_blank" className="btn-modern bg-gradient-primary text-xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform decoration-none flex items-center gap-3" style={{textDecoration: 'none'}}><i className="fas fa-pen-nib"></i> RELLENAR LA FICHA</a>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'ficha_personajes':
                        return (
                            <div className="h-full flex flex-col">
                                <div className={`${containerClass} border-indigo-100 group`}>
                                    <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20de%20personajes.png?raw=true" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSdeATljdt5PMVoLzJ1x6S7sItasYY9hW2aiClLJpE1Yr1OyQw/viewform" target="_blank" className="btn-modern bg-gradient-primary text-2xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform" style={{textDecoration: 'none'}}><i className="fas fa-edit mr-3"></i> COMPLETAR FORMULARIO</a>
                                    </div>
                                </div>
                            </div>
                        );

                    default: return <div>Selecciona una opción</div>;
                }
            };

            return (
                <div className="flex flex-col h-full overflow-hidden bg-white">
                    {isProfileModalOpen && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-2xl font-bold text-gray-800 mb-6">EDITAR PERFIL</h3>
                                <div className="flex flex-col items-center gap-6">
                                    <div className="relative group cursor-pointer w-32 h-32">
                                        {userProfile.photo ? <img src={userProfile.photo} className="w-full h-full rounded-full object-cover border-4 border-indigo-100"/> : <div className="w-full h-full rounded-full bg-indigo-50 flex items-center justify-center text-4xl text-indigo-300"><i className="fas fa-user"></i></div>}
                                        <div className="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i className="fas fa-camera text-white"></i></div>
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleProfilePic}/>
                                    </div>
                                    <input className="input-field-clean text-center text-xl" value={userProfile.name} onChange={(e)=>setUserProfile({...userProfile, name: e.target.value})} placeholder="Tu Nombre Artístico"/>
                                    <div className="flex gap-3 w-full">
                                        <button className="btn-modern bg-gradient-success flex-1" onClick={saveProfile}>GUARDAR</button>
                                        <button className="btn-modern bg-gray-400" onClick={()=>setIsProfileModalOpen(false)}>CANCELAR</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="classroom-container">
                        <div className="classroom-sidebar">
                            <div className="sidebar-logo">CREATOR STUDIO</div>
                            <div className="section-label">MI ESTUDIO</div>
                            <div className={`menu-item ${activeSection==='inicio'?'active':''}`} onClick={()=>setActiveSection('inicio')}><i className="fas fa-home"></i> Inicio</div>
                            <div className="menu-item" onClick={handleMyBook}><i className="fas fa-book-open"></i> Mi Libro</div>
                            <div className={`menu-item ${activeSection==='portafolio'?'active':''}`} onClick={()=>setActiveSection('portafolio')}><i className="fas fa-briefcase"></i> Portafolio</div>
                            <div className={`menu-item ${activeSection==='reference_book'?'active':''}`} onClick={()=>setActiveSection('reference_book')}><i className="fas fa-book"></i> Libro Guía</div>
                            <div className="section-label">LABORATORIO CREATIVO</div>
                            <div className={`menu-item ${activeSection==='moodboard'?'active':''}`} onClick={()=>setActiveSection('moodboard')}><i className="fas fa-palette text-purple-500"></i> Moodboard</div>
                            <div className={`menu-item ${activeSection==='ficha_personajes'?'active':''}`} onClick={()=>setActiveSection('ficha_personajes')}><i className="fas fa-user-tag text-pink-500"></i> Personajes</div>
                            <div className={`menu-item ${activeSection==='storyboard'?'active':''}`} onClick={()=>setActiveSection('storyboard')}><i className="fas fa-layer-group text-orange-500"></i> Storyboard</div>
                            <div className={`menu-item ${activeSection==='ficha_narrativa'?'active':''}`} onClick={()=>setActiveSection('ficha_narrativa')}><i className="fas fa-feather-alt text-rose-500"></i> Ficha Narrativa</div>
                            <div className={`menu-item ${activeSection==='padlet'?'active':''}`} onClick={()=>setActiveSection('padlet')}><i className="fas fa-comments text-cyan-500"></i> Muro Social</div>
                            <div className={`menu-item ${activeSection==='quiz'?'active':''}`} onClick={()=>setActiveSection('quiz')}><i className="fas fa-puzzle-piece text-yellow-500"></i> Quiz Time</div>
                        </div>
                        <div className="classroom-content">
                            <div className="top-bar-glass">
                                <div className="flex items-center gap-4">
                                     <h2 className="page-header-title text-indigo-600">{getSectionTitle()}</h2>
                                     {['moodboard', 'storyboard', 'padlet'].includes(activeSection) && (
                                         <div className="flex items-center gap-2 bg-white rounded-full px-3 py-1 border border-gray-200 shadow-sm ml-4">
                                             <button onClick={()=>setZoom(z=>Math.max(0.5, z-0.1))} className="text-gray-500 hover:text-indigo-600"><i className="fas fa-minus"></i></button>
                                             <span className="text-xs font-bold w-8 text-center">{Math.round(zoom*100)}%</span>
                                             <button onClick={()=>setZoom(z=>Math.min(1.5, z+0.1))} className="text-gray-500 hover:text-indigo-600"><i className="fas fa-plus"></i></button>
                                         </div>
                                     )}
                                     {activeSection === 'portafolio' && (
                                         <div className="flex gap-2 ml-4">
                                             <button onClick={() => window.open(`${window.location.origin}${window.location.pathname}?portfolio=${user.uid}`, '_blank')} className="btn-modern bg-white text-indigo-600 border border-indigo-100 text-xs shadow-sm py-1 px-3">
                                                 <i className="fas fa-eye mr-2"></i> VER
                                             </button>
                                             <button onClick={()=>{navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?portfolio=${user.uid}`); alert("Link copiado")}} className="btn-modern bg-gradient-dark text-xs py-1 px-3">
                                                 <i className="fas fa-share-alt mr-2"></i> LINK
                                             </button>
                                         </div>
                                     )}
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="user-chip" onClick={()=>setIsProfileModalOpen(true)}>
                                        <div className="user-info"><span className="user-name">{userProfile.name}</span><span className="user-role">CREATOR</span></div>
                                        {userProfile.photo ? <img src={userProfile.photo} className="user-avatar"/> : <div className="user-avatar flex items-center justify-center bg-gray-100 text-gray-400 font-bold">{userProfile.name.charAt(0)}</div>}
                                    </div>
                                    <button onClick={()=>signOut(auth)} className="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition shadow-sm"><i className="fas fa-power-off"></i></button>
                                </div>
                            </div>
                            <div className="flex-1 relative overflow-hidden h-full flex flex-col">
                                {renderActivityContent()}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('loading'); 
            const [portfolioUid, setPortfolioUid] = useState(null);
            const [publicActivity, setPublicActivity] = useState(null);
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const pUid = params.get('portfolio');
                const activityParam = params.get('activity'); 
                if (pUid) { setPortfolioUid(pUid); setView('public-view'); } 
                else if (activityParam) { setPublicActivity(activityParam); setView('public-activity'); } 
                else { if (auth) { onAuthStateChanged(auth, (u) => { setUser(u); setView(u ? 'dashboard' : 'login'); }); } }
            }, []);
            if (view === 'public-view') return <PublicGallery uid={portfolioUid} />;
            if (view === 'public-activity') return <PublicActivityViewer activity={publicActivity} />;
            if (view === 'loading') return <div className="flex h-screen items-center justify-center font-bold text-xl text-indigo-500 font-outfit animate-pulse">CARGANDO STUDIO...</div>;
            return (
                <div className="flex flex-col h-full font-sans">
                    <main className="flex-1 relative overflow-hidden">
                        {view === 'login' && <LoginScreen setUser={setUser} setView={setView} />}
                        {view === 'dashboard' && <Dashboard user={user} setView={setView} />}
                        {view === 'editor' && <Editor user={user} setView={setView} />}
                        {view === 'external' && (
                            <div className="w-full h-full bg-white relative flex flex-col">
                                <div className="h-14 bg-gray-900 flex items-center justify-between px-6 shadow-lg z-50"><span className="text-white font-bold font-outfit">Herramienta Externa</span><button onClick={() => setView('dashboard')} className="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded-full font-bold text-sm transition">CERRAR</button></div>
                                <iframe src={user.toolUrl} style={{width:'100%', height:'100%', border:'none'}}></iframe>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
