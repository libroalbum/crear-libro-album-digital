<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Studio Pop - Aula Virtual</title>
    
    <!-- LIBRERÍAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@600;800&family=Nunito:wght@400;600;700&family=Cinzel:wght@700&family=Merriweather&family=Luckiest+Guy&display=swap" rel="stylesheet">

    <!-- REACT -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- 1. PALETA "ELECTRIC PASTELS" --- */
        :root {
            --bg-ice: #F8FAFC; 
            --text-main: #334155;
            --header-blue: #00C6FF; 
            
            /* Acentos */
            --hyper-grape: #8B5CF6;
            --lime-punch: #84CC16;
            --electric-cyan: #06B6D4;
            --hot-orange: #F97316;
            --pop-pink: #EC4899;
            
            /* Sombras */
            --shadow-grape: #6D28D9;
            --shadow-lime: #4D7C0F;
            --shadow-cyan: #0097bd;
            --shadow-orange: #C2410C;
            --shadow-pink: #BE185D;

            --canvas-dark: #1e293b;

            /* Variables Libro */
            --book-width: 460px; --book-height: 600px; --paper-texture: #fdfbf7; --text-color: #2c3e50; --accent-color: #5d4037; --gold-color: #d4af37; --endpaper-bg: #a5d6a7; --endpaper-dot: #ffffff; 
        }

        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Nunito', sans-serif; color: var(--text-main); background-color: var(--bg-ice); background-image: radial-gradient(#E2E8F0 1px, transparent 1px); background-size: 20px 20px; }
        
        h1, h2, h3, .pop-title { font-family: 'Dosis', sans-serif; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .kids-title { font-family: 'Luckiest Guy', cursive; letter-spacing: 1px; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); font-size: 2rem; }

        /* --- UI COMPONENTS --- */
        .glass-panel { background: white; border: 3px solid white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.2s; }
        
        /* Botones Gummy */
        .btn-gummy { border: none; outline: none; cursor: pointer; font-family: 'Dosis', sans-serif; font-weight: 800; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: 15px; color: white; text-transform: uppercase; transition: transform 0.1s; position: relative; top: 0; }
        .btn-gummy:active { top: 4px; box-shadow: none !important; }
        .btn-gummy:hover { filter: brightness(1.05); }
        
        .btn-grape { background: var(--hyper-grape); box-shadow: 0 4px 0 #6D28D9; }
        .btn-lime { background: var(--lime-punch); box-shadow: 0 4px 0 #4D7C0F; }
        .btn-cyan { background: var(--electric-cyan); box-shadow: 0 4px 0 #0097bd; }
        .btn-orange { background: var(--hot-orange); box-shadow: 0 4px 0 #C2410C; }
        .btn-pink { background: var(--pop-pink); box-shadow: 0 4px 0 #BE185D; }
        .btn-indigo { background: #6366f1; box-shadow: 0 4px 0 #4338ca; }

        /* --- LOGIN STYLES (CLEAN BLUE) --- */
        .login-page-bg {
            background-color: #e0f2fe;
            background-image: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.4) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.4) 0%, transparent 20%);
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;
        }
        .shape-blob-1 { position: absolute; top: -10%; right: -5%; width: 400px; height: 400px; background: rgba(3, 169, 244, 0.05); border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; transform: rotate(45deg); }
        .shape-blob-2 { position: absolute; bottom: -10%; left: -10%; width: 500px; height: 500px; background: rgba(3, 169, 244, 0.05); border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }

        .login-card-clean { background: white; border-radius: 24px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08); padding: 40px; width: 100%; max-width: 400px; text-align: center; position: relative; z-index: 10; }
        .login-title-clean { font-family: 'Luckiest Guy', cursive; color: #0ea5e9; font-size: 2.8rem; line-height: 1; margin-bottom: 30px; text-transform: uppercase; text-shadow: 2px 2px 0px rgba(0,0,0,0.05); }
        .input-group-clean { position: relative; margin-bottom: 15px; }
        .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 1rem; }
        .input-field-clean { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: 'Nunito', sans-serif; font-size: 0.95rem; color: #475569; outline: none; transition: border-color 0.2s; background: white; }
        .input-field-clean:focus { border-color: #0ea5e9; }
        .input-field-clean::placeholder { color: #cbd5e1; }
        .btn-login-clean { background-color: #0284c7; color: white; font-family: 'Nunito', sans-serif; font-weight: 700; font-size: 1rem; padding: 12px; width: 100%; border-radius: 50px; border: none; cursor: pointer; margin-top: 10px; transition: background-color 0.2s; box-shadow: 0 4px 6px -1px rgba(2, 132, 199, 0.3); }
        .btn-login-clean:hover { background-color: #0369a1; }
        .link-text { display: block; margin-top: 15px; font-size: 0.85rem; color: #64748b; cursor: pointer; font-family: 'Nunito', sans-serif; font-weight: 600; }
        .link-text:hover { color: #0ea5e9; }
        .register-link { color: #94a3b8; margin-top: 5px; }

        /* --- LAYOUT CLASSROOM --- */
        .classroom-container { display: flex; height: 100%; width: 100%; }
        .classroom-sidebar { width: 260px; background: white; border-right: 2px solid #E2E8F0; display: flex; flex-direction: column; padding: 20px; z-index: 50; flex-shrink: 0; overflow-y: auto; }
        .sidebar-logo { font-family: 'Luckiest Guy'; font-size: 1.5rem; color: var(--electric-cyan); margin-bottom: 30px; text-align: center; text-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
        .menu-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; font-weight: 600; color: #64748b; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-family: 'Nunito', sans-serif; font-size: 1rem; text-transform: none; }
        .menu-text { text-transform: capitalize; }
        .menu-item:hover { background: #F1F5F9; color: var(--electric-cyan); }
        .menu-item.active { background: #E0F2FE; color: var(--electric-cyan); box-shadow: inset 4px 0 0 var(--electric-cyan); }
        .menu-item i { width: 24px; text-align: center; font-size: 1.2rem; flex-shrink: 0; }

        .classroom-content { flex: 1; background: var(--bg-ice); overflow-y: auto; padding: 20px 40px; position: relative; }
        .module-header { margin-bottom: 30px; border-bottom: 3px solid #E2E8F0; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .module-title { font-size: 2rem; color: var(--text-main); font-family: 'Luckiest Guy'; }

        .summary-card { background: white; padding: 20px; border-radius: 20px; border-bottom: 4px solid #E2E8F0; display: flex; align-items: center; gap: 20px; }
        .summary-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: white; }

        .input-pop { background: white; border: 3px solid #E2E8F0; border-radius: 15px; padding: 12px 15px; width: 100%; font-family: 'Nunito', font-weight: 700; color: #475569; outline: none; }
        .input-pop:focus { border-color: var(--electric-cyan); }

        /* --- TOP BAR PROFILE --- */
        .top-bar { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 15px; }
        .user-chip { display: flex; align-items: center; gap: 12px; background: white; padding: 6px 8px 6px 15px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 2px solid white; cursor: pointer; transition: 0.2s; }
        .user-chip:hover { transform: translateY(-2px); border-color: var(--electric-cyan); }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #e2e8f0; border: 2px solid var(--electric-cyan); }
        .user-info { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; }
        .user-name { font-weight: 800; font-size: 0.95rem; color: var(--text-main); font-family: 'Dosis'; text-transform: uppercase; }
        .user-role { font-size: 0.7rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .logout-btn-top { background: #fee2e2; color: #ef4444; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; border: 2px solid #fecaca; box-shadow: 0 4px 0 #f87171; }
        .logout-btn-top:active { box-shadow: none; transform: translateY(4px); }
        .logout-btn-top:hover { background: #ef4444; color: white; border-color: #ef4444; }

        /* MODAL PERFIL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 4px solid var(--electric-cyan); text-align: center; }
        .book-select-item { border: 2px solid #e2e8f0; padding: 15px; border-radius: 15px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .book-select-item:hover { border-color: var(--electric-cyan); background: #f0f9ff; }
        .book-select-thumb { width: 60px; height: 60px; background: #ddd; border-radius: 10px; object-fit: cover; }

        /* --- EDITOR STYLES --- */
        .canvas-grid { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: var(--canvas-dark); background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 40px 40px; width: 100%; height: 100%; }
        .sidebar-editor { width: 80px; height: 100%; background: white; border-right: 3px solid #E2E8F0; display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 40; gap: 20px; flex-shrink: 0; }
        .icon-chunk { width: 55px; height: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; cursor: pointer; transition: 0.1s; position: relative; top: 0; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.2); }
        .icon-chunk:active { top: 4px; box-shadow: inset 0 0 0 rgba(0,0,0,0) !important; }
        .icon-chunk:hover { filter: brightness(1.1); }
        .icon-chunk::after { content: attr(data-tooltip); position: absolute; left: 65px; background: var(--text-main); color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; font-family: 'Nunito'; font-weight: 700; opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap; z-index: 100; }
        .icon-chunk:hover::after { opacity: 1; left: 70px; }

        /* Libro Clásico */
        #stage { perspective: 2500px; display: flex; align-items: center; justify-content: center; transition: transform 0.5s ease; transform-style: preserve-3d; }
        .book { position: relative; width: var(--book-width); height: var(--book-height); transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .book::before { content: ''; position: absolute; z-index: -1; width: 96%; height: 96%; left: 5%; top: 5%; background: rgba(0,0,0,0.2); filter: blur(20px); border-radius: 20px; transition: all 0.8s ease-in-out; opacity: 0.5; }
        .book.opened { transform: translateX(50%); } .book.opened::before { width: 196%; left: -95%; opacity: 0.4; background: rgba(0,0,0,0.15); } .book.closed-back { transform: translateX(100%); } .book.closed-back::before { width: 96%; left: -99%; }
        .paper { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: left center; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); transform-style: preserve-3d; }
        .paper.flipped { transform: rotateY(-180deg); z-index: 0; }
        .front, .back { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background-color: var(--paper-texture); backface-visibility: hidden; overflow: hidden; border-radius: 2px 5px 5px 2px; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .front { z-index: 2; border-right: 1px solid rgba(0,0,0,0.1); } .back { z-index: 1; transform: rotateY(180deg); border-left: 1px solid rgba(0,0,0,0.1); border-radius: 5px 2px 2px 5px; }
        .front::after { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 25px; background: linear-gradient(to right, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%); pointer-events: none; z-index: 10; }
        .back::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 25px; background: linear-gradient(to left, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%); pointer-events: none; z-index: 10; }
        .image-page { background-size: cover; background-position: center; background-color: #fff; }
        .text-page { background-color: #fffefae6; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; }
        .inline-input-title { font-family: 'Cinzel', serif; color: var(--accent-color); font-size: 1.4rem; background: transparent; border: 1px dashed transparent; text-align: center; width: 100%; margin-bottom: 5px; outline: none; padding: 5px; border-bottom: 2px solid var(--gold-color); }
        .inline-input-text { font-family: 'Merriweather', serif; font-size: 0.95rem; line-height: 1.8; color: #555; font-style: italic; background: transparent; border: 1px dashed transparent; text-align: center; width: 100%; outline: none; resize: none; overflow: hidden; padding: 5px; }
        .endpaper { background-color: var(--endpaper-bg); background-image: radial-gradient(var(--endpaper-dot) 1.5px, transparent 1.5px), radial-gradient(var(--endpaper-dot) 1.5px, transparent 1.5px); background-size: 20px 20px; }
        .page-number { position: absolute; bottom: 20px; font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-color); font-weight: bold; pointer-events: none; }
        .front .page-number { right: 20px; } .back .page-number { left: 20px; }

        /* Overlays */
        .edit-overlay { position: absolute; inset: 0; background: rgba(248, 250, 252, 0.6); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(4px); z-index: 20; }
        .editor-mode .front:hover .edit-overlay, .editor-mode .back:hover .edit-overlay { opacity: 1; }
        .upload-card { background: white; border: 3px solid var(--electric-cyan); padding: 15px; border-radius: 20px; text-align: center; transform: scale(0.9); transition: transform 0.3s; width: 80%; max-width: 240px; box-shadow: 0 10px 30px rgba(6, 182, 212, 0.2); }
        .editor-mode .front:hover .upload-card, .editor-mode .back:hover .upload-card { transform: scale(1); }
        .upload-btn { background: var(--pop-pink); color: white; padding: 10px; border-radius: 15px; font-family: 'Dosis', sans-serif; font-weight: 800; cursor: pointer; display: block; width: 100%; margin-bottom: 8px; border: none; box-shadow: 0 4px 0 #BE185D; transition: 0.1s; }
        .upload-btn:hover { transform: translateY(-2px); } .upload-btn:active { transform: translateY(2px); box-shadow: none; }
        .url-input { width: 100%; padding: 8px; background: #F1F5F9; border: 2px solid #CBD5E1; border-radius: 10px; font-size: 0.8rem; text-align: center; outline: none; font-family: 'Nunito'; font-weight: 700; }
        .remove-btn { margin-top: 5px; color: #EF4444; font-size: 0.8rem; cursor: pointer; background: none; border: none; font-weight: 800; text-transform: uppercase; }
        .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); width: 60px; height: 60px; border-radius: 50%; background: white; border: 3px solid var(--electric-cyan); color: var(--electric-cyan); font-size: 1.5rem; cursor: pointer; transition: 0.1s; z-index: 90; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 0 #0099cc; }
        .nav-btn:hover { transform: translateY(-55%); background: var(--electric-cyan); color: white; } .nav-btn:active { transform: translateY(-45%); box-shadow: none; }
        .prev-btn { left: 110px; } .next-btn { right: 40px; }

        /* =============================================
           ESTILOS RESPONSIVOS PARA MÓVILES (AJUSTE ESPECÍFICO)
           ============================================= */
        @media (max-width: 900px) {
            /* AJUSTE DE PRECISIÓN: 35vw para que quepa perfecto al lado de la barra */
            :root { 
                --book-width: 35vw; 
                --book-height: calc(35vw * 1.35); 
            }
            
            /* Contenedor principal en columna */
            .classroom-container { 
                flex-direction: column; 
            }
            
            /* Barra Lateral transformada en barra superior deslizable */
            .classroom-sidebar { 
                width: 100%; 
                height: auto; 
                flex-direction: row; 
                overflow-x: auto; /* Scroll horizontal */
                overflow-y: hidden;
                padding: 10px; 
                border-right: none; 
                border-bottom: 2px solid #E2E8F0;
                align-items: center;
                gap: 10px;
                background: white;
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
                z-index: 60;
            }
            
            /* Ocultar logo del sidebar en móvil */
            .sidebar-logo { display: none; }
            
            .menu-item { 
                margin-bottom: 0; 
                white-space: nowrap; 
                font-size: 0.85rem;
                padding: 8px 12px;
                flex-shrink: 0; 
            }
            
            .classroom-content { 
                padding: 15px; 
                overflow-y: auto; 
                height: 100%; 
            }

            .w-full.h-20 {
                height: 60px;
                padding-left: 15px;
                padding-right: 15px;
            }
            .kids-title.text-3xl { font-size: 1.5rem; }
            
            .user-chip { padding: 4px 8px; }
            .user-info { display: none; } 
            .user-avatar { width: 35px; height: 35px; }
            
            /* Ajustes específicos de actividades para que no se corten */
            .book-showcase { height: 350px; }
            .evidence-grid { grid-template-columns: 1fr; } 
            
            /* Forzar altura mínima en contenedores de iframes */
            #padlet-container, 
            .flex-1.bg-white.rounded-3xl { 
                min-height: 500px; 
                height: auto !important;
            }
            
            /* AJUSTE: Escala natural */
            #stage {
                transform: scale(1);
            }

            .nav-btn { width: 35px; height: 35px; font-size: 0.9rem; }
            .prev-btn { left: 5px; } 
            .next-btn { right: 5px; }
            
            .sidebar-editor { width: 50px; }
            .icon-chunk { width: 40px; height: 40px; font-size: 1rem; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // FIREBASE CONFIG (TU LLAVE)
        const firebaseConfig = {
            apiKey: "AIzaSyAThH-edUt4Ep9BR-Xuy5Zjmgl9Nky1keU",
            authDomain: "libroalbum.firebaseapp.com",
            projectId: "libroalbum",
            storageBucket: "libroalbum.firebasestorage.app",
            messagingSenderId: "395438498580",
            appId: "1:395438498580:web:9b9fa76328fb034dee9801",
            measurementId: "G-C9LFEFG2Z0"
        };

        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error(e); }

        const processImage = (file, callback) => {
            if (!file) return;
            if (file.size > 2000000) { if(!confirm("Imagen grande. ¿Seguir?")) return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800; let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.8));
                }; img.src = e.target.result;
            }; reader.readAsDataURL(file);
        };

        const MASTER_TEMPLATE = {
            title: "Nuevo Libro",
            pages: [
                { id: 'c1', type: 'structure', front: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/portada%20forntal.PNG?raw=true' }, back: { type: 'endpaper' } },
                { id: 'c2', type: 'structure', front: { type: 'endpaper' }, back: { type: 'text-page', title: 'Hoja de Respeto', text: '(Título de la Obra)' } },
                { id: 'c3', type: 'structure', front: { type: 'text-page', title: 'Créditos', text: 'Autor: Tu Nombre\nAño: 2024' }, back: { type: 'text-page', title: 'Dedicatoria', text: 'Para...' } },
                { id: 'p1', type: 'content', front: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/1x.png?raw=true' }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg2.jpg?raw=true' } },
                { id: 'end', type: 'structure', front: { type: 'endpaper' }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/contraportada.jpg?raw=true' } }
            ]
        };

        // --- COMPONENTE: VISOR DEL LIBRO (BOOKVIEWER) ---
        // DEFINIDO PRIMERO PORQUE ES REQUERIDO POR OTROS COMPONENTES
        function BookViewer({ pages, activeIdx, setActiveIdx, isEditor, onUpdatePage }) {
            const audioRef = useRef(null);
            const [localIdx, setLocalIdx] = useState(activeIdx); 
            const currentIdx = isEditor ? activeIdx : localIdx;
            const isOpen = currentIdx >= 0 && currentIdx < pages.length - 1;
            const isClosedBack = currentIdx === pages.length - 1;
            const changePage = (newIdx) => { if(audioRef.current) { audioRef.current.currentTime=0; audioRef.current.play().catch(()=>{}); } if(isEditor) setActiveIdx(newIdx); else setLocalIdx(newIdx); };
            
            useEffect(() => {
                const handleKeyDown = (e) => { 
                    if (e.key === "ArrowRight" && currentIdx < pages.length-1) changePage(currentIdx+1); 
                    if (e.key === "ArrowLeft" && currentIdx >= 0) changePage(currentIdx-1); 
                };
                window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentIdx, pages]);

            const isEditableImage = (idx, side) => { if (idx === 1 && side === 'back') return false; if (idx === 2) return false; return true; };
            const isEditableTitle = (idx, side) => { if (idx === 2) return false; return true; };
            const isEditableText = (idx, side) => { if (idx === 1 && side === 'back') return false; return true; };

            const renderEditOverlay = (pageIdx, side, currentBg) => {
                if (!isEditor || !isEditableImage(pageIdx, side)) return null;
                return (
                    <div className="edit-overlay">
                        <div className="upload-card">
                            <label className="btn-gummy btn-pink" style={{width:'100%', fontSize:'0.9rem', padding:'8px'}}>
                                <i className="fas fa-camera mr-2"></i> {currentBg ? 'Cambiar' : 'Subir'}
                                <input type="file" accept="image/*" className="hidden" onChange={(e) => { const file = e.target.files[0]; if(file) processImage(file, (base64) => onUpdatePage(pageIdx, side, 'bg', base64)); }} />
                            </label>
                            <input className="input-pop" placeholder="O pega enlace..." value={currentBg && currentBg.startsWith('http') ? currentBg : ''} onClick={(e) => e.stopPropagation()} onChange={(e) => onUpdatePage(pageIdx, side, 'bg', e.target.value)} style={{fontSize:'0.8rem', marginTop:'10px'}} />
                            {currentBg && <button className="remove-btn" onClick={(e) => { e.stopPropagation(); onUpdatePage(pageIdx, side, 'bg', ''); }}>BORRAR IMAGEN</button>}
                        </div>
                    </div>
                );
            };

            return (
                <div style={{width:'100%', height:'100%', display:'flex', justifyContent:'center', alignItems:'center', position:'relative'}}>
                    <audio ref={audioRef} src="https://raw.githubusercontent.com/libroalbum/libro-lbum-pedag-gico/main/images/sonido%20deslizar.mp3"></audio>
                    <div id="stage">
                        <div className={`book ${isOpen ? 'opened' : ''} ${isClosedBack ? 'closed-back' : ''}`}>
                            {pages.map((p, i) => {
                                const zIndex = currentIdx >= i ? i + 1 : pages.length - i;
                                return (
                                    <div key={p.id} className={`paper ${i <= currentIdx ? 'flipped' : ''}`} style={{zIndex}}>
                                        <div className={`front ${p.front.type}`} style={p.front.bg ? {backgroundImage:`url(${p.front.bg})`}:{}}>
                                            {renderEditOverlay(i, 'front', p.front.bg)}
                                            {p.front.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center relative z-10">
                                                    <input disabled={!isEditor || !isEditableTitle(i, 'front')} value={p.front.title} onChange={(e)=>onUpdatePage(i, 'front', 'title', e.target.value)} className="inline-input-title" />
                                                    <textarea disabled={!isEditor || !isEditableText(i, 'front')} value={p.front.text} onChange={(e)=>onUpdatePage(i, 'front', 'text', e.target.value)} className="inline-input-text" rows="6" />
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2}</span>}
                                        </div>
                                        <div className={`back ${p.back.type}`} style={p.back.bg ? {backgroundImage:`url(${p.back.bg})`}:{}}>
                                            {renderEditOverlay(i, 'back', p.back.bg)}
                                            {p.back.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center relative z-10">
                                                    <input disabled={!isEditor || !isEditableTitle(i, 'back')} value={p.back.title} onChange={(e)=>onUpdatePage(i, 'back', 'title', e.target.value)} className="inline-input-title" />
                                                    <textarea disabled={!isEditor || !isEditableText(i, 'back')} value={p.back.text} onChange={(e)=>onUpdatePage(i, 'back', 'text', e.target.value)} className="inline-input-text" rows="6" />
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2+1}</span>}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                    {currentIdx >= 0 && <button className="nav-btn prev-btn" onClick={() => changePage(currentIdx - 1)}><i className="fas fa-chevron-left"></i></button>}
                    {currentIdx < pages.length - 1 && <button className="nav-btn next-btn" onClick={() => changePage(currentIdx + 1)}><i className="fas fa-chevron-right"></i></button>}
                </div>
            );
        }

        // --- VISTA: VISOR PÚBLICO (MODO INVITADO) ---
        function PublicActivityViewer({ activity }) {
            const [padletZoom, setPadletZoom] = useState(1);
            const [moodboardZoom, setMoodboardZoom] = useState(0.75);
            const [storyboardZoom, setStoryboardZoom] = useState(0.75);

            const handleMoodboardZoomIn = () => setMoodboardZoom(prev => Math.min(prev + 0.1, 1.5));
            const handleMoodboardZoomOut = () => setMoodboardZoom(prev => Math.max(prev - 0.1, 0.5));
            const resetMoodboardZoom = () => setMoodboardZoom(0.75);

            const handleStoryboardZoomIn = () => setStoryboardZoom(prev => Math.min(prev + 0.1, 1.5));
            const handleStoryboardZoomOut = () => setStoryboardZoom(prev => Math.max(prev - 0.1, 0.5));
            const resetStoryboardZoom = () => setStoryboardZoom(0.75);

            const handleZoomIn = () => setPadletZoom(prev => Math.min(prev + 0.1, 1.5));
            const handleZoomOut = () => setPadletZoom(prev => Math.max(prev - 0.1, 0.5));
            const resetZoom = () => setPadletZoom(1);

            const getActivityTitle = () => {
                switch(activity) {
                    case 'guia': case 'reference_book': return "LIBRO GUÍA";
                    case 'moodboard': return "MOODBOARD";
                    case 'storyboard': return "STORYBOARD";
                    case 'quiz': return "QUIZ TIME";
                    case 'ficha': case 'ficha_personajes': return "FICHA DE PERSONAJES";
                    case 'ficha_narrativa': return "FICHA NARRATIVA";
                    case 'padlet': case 'muro': return "MURO COLABORATIVO";
                    default: return "";
                }
            };

            const renderZoomControls = (zoomVal, zoomIn, zoomOut, zoomReset) => (
                <div className="absolute top-4 right-4 bg-white p-1 rounded-xl shadow-md border border-gray-200 flex gap-1 z-50 transform scale-90">
                    <button onClick={zoomOut} className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center transition" title="Alejar"><i className="fas fa-minus"></i></button>
                    <span className="flex items-center justify-center w-10 text-xs font-bold text-gray-500">{Math.round(zoomVal * 100)}%</span>
                    <button onClick={zoomIn} className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center transition" title="Acercar"><i className="fas fa-plus"></i></button>
                    <button onClick={zoomReset} className="w-8 h-8 rounded-lg bg-teal-50 hover:bg-teal-100 text-teal-600 font-bold flex items-center justify-center transition ml-1" title="Restaurar"><i className="fas fa-compress"></i></button>
                </div>
            );

            const renderContent = () => {
                switch(activity) {
                    case 'guia':
                    case 'reference_book':
                        return (
                            <div className="relative h-full w-full bg-gray-50 flex flex-col p-2">
                                <button 
                                    onClick={() => {
                                        const elem = document.getElementById('guide-book-public-container');
                                        if (!document.fullscreenElement) {
                                            elem.requestFullscreen().catch(err => console.log(err));
                                        } else {
                                            document.exitFullscreen();
                                        }
                                    }} 
                                    className="absolute top-4 right-4 z-50 btn-gummy btn-indigo bg-indigo-500 text-xs px-3 py-1 shadow-indigo-700"
                                >
                                    <i className="fas fa-expand mr-1"></i> PANTALLA COMPLETA
                                </button>
                                <div id="guide-book-public-container" className="flex-1 bg-white rounded-xl border-2 border-indigo-100 overflow-hidden relative shadow-sm">
                                    <iframe src="https://libroalbum.github.io/libro-lbum-pedag-gico/" className="w-full h-full border-none"></iframe>
                                </div>
                            </div>
                        );
                    case 'moodboard':
                        return (
                            <div className="relative h-full w-full bg-gray-50 flex flex-col p-2">
                                {renderZoomControls(moodboardZoom, handleMoodboardZoomIn, handleMoodboardZoomOut, resetMoodboardZoom)}
                                <div className="flex-1 bg-white rounded-xl border-2 border-purple-100 overflow-hidden relative shadow-sm">
                                    <div style={{width: `${100 / moodboardZoom}%`, height: `${100 / moodboardZoom}%`, transform: `scale(${moodboardZoom})`, transformOrigin: '0 0', transition: 'transform 0.2s ease, width 0.2s ease, height 0.2s ease'}}>
                                        <iframe src="https://libroalbum.github.io/mooboard/" className="w-full h-full border-none"></iframe>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'storyboard':
                         return (
                            <div className="relative h-full w-full bg-gray-50 flex flex-col p-2">
                                {renderZoomControls(storyboardZoom, handleStoryboardZoomIn, handleStoryboardZoomOut, resetStoryboardZoom)}
                                <div className="flex-1 bg-white rounded-xl border-2 border-orange-100 overflow-hidden relative shadow-sm">
                                    <div style={{width: `${100 / storyboardZoom}%`, height: `${100 / storyboardZoom}%`, transform: `scale(${storyboardZoom})`, transformOrigin: '0 0', transition: 'transform 0.2s ease, width 0.2s ease, height 0.2s ease'}}>
                                        <iframe src="https://libroalbum.github.io/tablero/" className="w-full h-full border-none"></iframe>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'quiz':
                         return (
                            <div className="relative h-full w-full bg-gray-50 flex flex-col p-2">
                                <div className="flex-1 bg-white rounded-xl border-2 border-yellow-100 overflow-hidden relative shadow-sm group">
                                    <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/Kahoot-1.png?raw=true" alt="Kahoot Quiz" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                        <a href="https://create.kahoot.it/share/quiz-interactivo/f8f5983d-25e9-44e7-aa46-eab37837811f" target="_blank" rel="noopener noreferrer" className="btn-gummy btn-orange text-2xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform" style={{textDecoration: 'none'}}>
                                            <i className="fas fa-play-circle mr-3"></i> HACER QUIZ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'ficha':
                    case 'ficha_personajes':
                         return (
                            <div className="relative h-full w-full bg-gray-50 flex flex-col p-2">
                                <div className="flex-1 bg-white rounded-xl border-2 border-pink-100 overflow-hidden relative shadow-sm flex flex-col group">
                                    <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20de%20personajes.png?raw=true" className="w-full h-full object-cover" alt="Ficha de Personajes" />
                                    <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSdeATljdt5PMVoLzJ1x6S7sItasYY9hW2aiClLJpE1Yr1OyQw/viewform" target="_blank" rel="noopener noreferrer" className="btn-gummy btn-pink text-2xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform" style={{textDecoration: 'none'}}>
                                            <i className="fas fa-edit mr-3"></i> COMPLETAR FORMULARIO
                                        </a>
                                    </div>
                                </div>
                            </div>
                        );
                    case 'ficha_narrativa':
                         return (
                            <div className="relative h-full w-full bg-gray-50 flex flex-col p-2">
                                <div className="flex-1 bg-white rounded-xl border-2 border-rose-100 overflow-hidden relative shadow-sm flex flex-col group">
                                     <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20narrativa.jpg?raw=true" className="absolute inset-0 w-full h-full object-cover opacity-50 group-hover:opacity-40 transition" alt="Ficha Narrativa" />
                                     <div className="relative z-10 flex flex-col items-center justify-center h-full">
                                         <a 
                                            href="https://www.canva.com/design/DAG4JQ_26mk/yYHgZbuApHUSdalSG2938g/view?utm_content=DAG4JQ_26mk&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h15dc12dd5e" 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            className="btn-gummy btn-pink text-xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform decoration-none flex items-center gap-3"
                                            style={{textDecoration: 'none'}}
                                         >
                                            <i className="fas fa-pen-nib"></i> RELLENAR LA FICHA
                                         </a>
                                     </div>
                                </div>
                            </div>
                        );
                    case 'padlet':
                    case 'muro':
                         return (
                            <div className="relative h-full w-full bg-gray-50 flex flex-col p-2">
                                {renderZoomControls(padletZoom, handleZoomIn, handleZoomOut, resetZoom)}
                                <div className="flex-1 bg-white rounded-xl border-2 border-teal-100 overflow-hidden relative shadow-sm">
                                     <div style={{width: `${100 / padletZoom}%`, height: `${100 / padletZoom}%`, transform: `scale(${padletZoom})`, transformOrigin: '0 0', transition: 'transform 0.2s ease, width 0.2s ease, height 0.2s ease'}}>
                                        <iframe src="https://padlet.com/embed/kz78sfkwdm9abosj" frameBorder="0" allow="camera;microphone;geolocation;display-capture;clipboard-write" style={{width:'100%', height:'100%', display:'block'}} title="Muro Colaborativo Padlet"></iframe>
                                    </div>
                                </div>
                            </div>
                        );
                    default:
                        return <div className="flex items-center justify-center h-full text-2xl font-bold text-gray-400 font-sans">Actividad no encontrada</div>;
                }
            };

            return (
                <div className="h-screen w-full bg-[var(--bg-ice)] overflow-hidden flex flex-col">
                     <div className="w-full h-14 bg-white border-b-4 border-cyan-100 flex items-center justify-between px-6 shadow-sm z-50">
                        <div className="flex items-center gap-4">
                            <div className="kids-title text-xl text-cyan-500">CREATOR STUDIO</div>
                            <div className="h-6 w-0.5 bg-gray-300 rounded"></div>
                            <div className="font-bold text-gray-500 uppercase text-lg tracking-wide">{getActivityTitle()}</div>
                        </div>
                        <div className="flex items-center gap-3">
                             <div className="text-gray-400 font-bold text-xs uppercase tracking-wide flex items-center gap-2 mr-2">
                                <i className="fas fa-user-secret"></i> MODO INVITADO
                            </div>
                            <button 
                                onClick={() => window.location.href = window.location.pathname} 
                                className="btn-gummy btn-lime text-xs px-4 py-1 shadow-lime-600"
                            >
                                <i className="fas fa-sign-in-alt mr-2"></i> REGISTRARME
                            </button>
                        </div>
                     </div>
                     <div className="flex-1 overflow-hidden relative bg-gray-50">
                        {renderContent()}
                     </div>
                </div>
            );
        }

        // --- VISTA: LOGIN ---
        function LoginScreen({ setUser, setView }) {
            const [email, setEmail] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [isRegister, setIsRegister] = useState(false);
            const [isReset, setIsReset] = useState(false);

            const handleAuth = async (e) => { 
                e.preventDefault(); 
                try { 
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password); 
                    else await signInWithEmailAndPassword(auth, email, password); 
                } catch (err) { 
                    alert(err.message); 
                } 
            };

            const handleReset = async (e) => {
                e.preventDefault();
                if (!email) return alert("Por favor escribe tu correo para enviarte el enlace.");
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert("¡Enlace enviado! Revisa tu correo (y spam) para crear una nueva contraseña.");
                    setIsReset(false);
                } catch (err) {
                    alert("Error al enviar correo: " + err.message);
                }
            };

            return (
                <div className="login-page-bg">
                    <div className="shape-blob-1"></div>
                    <div className="shape-blob-2"></div>

                    <div className="login-card-clean">
                        <div className="login-title-clean text-center mb-6">
                            <div className="text-4xl text-blue-500 font-black tracking-wider leading-none">CREATOR</div>
                            <div className="text-4xl text-blue-500 font-black tracking-wider leading-none">STUDIO</div>
                        </div>
                        
                        {isReset ? (
                            <form onSubmit={handleReset}>
                                <p className="mb-4 text-gray-600 text-sm">Ingresa tu correo y te enviaremos un enlace mágico para recuperar tu acceso.</p>
                                <div className="input-group-clean">
                                    <i className="fas fa-envelope input-icon"></i>
                                    <input className="input-field-clean" placeholder="Correo electrónico" value={email} onChange={e=>setEmail(e.target.value)} required />
                                </div>
                                <button className="btn-login-clean">Enviar Enlace de Recuperación</button>
                                <span className="link-text mt-4" onClick={()=>setIsReset(false)}>
                                    <i className="fas fa-arrow-left mr-1"></i> Volver a Iniciar Sesión
                                </span>
                            </form>
                        ) : (
                            <form onSubmit={handleAuth}>
                                <div className="input-group-clean">
                                    <i className="fas fa-envelope input-icon"></i>
                                    <input className="input-field-clean" placeholder="Correo electrónico" value={email} onChange={e=>setEmail(e.target.value)} required />
                                </div>
                                <div className="input-group-clean">
                                    <i className="fas fa-lock input-icon"></i>
                                    <input className="input-field-clean" type="password" placeholder="Contraseña" value={password} onChange={e=>setPassword(e.target.value)} required />
                                    <i className="fas fa-eye-slash absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 cursor-pointer"></i>
                                </div>
                                <button className="btn-login-clean">{isRegister ? 'Registrarse' : 'Iniciar Sesión'}</button>
                                <div className="mt-4">
                                    <span className="register-link text-sm cursor-pointer hover:text-blue-500 transition" onClick={()=>setIsReset(true)}>¿Olvidaste tu contraseña?</span>
                                    <span className="link-text mt-2" onClick={()=>setIsRegister(!isRegister)}>
                                        {isRegister ? '¿Ya tienes cuenta? Inicia sesión' : 'Registrarse'}
                                    </span>
                                </div>
                            </form>
                        )}
                    </div>
                </div>
            );
        }

        // --- VISTA: DASHBOARD PRINCIPAL ---
        function Dashboard({ user, setView, setExternalTool }) {
            const [activeSection, setActiveSection] = useState('inicio');
            const [books, setBooks] = useState([]);
            const [portfolioData, setPortfolioData] = useState({});
            const [editingId, setEditingId] = useState(null);
            const [tempTitle, setTempTitle] = useState("");
            
            const [userProfile, setUserProfile] = useState({ name: user.email.split('@')[0], photo: '' });
            const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
            
            const [padletZoom, setPadletZoom] = useState(1);
            // Estado inicial del Zoom para Moodboard y Storyboard ajustado a 0.75
            const [moodboardZoom, setMoodboardZoom] = useState(0.75);
            const [storyboardZoom, setStoryboardZoom] = useState(0.75);
            
            const [showBookSelector, setShowBookSelector] = useState(false);

            useEffect(() => { 
                if(!user || !db) return; 
                const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books')); 
                onSnapshot(q, (snap) => setBooks(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), (doc) => {
                    if(doc.exists()) setPortfolioData(doc.data());
                });
                onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'profile', 'user_info'), (doc) => {
                    if(doc.exists()) {
                        setUserProfile(doc.data());
                    }
                });
            }, [user]);

            const saveProfile = async () => {
                await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'profile', 'user_info'), userProfile, { merge: true });
                setIsProfileModalOpen(false);
                alert("¡Perfil actualizado!");
            };

            const handleProfilePic = (e) => {
                const file = e.target.files[0];
                if(file) processImage(file, (base64) => setUserProfile({...userProfile, photo: base64}));
            };

            const handleMyBook = async () => {
                if (books.length > 0) {
                    openBook(books[0].id);
                } else {
                    const ref = await addDoc(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books'), { ...MASTER_TEMPLATE, createdAt: new Date().toISOString() });
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), { featuredBookId: ref.id }, { merge: true });
                    localStorage.setItem('currentBookId', ref.id);
                    setView('editor');
                }
            };

            const openBook = (bookId) => { localStorage.setItem('currentBookId', bookId); setView('editor'); };
            const launchTool = (url) => { user.toolUrl = url; setView('external'); };
            
            const uploadEvidence = (type, e) => {
                const file = e.target.files[0]; if(!file) return;
                processImage(file, async (base64) => {
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), { [type]: base64 }, { merge: true });
                    alert("¡Subido!");
                });
            };
            
            const copyLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?portfolio=${user.uid}`;
                navigator.clipboard.writeText(url);
                alert("Enlace público copiado.");
            };
            
            const getFeaturedBook = () => {
                if (books.length > 0) return books[0];
                return null;
            };

            // HANDLERS DE ZOOM
            const handlePadletZoomIn = () => setPadletZoom(prev => Math.min(prev + 0.1, 1.5));
            const handlePadletZoomOut = () => setPadletZoom(prev => Math.max(prev - 0.1, 0.5));
            const resetPadletZoom = () => setPadletZoom(1);

            const handleMoodboardZoomIn = () => setMoodboardZoom(prev => Math.min(prev + 0.1, 1.5));
            const handleMoodboardZoomOut = () => setMoodboardZoom(prev => Math.max(prev - 0.1, 0.5));
            const resetMoodboardZoom = () => setMoodboardZoom(0.75);

            const handleStoryboardZoomIn = () => setStoryboardZoom(prev => Math.min(prev + 0.1, 1.5));
            const handleStoryboardZoomOut = () => setStoryboardZoom(prev => Math.max(prev - 0.1, 0.5));
            const resetStoryboardZoom = () => setStoryboardZoom(0.75);

            const isHome = activeSection === 'inicio';

            return (
                <div className="flex flex-col h-full overflow-hidden bg-white">
                    {isHome && (
                        <div className="w-full h-20 flex items-center justify-between px-8 flex-shrink-0 shadow-sm z-50" style={{backgroundColor: 'var(--header-blue)'}}>
                            <div className="flex items-center gap-3">
                                <div className="kids-title text-3xl text-white">CREATOR STUDIO</div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="user-chip" onClick={()=>setIsProfileModalOpen(true)}>
                                    {userProfile.photo ? (
                                        <img src={userProfile.photo} className="user-avatar" />
                                    ) : (
                                        <div className="user-avatar flex items-center justify-center bg-blue-100 text-blue-500 font-bold text-xl">
                                            {userProfile.name.charAt(0).toUpperCase()}
                                        </div>
                                    )}
                                    <div className="user-info">
                                        <span className="user-name">{userProfile.name}</span>
                                        <span className="user-role">Estudiante</span>
                                    </div>
                                    <i className="fas fa-cog text-gray-400 text-xs ml-2"></i>
                                </div>
                                <div className="logout-btn-top" onClick={()=>signOut(auth)} title="Cerrar Sesión">
                                    <i className="fas fa-sign-out-alt"></i>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="classroom-container flex-1 overflow-hidden" style={{height: isHome ? 'calc(100% - 80px)' : '100%'}}>
                        <div className="classroom-sidebar">
                            {!isHome && <div className="sidebar-logo kids-title">CREATOR STUDIO</div>}
                            <div className={`menu-item ${activeSection==='inicio'?'active':''}`} onClick={()=>setActiveSection('inicio')}>
                                <i className="fas fa-home text-pink-500"></i> <span className="menu-text">Inicio</span>
                            </div>
                            <div className={`menu-item ${activeSection==='portafolio'?'active':''}`} onClick={()=>setActiveSection('portafolio')}>
                                <i className="fas fa-briefcase text-blue-500"></i> <span className="menu-text">Mi Portafolio</span>
                            </div>
                            <div className="mt-6 mb-2 text-xs font-bold text-gray-400 uppercase pl-4">ACTIVIDADES</div>

                            {/* --- NUEVA SECCIÓN 1: LIBRO GUÍA --- */}
                            <div className={`menu-item ${activeSection==='reference_book'?'active':''}`} onClick={()=>setActiveSection('reference_book')}>
                                <i className="fas fa-book-reader text-indigo-500"></i> <span className="menu-text">1. Libro Guía</span>
                            </div>

                            {/* --- RE-ENUMERACIÓN --- */}
                            <div className={`menu-item ${activeSection==='padlet'?'active':''}`} onClick={()=>setActiveSection('padlet')}>
                                <i className="fas fa-thumbtack text-teal-500"></i> <span className="menu-text">2. Muro Colaborativo</span>
                            </div>
                            <div className={`menu-item ${activeSection==='ficha_narrativa'?'active':''}`} onClick={()=>setActiveSection('ficha_narrativa')}>
                                <i className="fas fa-pen-fancy text-rose-500"></i> <span className="menu-text">3. Ficha Narrativa</span>
                            </div>
                            <div className={`menu-item ${activeSection==='quiz'?'active':''}`} onClick={()=>setActiveSection('quiz')}>
                                <i className="fas fa-puzzle-piece text-yellow-500"></i> <span className="menu-text">4. Quiz Interactivo</span>
                            </div>
                            <div className={`menu-item ${activeSection==='ficha_personajes'?'active':''}`} onClick={()=>setActiveSection('ficha_personajes')}>
                                <i className="fas fa-address-card text-pink-500"></i> <span className="menu-text">5. Ficha de Personajes</span>
                            </div>
                            <div className={`menu-item ${activeSection==='moodboard'?'active':''}`} onClick={()=>setActiveSection('moodboard')}>
                                <i className="fas fa-palette text-purple-500"></i> <span className="menu-text">6. Moodboard</span>
                            </div>
                            <div className={`menu-item ${activeSection==='storyboard'?'active':''}`} onClick={()=>setActiveSection('storyboard')}>
                                <i className="fas fa-film text-orange-500"></i> <span className="menu-text">7. Storyboard</span>
                            </div>
                            
                            <div className={`menu-item`} onClick={handleMyBook}>
                                <i className="fas fa-book-open text-green-500"></i> <span className="menu-text">{books.length > 0 ? 'Editar Libro' : 'Mi Libro'}</span>
                            </div>
                        </div>

                        <div className="classroom-content">
                            {isProfileModalOpen && (
                                <div className="modal-overlay">
                                    <div className="modal-content">
                                        <h3 className="pop-title text-2xl text-gray-700 mb-6">MI PERFIL DE CREADOR</h3>
                                        <div className="flex flex-col items-center gap-4">
                                            <div className="relative group cursor-pointer w-32 h-32">
                                                {userProfile.photo ? (
                                                    <img src={userProfile.photo} className="w-full h-full rounded-full object-cover border-4 border-blue-200" />
                                                ) : (
                                                    <div className="w-full h-full rounded-full bg-blue-100 flex items-center justify-center text-4xl text-blue-400 border-4 border-blue-200">
                                                        <i className="fas fa-user"></i>
                                                    </div>
                                                )}
                                                <div className="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                                    <i className="fas fa-camera text-white text-2xl"></i>
                                                </div>
                                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleProfilePic} />
                                            </div>
                                            <input className="input-pop text-center text-xl" value={userProfile.name} onChange={(e)=>setUserProfile({...userProfile, name: e.target.value})} placeholder="Escribe tu nombre aquí" />
                                            <div className="flex gap-2 w-full mt-4">
                                                <button className="btn-gummy btn-lime flex-1" onClick={saveProfile}>GUARDAR CAMBIOS</button>
                                                <button className="btn-gummy bg-gray-400 text-white" onClick={()=>setIsProfileModalOpen(false)}>CANCELAR</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeSection === 'inicio' && (
                                <div className="max-w-4xl mx-auto mt-4">
                                    <div className="module-header border-none mb-4">
                                        <h2 className="module-title text-cyan-500 text-4xl">BIENVENIDOS AL CURSO</h2>
                                    </div>
                                    <div className="glass-panel p-8 mb-8">
                                        <h3 className="text-3xl font-bold font-sans text-gray-700 mb-4">Introducción al Taller</h3>
                                        <p className="text-lg text-gray-600 mb-6">
                                            Hola creador. En este espacio encontrarás todas las herramientas necesarias para construir tu propio Libro Álbum. 
                                            Mira el siguiente video para comenzar tu aventura creativa.
                                        </p>
                                        <div className="w-full relative rounded-2xl overflow-hidden shadow-2xl border-4 border-white" style={{paddingBottom: '56.25%', background: '#000'}}>
                                            <iframe className="absolute top-0 left-0 w-full h-full" src="https://www.youtube.com/embed/Ex037JX3-BI?si=rZx7OSizIczac_-8" title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerPolicy="strict-origin-when-cross-origin" allowFullScreen></iframe>
                                        </div>
                                        <div className="mt-8 flex justify-center">
                                            <button onClick={handleMyBook} className="btn-gummy btn-orange text-xl px-8 py-4">
                                                <i className="fas fa-rocket mr-2"></i> ¡EMPEZAR MI LIBRO!
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'portafolio' && (
                                <div>
                                    <div className="module-header"><h2 className="module-title text-blue-600">GESTIÓN DE PORTAFOLIO</h2><button onClick={copyLink} className="btn-gummy btn-cyan text-sm"><i className="fas fa-link mr-2"></i> COPIAR ENLACE PÚBLICO</button></div>
                                    <div className="portfolio-container" style={{height:'auto', minHeight:'80vh', borderRadius:'20px', boxShadow:'0 0 20px rgba(0,0,0,0.05)'}}>
                                        <div className="portfolio-header-bg">
                                            <h1 className="text-5xl font-bold kids-title mb-2">PORTAFOLIO CREATIVO</h1>
                                            <p className="text-xl opacity-80 font-sans">De: {userProfile.name}</p> 
                                        </div>
                                        <div className="gallery-content">
                                            <div className="book-showcase relative group" style={{height: '550px'}}>
                                                {getFeaturedBook() ? (
                                                    <div className="w-full h-full flex flex-col items-center justify-center relative">
                                                        <div style={{transform: 'scale(0.8)', pointerEvents: 'none'}}>
                                                            <BookViewer pages={getFeaturedBook().pages} activeIdx={-1} setActiveIdx={()=>{}} isEditor={false} />
                                                        </div>
                                                        <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-50 rounded-3xl backdrop-blur-sm cursor-pointer" onClick={handleMyBook}>
                                                            <span className="btn-gummy btn-orange"><i className="fas fa-pencil-alt mr-2"></i> EDITAR MI LIBRO</span>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="flex flex-col items-center justify-center text-gray-400 cursor-pointer" onClick={handleMyBook}>
                                                        <i className="fas fa-plus-circle text-6xl mb-4 text-gray-500"></i>
                                                        <h3 className="text-2xl font-bold text-white">CREAR MI LIBRO</h3>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="evidence-grid">
                                                <div className="evidence-item relative group" onClick={() => document.getElementById('mood-up').click()}>
                                                    <div className="evidence-tag bg-purple-500">MOODBOARD</div>
                                                    {portfolioData.moodboard ? <img src={portfolioData.moodboard} className="evidence-img" /> : <div className="p-10 text-center text-gray-400 h-[300px] flex items-center justify-center">SIN IMAGEN</div>}
                                                    <div className="overlay-edit-evidence"><span className="btn-gummy btn-grape text-xs">CAMBIAR FOTO</span></div>
                                                    <input id="mood-up" type="file" className="hidden" onChange={(e)=>uploadEvidence('moodboard', e)}/>
                                                </div>
                                                <div className="evidence-item relative group" onClick={() => document.getElementById('story-up').click()}>
                                                    <div className="evidence-tag bg-orange-500">STORYBOARD</div>
                                                    {portfolioData.storyboard ? <img src={portfolioData.storyboard} className="evidence-img" /> : <div className="p-10 text-center text-gray-400 h-[300px] flex items-center justify-center">SIN IMAGEN</div>}
                                                    <div className="overlay-edit-evidence"><span className="btn-gummy btn-orange text-xs">CAMBIAR FOTO</span></div>
                                                    <input id="story-up" type="file" className="hidden" onChange={(e)=>uploadEvidence('storyboard', e)}/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- NUEVA SECCIÓN 1: LIBRO GUÍA --- */}
                            {activeSection === 'reference_book' && (
                                <div className="h-full flex flex-col">
                                    <div className="mb-6 flex justify-between items-end">
                                        <div>
                                            <h2 className="module-title text-indigo-500 mb-2">LIBRO GUÍA</h2>
                                            <p className="text-gray-600">Explora el libro ilustrado y aprende su estructura.</p>
                                        </div>
                                        <button 
                                            onClick={() => {
                                                const elem = document.getElementById('guide-book-container');
                                                if (!document.fullscreenElement) {
                                                    elem.requestFullscreen().catch(err => console.log(err));
                                                } else {
                                                    document.exitFullscreen();
                                                }
                                            }} 
                                            className="btn-gummy btn-indigo bg-indigo-500 text-sm px-4 py-2 shadow-indigo-700"
                                        >
                                            <i className="fas fa-expand mr-2"></i> PANTALLA COMPLETA
                                        </button>
                                    </div>
                                    <div id="guide-book-container" className="flex-1 bg-white rounded-3xl border-4 border-indigo-100 overflow-hidden relative shadow-lg">
                                        <iframe src="https://libroalbum.github.io/libro-lbum-pedag-gico/" className="w-full h-full border-none"></iframe>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'moodboard' && (
                                <div className="h-full flex flex-col">
                                    <div className="mb-6 flex justify-between items-center">
                                        <div>
                                            <h2 className="module-title text-purple-500 mb-2">MOODBOARD</h2>
                                            <p className="text-gray-600">Crea un tablero de inspiración con imágenes, colores y texturas.</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <div className="bg-white p-2 rounded-xl shadow-md border border-gray-200 flex gap-1">
                                                <button onClick={handleMoodboardZoomOut} className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center transition" title="Alejar"><i className="fas fa-minus"></i></button>
                                                <span className="flex items-center justify-center w-12 text-xs font-bold text-gray-500">{Math.round(moodboardZoom * 100)}%</span>
                                                <button onClick={handleMoodboardZoomIn} className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center transition" title="Acercar"><i className="fas fa-plus"></i></button>
                                                <button onClick={resetMoodboardZoom} className="w-8 h-8 rounded-lg bg-teal-50 hover:bg-teal-100 text-teal-600 font-bold flex items-center justify-center transition ml-1" title="Restaurar"><i className="fas fa-compress"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex-1 bg-white rounded-3xl border-4 border-purple-100 overflow-hidden relative shadow-lg">
                                        <div style={{width: `${100 / moodboardZoom}%`, height: `${100 / moodboardZoom}%`, transform: `scale(${moodboardZoom})`, transformOrigin: '0 0', transition: 'transform 0.2s ease, width 0.2s ease, height 0.2s ease'}}>
                                            <iframe src="https://libroalbum.github.io/mooboard/" className="w-full h-full border-none"></iframe>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'storyboard' && (
                                <div className="h-full flex flex-col">
                                    <div className="mb-6 flex justify-between items-center">
                                        <div>
                                            <h2 className="module-title text-orange-500 mb-2">STORYBOARD</h2>
                                            <p className="text-gray-600">Planifica tu historia escena por escena.</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <div className="bg-white p-2 rounded-xl shadow-md border border-gray-200 flex gap-1">
                                                <button onClick={handleStoryboardZoomOut} className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center transition" title="Alejar"><i className="fas fa-minus"></i></button>
                                                <span className="flex items-center justify-center w-12 text-xs font-bold text-gray-500">{Math.round(storyboardZoom * 100)}%</span>
                                                <button onClick={handleStoryboardZoomIn} className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center transition" title="Acercar"><i className="fas fa-plus"></i></button>
                                                <button onClick={resetStoryboardZoom} className="w-8 h-8 rounded-lg bg-teal-50 hover:bg-teal-100 text-teal-600 font-bold flex items-center justify-center transition ml-1" title="Restaurar"><i className="fas fa-compress"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex-1 bg-white rounded-3xl border-4 border-orange-100 overflow-hidden relative shadow-lg">
                                        <div style={{width: `${100 / storyboardZoom}%`, height: `${100 / storyboardZoom}%`, transform: `scale(${storyboardZoom})`, transformOrigin: '0 0', transition: 'transform 0.2s ease, width 0.2s ease, height 0.2s ease'}}>
                                            <iframe src="https://libroalbum.github.io/tablero/" className="w-full h-full border-none"></iframe>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'quiz' && (
                                <div className="h-full flex flex-col">
                                    <div className="mb-6">
                                        <h2 className="module-title text-yellow-500 mb-2">QUIZ TIME</h2>
                                        <p className="text-gray-600">¡Demuestra lo que has aprendido!</p>
                                    </div>
                                    <div className="flex-1 bg-white rounded-3xl border-4 border-yellow-100 overflow-hidden relative shadow-lg group">
                                        <img 
                                            src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/Kahoot-1.png?raw=true" 
                                            alt="Kahoot Quiz" 
                                            className="w-full h-full object-cover"
                                        />
                                        <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                            <a 
                                                href="https://create.kahoot.it/share/quiz-interactivo/f8f5983d-25e9-44e7-aa46-eab37837811f" 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className="btn-gummy btn-orange text-2xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform"
                                                style={{textDecoration: 'none'}}
                                            >
                                                <i className="fas fa-play-circle mr-3"></i> HACER QUIZ
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'ficha_personajes' && (
                                <div className="h-full flex flex-col">
                                    <div className="mb-6">
                                        <h2 className="module-title text-pink-500 mb-2">FICHA DE PERSONAJES</h2>
                                        <p className="text-gray-600">Completa la ficha técnica para definir a los protagonistas de tu historia.</p>
                                    </div>
                                    <div className="flex-1 bg-white rounded-3xl border-4 border-pink-100 overflow-hidden relative shadow-lg flex flex-col group">
                                        <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20de%20personajes.png?raw=true" className="w-full h-full object-cover" alt="Ficha de Personajes" />
                                        <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                            <a href="https://docs.google.com/forms/d/e/1FAIpQLSdeATljdt5PMVoLzJ1x6S7sItasYY9hW2aiClLJpE1Yr1OyQw/viewform" target="_blank" rel="noopener noreferrer" className="btn-gummy btn-pink text-2xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform" style={{textDecoration: 'none'}}>
                                                <i className="fas fa-edit mr-3"></i> COMPLETAR FORMULARIO
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- NUEVA SECCIÓN: FICHA NARRATIVA (CON BOTÓN) --- */}
                            {activeSection === 'ficha_narrativa' && (
                                <div className="h-full flex flex-col">
                                    <div className="mb-6">
                                        <h2 className="module-title text-rose-500 mb-2">FICHA NARRATIVA</h2>
                                        <p className="text-gray-600">Desarrolla la estructura de tu historia paso a paso.</p>
                                    </div>
                                    <div className="flex-1 bg-white rounded-3xl border-4 border-rose-100 overflow-hidden relative shadow-lg flex flex-col group">
                                         <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20narrativa.jpg?raw=true" className="w-full h-full object-cover" alt="Ficha Narrativa" />
                                         <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                             <a 
                                                href="https://www.canva.com/design/DAG4JQ_26mk/yYHgZbuApHUSdalSG2938g/view?utm_content=DAG4JQ_26mk&utm_campaign=designshare&utm_medium=link2&utm_source=uniquelinks&utlId=h15dc12dd5e" 
                                                target="_blank" 
                                                rel="noopener noreferrer"
                                                className="btn-gummy btn-pink text-xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform decoration-none flex items-center gap-3"
                                                style={{textDecoration: 'none'}}
                                             >
                                                <i className="fas fa-pen-nib"></i> RELLENAR LA FICHA
                                             </a>
                                         </div>
                                    </div>
                                </div>
                            )}

                            {activeSection === 'padlet' && (
                                <div className="h-full flex flex-col">
                                    <div className="mb-6 flex justify-between items-center">
                                        <div>
                                            <h2 className="module-title text-teal-500 mb-2">MURO COLABORATIVO</h2>
                                            <p className="text-gray-600">Comparte tus ideas, preguntas y avances con el resto de la clase.</p>
                                        </div>
                                        
                                        <div className="flex gap-2">
                                            <div className="bg-white p-2 rounded-xl shadow-md border border-gray-200 flex gap-1">
                                                <button onClick={handlePadletZoomOut} className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center transition" title="Alejar"><i className="fas fa-minus"></i></button>
                                                <span className="flex items-center justify-center w-12 text-xs font-bold text-gray-500">{Math.round(padletZoom * 100)}%</span>
                                                <button onClick={handlePadletZoomIn} className="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center transition" title="Acercar"><i className="fas fa-plus"></i></button>
                                                <button onClick={resetPadletZoom} className="w-8 h-8 rounded-lg bg-teal-50 hover:bg-teal-100 text-teal-600 font-bold flex items-center justify-center transition ml-1" title="Restaurar"><i className="fas fa-compress"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex-1 bg-white rounded-3xl border-4 border-teal-100 overflow-hidden relative shadow-lg" id="padlet-container">
                                        <div style={{
                                            width: `${100 / padletZoom}%`,
                                            height: `${100 / padletZoom}%`,
                                            transform: `scale(${padletZoom})`,
                                            transformOrigin: '0 0',
                                            transition: 'transform 0.2s ease, width 0.2s ease, height 0.2s ease'
                                        }}>
                                            <iframe 
                                                src="https://padlet.com/embed/kz78sfkwdm9abosj" 
                                                frameBorder="0" 
                                                allow="camera;microphone;geolocation;display-capture;clipboard-write" 
                                                style={{width:'100%', height:'100%', display:'block'}}
                                                title="Muro Colaborativo Padlet"
                                            ></iframe>
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        }

        // --- EDITOR (Lienzo Completo) ---
        function Editor({ user, setView }) {
            const [book, setBook] = useState(null);
            const [activeIdx, setActiveIdx] = useState(-1); 
            
            useEffect(() => { const bid = localStorage.getItem('currentBookId'); if(!bid || !db) return; getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', bid)).then(snap => { if(snap.exists()) setBook({id: snap.id, ...snap.data()}); }); }, []);
            const save = async () => { try { await updateDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', book.id), { pages: book.pages, title: book.title }); alert("¡GUARDADO!"); } catch (e) { alert("Error."); } };
            const handlePageUpdate = (idx, side, field, val) => { const newPages = [...book.pages]; newPages[idx][side][field] = val; setBook({...book, pages: newPages}); };
            const addPage = () => { const np = [...book.pages]; np.splice(np.length-1, 0, { id: Date.now(), type: 'content', front: { type: 'image-page', bg: '' }, back: { type: 'image-page', bg: '' } }); setBook({...book, pages: np}); };
            if(!book) return <div>Cargando...</div>;

            return (
                <div className="flex h-full w-full relative overflow-hidden">
                    <div className="sidebar-editor">
                        <div className="icon-chunk btn-cyan" onClick={()=>setView('dashboard')} data-tooltip="Volver al Aula"><i className="fas fa-arrow-left"></i></div>
                        <div className="icon-chunk btn-lime" onClick={save} data-tooltip="Guardar"><i className="fas fa-save"></i></div>
                        <div className="mt-auto"><div className="icon-chunk btn-orange" onClick={addPage} data-tooltip="Agregar Pág"><i className="fas fa-plus"></i></div></div>
                    </div>
                    <div className="canvas-grid editor-mode">
                        <BookViewer pages={book.pages} activeIdx={activeIdx} setActiveIdx={setActiveIdx} isEditor={true} onUpdatePage={handlePageUpdate} />
                    </div>
                </div>
            );
        }

        // --- VISTA PÚBLICA ---
        function PublicGallery({ uid }) {
            const [portfolio, setPortfolio] = useState({});
            const [book, setBook] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState({ name: 'Usuario' });

            useEffect(() => {
                if(!db) return;
                const load = async () => {
                    onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', uid), (d) => { if(d.exists()) setPortfolio(d.data()); });
                    onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'users', uid, 'profile', 'user_info'), (d) => { if(d.exists()) setUserProfile(d.data()); });
                    const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', uid, 'books'));
                    onSnapshot(q, (snap) => { /* Just to trigger updates if needed */ });
                }; load();
            }, [uid]);
            useEffect(() => {
                const fetchBook = async () => {
                      let bookIdToFetch = portfolio.featuredBookId;
                      if (!bookIdToFetch) {
                          const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', uid, 'books'));
                          const snap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', uid, 'books')); 
                      }

                      if(bookIdToFetch) {
                         getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', uid, 'books', bookIdToFetch)).then(snap => { 
                             if(snap.exists()) setBook({id: snap.id, ...snap.data()}); 
                             setLoading(false);
                         });
                      } else {
                          setLoading(false);
                      }
                };
                fetchBook();
            }, [portfolio]);

            if(loading) return <div className="flex h-screen items-center justify-center">Cargando Portafolio...</div>;

            return (
                <div className="h-full overflow-y-auto">
                    <div className="portfolio-container">
                        <div className="portfolio-header-bg">
                            <h1 className="text-5xl font-bold kids-title mb-2">PORTAFOLIO CREATIVO</h1>
                            <p className="text-xl opacity-80 font-sans">De: {userProfile.name}</p>
                        </div>
                        <div className="gallery-content">
                            <div className="book-showcase">
                                {book ? <BookViewer pages={book.pages} activeIdx={-1} setActiveIdx={()=>{}} isEditor={false} /> : <div className="text-white font-bold">Libro no disponible</div>}
                            </div>
                            <div className="evidence-grid">
                                <div className="evidence-item">
                                    <div className="evidence-tag bg-purple-500">MOODBOARD</div>
                                    {portfolio.moodboard ? <img src={portfolio.moodboard} className="evidence-img" /> : <div className="p-10 text-center text-gray-400">Sin imagen</div>}
                                </div>
                                <div className="evidence-item">
                                    <div className="evidence-tag bg-orange-500">STORYBOARD</div>
                                    {portfolio.storyboard ? <img src={portfolio.storyboard} className="evidence-img" /> : <div className="p-10 text-center text-gray-400">Sin imagen</div>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL (DEFINIDO AL FINAL) ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('loading'); 
            const [portfolioUid, setPortfolioUid] = useState(null);
            const [publicActivity, setPublicActivity] = useState(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const pUid = params.get('portfolio');
                const activityParam = params.get('activity'); 

                if (pUid) {
                    setPortfolioUid(pUid);
                    setView('public-view');
                } else if (activityParam) {
                    setPublicActivity(activityParam);
                    setView('public-activity');
                } else {
                    if (auth) { onAuthStateChanged(auth, (u) => { setUser(u); setView(u ? 'dashboard' : 'login'); }); }
                }
            }, []);

            if (view === 'public-view') return <PublicGallery uid={portfolioUid} />;
            
            if (view === 'public-activity') {
                return <PublicActivityViewer activity={publicActivity} />;
            }

            if (view === 'loading') return <div className="flex h-screen items-center justify-center font-bold text-xl text-blue-500">CARGANDO CREATOR STUDIO...</div>;

            return (
                <div className="flex flex-col h-full font-sans">
                    <main className="flex-1 relative overflow-hidden">
                        {view === 'login' && <LoginScreen setUser={setUser} setView={setView} />}
                        
                        {view === 'dashboard' && (
                            <Dashboard 
                                user={user} 
                                setView={setView} 
                            />
                        )}
                        
                        {view === 'editor' && <Editor user={user} setView={setView} />}
                        
                        {view === 'external' && (
                            <div className="w-full h-full bg-white relative flex flex-col">
                                <div className="h-14 bg-gray-800 flex items-center justify-between px-4 shadow-lg z-50">
                                    <span className="text-white font-bold">Herramienta Externa</span>
                                    <button onClick={() => setView('dashboard')} className="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded font-bold text-sm">CERRAR Y VOLVER</button>
                                </div>
                                <iframe src={user.toolUrl} style={{width:'100%', height:'100%', border:'none'}} title="Herramienta Externa"></iframe>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
