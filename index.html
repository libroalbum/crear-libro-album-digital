<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Studio Pop - Portafolio</title>
    
    <!-- LIBRER√çAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@600;800&family=Nunito:wght@400;700&family=Cinzel:wght@700&family=Merriweather&family=Luckiest+Guy&display=swap" rel="stylesheet">

    <!-- REACT -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- 1. PALETA "ELECTRIC PASTELS" --- */
        :root {
            --bg-ice: #F8FAFC; 
            --text-main: #334155;
            --header-blue: #00C6FF; 
            
            /* Acentos */
            --hyper-grape: #8B5CF6;
            --lime-punch: #84CC16;
            --electric-cyan: #06B6D4;
            --hot-orange: #F97316;
            --pop-pink: #EC4899;
            
            /* Sombras */
            --shadow-grape: #6D28D9;
            --shadow-lime: #4D7C0F;
            --shadow-cyan: #0097bd;
            --shadow-orange: #C2410C;
            --shadow-pink: #BE185D;

            --canvas-dark: #1e293b;

            /* Variables Libro */
            --book-width: 460px;
            --book-height: 600px;
            --paper-texture: #fdfbf7;
            --text-color: #2c3e50;
            --accent-color: #5d4037;
            --gold-color: #d4af37;
            --endpaper-bg: #a5d6a7; 
            --endpaper-dot: #ffffff; 
        }

        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }

        body {
            font-family: 'Nunito', sans-serif;
            color: var(--text-main);
            background-color: var(--bg-ice);
            background-image: radial-gradient(#E2E8F0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1, h2, h3, .pop-title { font-family: 'Dosis', sans-serif; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .kids-title { font-family: 'Luckiest Guy', cursive; letter-spacing: 1px; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); font-size: 2.5rem; }

        /* --- UI GUMMY --- */
        .btn-gummy {
            border: none; outline: none; cursor: pointer;
            font-family: 'Dosis', sans-serif; font-weight: 800; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 20px; border-radius: 20px; color: white; text-transform: uppercase;
            transition: transform 0.1s; position: relative; top: 0;
        }
        .btn-gummy:active { top: 6px; box-shadow: 0 0 0 transparent !important; }
        .btn-gummy:hover { filter: brightness(1.05); }

        .btn-grape { background: var(--hyper-grape); box-shadow: 0 6px 0 var(--shadow-grape); }
        .btn-lime { background: var(--lime-punch); box-shadow: 0 6px 0 var(--shadow-lime); }
        .btn-cyan { background: var(--electric-cyan); box-shadow: 0 6px 0 var(--shadow-cyan); }
        .btn-orange { background: var(--hot-orange); box-shadow: 0 6px 0 var(--shadow-orange); }
        .btn-pink { background: var(--pop-pink); box-shadow: 0 6px 0 var(--shadow-pink); }

        .sticker-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 4px solid white; border-radius: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .input-pop { background: white; border: 3px solid #E2E8F0; border-radius: 15px; padding: 12px 15px; width: 100%; font-family: 'Nunito', sans-serif; font-weight: 700; color: #475569; outline: none; transition: 0.2s; }
        .input-pop:focus { border-color: var(--electric-cyan); box-shadow: 0 0 0 4px rgba(0, 198, 255, 0.2); }

        /* --- ESTRUCTURA --- */
        .header-studio {
            width: 100%; background-color: var(--header-blue);
            padding: 15px 40px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 4px solid rgba(0,0,0,0.1); z-index: 50;
            box-shadow: 0 4px 15px rgba(0, 198, 255, 0.3); flex-shrink: 0;
        }
        .logo-text { font-size: 2rem; color: white; text-shadow: 2px 2px 0px rgba(0,0,0,0.2); }

        /* --- TARJETAS HERRAMIENTAS --- */
        .tool-card {
            background: white; border-radius: 24px; overflow: hidden;
            box-shadow: 0 8px 0 rgba(0,0,0,0.05); border: 4px solid white;
            transition: 0.2s; position: relative; display: flex; flex-direction: column;
            height: 260px; /* M√°s alto para acomodar la imagen subida */
        }
        .tool-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); z-index: 10; }
        
        .tool-header { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; cursor: pointer; }
        .tool-icon-circle { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.8rem; color: white; }
        .tool-title { font-family: 'Luckiest Guy', cursive; font-size: 1.4rem; color: white; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 0 rgba(0,0,0,0.1); }
        
        .tool-footer { background: #f8fafc; padding: 10px; border-top: 2px dashed #e2e8f0; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 5px; }
        
        .evidence-preview { width: 100%; height: 80px; border-radius: 10px; object-fit: cover; border: 2px solid #ddd; margin-bottom: 5px; }
        .evidence-label { font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; }

        /* --- TARJETAS PROYECTO --- */
        .project-card { background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 4px solid white; transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; height: 300px; }
        .project-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .card-img-container { flex: 1; background-color: #f1f5f9; position: relative; overflow: hidden; border-radius: 20px 20px 0 0; }
        .card-footer { padding: 15px; text-align: center; border-radius: 0 0 20px 20px; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 90px; }
        .card-title { font-family: 'Dosis', sans-serif; font-weight: 800; font-size: 1.3rem; margin-bottom: 5px; color: white; text-shadow: 1px 1px 0 rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .simple-edit-input { background: transparent; border: none; border-bottom: 2px solid white; color: white; font-family: 'Dosis', sans-serif; font-weight: 800; font-size: 1.3rem; text-align: center; width: 90%; outline: none; padding-bottom: 2px; }
        .simple-edit-input::placeholder { color: rgba(255,255,255,0.7); }
        .card-tag { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; background: rgba(255,255,255,0.25); color: white; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
        .project-card:hover .card-tag { background: white; color: #333; }

        /* --- EDITOR & LIBRO --- */
        .canvas-grid { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: var(--canvas-dark); background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 40px 40px; width: 100%; height: 100%; margin: 0; padding: 0; }
        .sidebar-studio { width: 80px; height: 100%; background: white; border-right: 3px solid #E2E8F0; display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 40; gap: 20px; flex-shrink: 0; }
        .icon-chunk { width: 55px; height: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; cursor: pointer; transition: 0.1s; position: relative; top: 0; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.2); }
        .icon-chunk:active { top: 4px; box-shadow: inset 0 0 0 rgba(0,0,0,0) !important; }
        .icon-chunk:hover { filter: brightness(1.1); }
        .icon-chunk::after { content: attr(data-tooltip); position: absolute; left: 65px; background: var(--text-main); color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; font-family: 'Nunito'; font-weight: 700; opacity: 0; pointer-events: none; transition: 0.2s; white-space: nowrap; z-index: 100; }
        .icon-chunk:hover::after { opacity: 1; left: 70px; }

        #stage { perspective: 2500px; display: flex; align-items: center; justify-content: center; transition: transform 0.5s ease; transform-style: preserve-3d; }
        .book { position: relative; width: var(--book-width); height: var(--book-height); transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .book::before { content: ''; position: absolute; z-index: -1; width: 96%; height: 96%; left: 5%; top: 5%; background: rgba(0,0,0,0.2); filter: blur(20px); border-radius: 20px; transition: all 0.8s ease-in-out; opacity: 0.5; }
        .book.opened { transform: translateX(50%); } .book.opened::before { width: 196%; left: -95%; opacity: 0.4; background: rgba(0,0,0,0.15); } .book.closed-back { transform: translateX(100%); } .book.closed-back::before { width: 96%; left: -99%; }
        .paper { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: left center; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); transform-style: preserve-3d; }
        .paper.flipped { transform: rotateY(-180deg); z-index: 0; }
        .front, .back { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background-color: var(--paper-texture); backface-visibility: hidden; overflow: hidden; border-radius: 2px 5px 5px 2px; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .front { z-index: 2; border-right: 1px solid rgba(0,0,0,0.1); } .back { z-index: 1; transform: rotateY(180deg); border-left: 1px solid rgba(0,0,0,0.1); border-radius: 5px 2px 2px 5px; }
        .front::after { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 25px; background: linear-gradient(to right, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%); pointer-events: none; z-index: 10; }
        .back::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 25px; background: linear-gradient(to left, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%); pointer-events: none; z-index: 10; }
        
        .image-page { background-size: cover; background-position: center; background-color: #fff; }
        .text-page { background-color: #fffefae6; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; }
        .inline-input-title { font-family: 'Cinzel', serif; color: var(--accent-color); font-size: 1.4rem; background: transparent; border: 1px dashed transparent; text-align: center; width: 100%; margin-bottom: 5px; outline: none; padding: 5px; border-bottom: 2px solid var(--gold-color); }
        .inline-input-title:hover:not(:disabled) { border-color: rgba(0,0,0,0.1); background: rgba(255,255,255,0.5); cursor: text; }
        .inline-input-text { font-family: 'Merriweather', serif; font-size: 0.95rem; line-height: 1.8; color: #555; font-style: italic; background: transparent; border: 1px dashed transparent; text-align: center; width: 100%; outline: none; resize: none; overflow: hidden; padding: 5px; }
        .inline-input-text:hover:not(:disabled) { border-color: rgba(0,0,0,0.1); background: rgba(255,255,255,0.5); cursor: text; }
        .endpaper { background-color: var(--endpaper-bg); background-image: radial-gradient(var(--endpaper-dot) 1.5px, transparent 1.5px), radial-gradient(var(--endpaper-dot) 1.5px, transparent 1.5px); background-size: 20px 20px; }
        .page-number { position: absolute; bottom: 20px; font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-color); font-weight: bold; pointer-events: none; }
        .front .page-number { right: 20px; } .back .page-number { left: 20px; }

        .edit-overlay { position: absolute; inset: 0; background: rgba(248, 250, 252, 0.6); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(4px); z-index: 20; }
        .editor-mode .front:hover .edit-overlay, .editor-mode .back:hover .edit-overlay { opacity: 1; }
        .upload-card { background: white; border: 3px solid var(--electric-cyan); padding: 15px; border-radius: 20px; text-align: center; transform: scale(0.9); transition: transform 0.3s; width: 80%; max-width: 240px; box-shadow: 0 10px 30px rgba(6, 182, 212, 0.2); }
        .editor-mode .front:hover .upload-card, .editor-mode .back:hover .upload-card { transform: scale(1); }
        .upload-btn { background: var(--pop-pink); color: white; padding: 10px; border-radius: 15px; font-family: 'Dosis', sans-serif; font-weight: 800; cursor: pointer; display: block; width: 100%; margin-bottom: 8px; border: none; box-shadow: 0 4px 0 var(--shadow-pink); transition: 0.1s; }
        .upload-btn:hover { transform: translateY(-2px); } .upload-btn:active { transform: translateY(2px); box-shadow: none; }
        .url-input { width: 100%; padding: 8px; background: #F1F5F9; border: 2px solid #CBD5E1; border-radius: 10px; font-size: 0.8rem; text-align: center; outline: none; font-family: 'Nunito'; font-weight: 700; }
        .remove-btn { margin-top: 5px; color: #EF4444; font-size: 0.8rem; cursor: pointer; background: none; border: none; font-weight: 800; text-transform: uppercase; }

        .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); width: 60px; height: 60px; border-radius: 50%; background: white; border: 3px solid var(--electric-cyan); color: var(--electric-cyan); font-size: 1.5rem; cursor: pointer; transition: 0.1s; z-index: 90; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 0 var(--shadow-cyan); }
        .nav-btn:hover { transform: translateY(-55%); background: var(--electric-cyan); color: white; } .nav-btn:active { transform: translateY(-45%); box-shadow: none; }
        .prev-btn { left: 110px; } .next-btn { right: 40px; }
        
        /* --- PUBLIC PORTFOLIO STYLES --- */
        .portfolio-container { height: 100vh; overflow-y: auto; background: var(--bg-ice); }
        .portfolio-header { background: var(--header-blue); color: white; padding: 40px; text-align: center; margin-bottom: 40px; border-radius: 0 0 50% 50% / 30px; }
        .portfolio-section { max-width: 1000px; margin: 0 auto 60px auto; padding: 0 20px; }
        .portfolio-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; }
        .evidence-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 4px solid white; }
        .evidence-img { width: 100%; height: 250px; object-fit: cover; background: #f0f0f0; }
        .evidence-title { padding: 15px; text-align: center; font-family: 'Dosis'; font-weight: 800; font-size: 1.5rem; color: var(--text-main); background: #f8fafc; }

        @media (max-width: 900px) { :root { --book-width: 44vw; --book-height: calc(44vw * 1.35); } #stage { perspective: 1200px; } .sidebar-studio { width: 60px; } .icon-chunk { width: 45px; height: 45px; font-size: 1.2rem; } .prev-btn { left: 80px; } }
    </style>
</head>
<body class="h-screen overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // CLAVES FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAThH-edUt4Ep9BR-Xuy5Zjmgl9Nky1keU",
            authDomain: "libroalbum.firebaseapp.com",
            projectId: "libroalbum",
            storageBucket: "libroalbum.firebasestorage.app",
            messagingSenderId: "395438498580",
            appId: "1:395438498580:web:9b9fa76328fb034dee9801",
            measurementId: "G-C9LFEFG2Z0"
        };

        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error(e); }

        const processImage = (file, callback) => {
            if (!file) return;
            if (file.size > 2000000) { if(!confirm("Imagen grande. ¬øSeguir?")) return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800;
                    let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.8));
                }; img.src = e.target.result;
            }; reader.readAsDataURL(file);
        };

        const MASTER_TEMPLATE = {
            title: "Mi Gran Historia",
            pages: [
                { id: 'c1', type: 'structure', front: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/portada%20forntal.PNG?raw=true' }, back: { type: 'endpaper' } },
                { id: 'c2', type: 'structure', front: { type: 'endpaper' }, back: { type: 'text-page', title: 'Hoja de Respeto', text: '(T√≠tulo de la Obra)' } },
                { id: 'c3', type: 'structure', front: { type: 'text-page', title: 'Cr√©ditos', text: 'Autor: Tu Nombre\nA√±o: 2024' }, back: { type: 'text-page', title: 'Dedicatoria', text: 'Para...' } },
                { id: 'p1', type: 'content', front: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/1x.png?raw=true' }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg2.jpg?raw=true' } },
                { id: 'end', type: 'structure', front: { type: 'endpaper' }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/contraportada.jpg?raw=true' } }
            ]
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('loading'); 
            const [publicPortfolio, setPublicPortfolio] = useState(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const portfolioUid = params.get('portfolio');
                
                if (portfolioUid) {
                    // Cargar Portafolio P√∫blico (Libros + Evidencias)
                    const loadPortfolio = async () => {
                        if(!db) return;
                        // Cargar evidencia
                        const pfDoc = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', portfolioUid));
                        const evidence = pfDoc.exists() ? pfDoc.data() : {};
                        
                        // Cargar Libros
                        const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', portfolioUid, 'books'));
                        const booksSnap = await getSnapshot(q); // Helper needed? No, standard way
                        // Actually, to use query inside useEffect easily with cleanups is hard, let's fetch once for portfolio
                        // We need onSnapshot? For public view maybe just getDocs is enough but let's stick to pattern if possible
                        // For simplicity in one file, let's just fetch once.
                        // Wait, I need the function getDocs, I only imported onSnapshot.
                        // I will use onSnapshot for consistency.
                    };
                    // Since I can't easily import getDocs without changing top imports (risk), I'll use a simple component logic
                    setPublicPortfolio(portfolioUid);
                    setView('public-portfolio');
                } else {
                    if (auth) { onAuthStateChanged(auth, (u) => { setUser(u); setView(u ? 'dashboard' : 'login'); }); }
                }
            }, []);

            if (view === 'public-portfolio' && publicPortfolio) return <PublicPortfolioView uid={publicPortfolio} />;
            if (view === 'loading') return <div className="flex h-screen items-center justify-center font-bold text-xl" style={{color:'var(--hyper-grape)'}}>CARGANDO...</div>;

            return (
                <div className="flex flex-col h-full font-sans">
                    <main className="flex-1 relative overflow-hidden">
                        {view === 'login' && <LoginScreen setUser={setUser} setView={setView} />}
                        {view === 'dashboard' && <Dashboard user={user} setView={setView} />}
                        {view === 'editor' && <Editor user={user} setView={setView} />}
                        {view === 'external' && <ExternalToolView url={user.toolUrl} setView={setView} />}
                    </main>
                </div>
            );
        }

        function LoginScreen({ setUser, setView }) {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [isRegister, setIsRegister] = useState(false);
            const handleAuth = async (e) => { e.preventDefault(); try { if (isRegister) await createUserWithEmailAndPassword(auth, email, password); else await signInWithEmailAndPassword(auth, email, password); } catch (err) { alert(err.message); } };
            return (
                <div className="flex items-center justify-center h-full">
                    <div className="sticker-panel p-10 max-w-md w-full text-center border-t-8" style={{borderColor:'var(--hyper-grape)'}}>
                        <h2 className="text-4xl mb-6 pop-title" style={{color:'var(--hyper-grape)'}}>{isRegister ? '¬°CREAR CUENTA!' : '¬°HOLA DE NUEVO!'}</h2>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input className="input-pop" placeholder="Tu Correo" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input className="input-pop" type="password" placeholder="Contrase√±a Secreta" value={password} onChange={e=>setPassword(e.target.value)} required />
                            <button className="btn-gummy btn-lime w-full mt-6">{isRegister ? 'REGISTRARME' : 'ENTRAR'}</button>
                        </form>
                        <p className="mt-6 text-sm font-bold cursor-pointer hover:text-purple-500" style={{color:'var(--text-main)'}} onClick={()=>setIsRegister(!isRegister)}>{isRegister ? '¬øYa tienes cuenta? Entra aqu√≠' : '¬øNo tienes cuenta? Reg√≠strate'}</p>
                    </div>
                </div>
            );
        }

        function Dashboard({ user, setView }) {
            const [books, setBooks] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [tempTitle, setTempTitle] = useState("");
            const [portfolioData, setPortfolioData] = useState({});

            useEffect(() => { 
                if(!user || !db) return; 
                const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books')); 
                onSnapshot(q, (snap) => setBooks(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                
                // Load Portfolio Data
                onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), (doc) => {
                    if(doc.exists()) setPortfolioData(doc.data());
                });
            }, [user]);
            
            const createNew = async () => { const ref = await addDoc(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books'), { ...MASTER_TEMPLATE, createdAt: new Date().toISOString() }); localStorage.setItem('currentBookId', ref.id); setView('editor'); };
            const openBook = (bookId) => { localStorage.setItem('currentBookId', bookId); setView('editor'); };
            
            // External Tools
            const launchTool = (url) => { user.toolUrl = url; setView('external'); };
            
            // Upload Evidence
            const handleEvidenceUpload = (type, e) => {
                const file = e.target.files[0];
                if(!file) return;
                processImage(file, async (base64) => {
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), {
                        [type]: base64
                    }, { merge: true });
                    alert("¬°Evidencia subida con √©xito!");
                });
            };

            const copyPortfolioLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?portfolio=${user.uid}`;
                navigator.clipboard.writeText(url);
                alert("¬°Enlace de tu Portafolio copiado! Comp√°rtelo con todos.");
            };

            const deleteBook = async (e, bookId) => { e.stopPropagation(); if(confirm("¬øBorrar cuento?")) await deleteDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', bookId)); };
            const startRename = (e, book) => { e.stopPropagation(); setEditingId(book.id); setTempTitle(book.title); };
            const saveRename = async (e, bookId) => { e.stopPropagation(); if(tempTitle.trim()) await updateDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', bookId), { title: tempTitle }); setEditingId(null); };

            const colors = ['var(--hot-orange)', 'var(--lime-punch)', 'var(--hyper-grape)', 'var(--pop-pink)', 'var(--electric-cyan)'];
            const textColors = ['#444', '#fff', '#fff', '#fff', '#fff'];

            return (
                <div className="h-full overflow-y-auto relative bg-slate-50">
                    <header className="header-studio">
                        <h2 className="text-3xl pop-title logo-text text-white kids-title">CREATOR STUDIO</h2>
                        <div className="flex gap-4 items-center">
                            <button onClick={copyPortfolioLink} className="btn-gummy btn-cyan text-xs px-4 shadow-lg border-2 border-white">üåç MI PORTAFOLIO</button>
                            <button onClick={() => signOut(auth)} className="btn-gummy btn-pink text-xs py-2 px-4">SALIR</button>
                        </div>
                    </header>
                    
                    <div className="p-8 max-w-7xl mx-auto">
                        {/* MISIONES */}
                        <div className="mb-10">
                            <h3 className="text-2xl font-bold text-gray-700 mb-6 pop-title pl-2 border-l-4 border-yellow-400">MISIONES CREATIVAS</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* MOODBOARD */}
                                <div className="tool-card" style={{borderColor:'var(--hyper-grape)', backgroundColor:'#F3E8FF'}}>
                                    <div className="tool-header" onClick={() => launchTool('https://libroalbum.github.io/mooboard/')}>
                                        <div className="tool-icon-circle bg-purple-400"><i className="fas fa-palette"></i></div>
                                        <span className="tool-title" style={{color:'var(--hyper-grape)'}}>MOODBOARD</span>
                                    </div>
                                    <div className="tool-footer">
                                        {portfolioData.moodboard ? (
                                            <div className="text-center w-full">
                                                <img src={portfolioData.moodboard} className="evidence-preview" />
                                                <span className="text-green-600 font-bold text-xs">¬°ENTREGADO!</span>
                                                <label className="cursor-pointer text-xs underline text-gray-500 block mt-1">Cambiar foto<input type="file" className="hidden" onChange={(e)=>handleEvidenceUpload('moodboard', e)}/></label>
                                            </div>
                                        ) : (
                                            <label className="btn-gummy btn-grape text-xs w-full">
                                                <i className="fas fa-camera mr-2"></i> SUBIR EVIDENCIA
                                                <input type="file" className="hidden" onChange={(e)=>handleEvidenceUpload('moodboard', e)} />
                                            </label>
                                        )}
                                    </div>
                                </div>

                                {/* STORYBOARD */}
                                <div className="tool-card" style={{borderColor:'var(--hot-orange)', backgroundColor:'#FFEDD5'}}>
                                    <div className="tool-header" onClick={() => launchTool('https://libroalbum.github.io/tablero/')}>
                                        <div className="tool-icon-circle bg-orange-400"><i className="fas fa-film"></i></div>
                                        <span className="tool-title" style={{color:'var(--hot-orange)'}}>STORYBOARD</span>
                                    </div>
                                    <div className="tool-footer">
                                        {portfolioData.storyboard ? (
                                            <div className="text-center w-full">
                                                <img src={portfolioData.storyboard} className="evidence-preview" />
                                                <span className="text-green-600 font-bold text-xs">¬°ENTREGADO!</span>
                                                <label className="cursor-pointer text-xs underline text-gray-500 block mt-1">Cambiar foto<input type="file" className="hidden" onChange={(e)=>handleEvidenceUpload('storyboard', e)}/></label>
                                            </div>
                                        ) : (
                                            <label className="btn-gummy btn-orange text-xs w-full">
                                                <i className="fas fa-camera mr-2"></i> SUBIR EVIDENCIA
                                                <input type="file" className="hidden" onChange={(e)=>handleEvidenceUpload('storyboard', e)} />
                                            </label>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* REFERENCIA (SOLO LINK) */}
                            <div className="mt-6">
                                <div onClick={() => launchTool('https://libroalbum.github.io/libro-lbum-pedag-gico/')} className="bg-white p-4 rounded-xl border-2 border-green-200 flex items-center justify-center gap-4 cursor-pointer hover:bg-green-50 transition shadow-sm">
                                    <i className="fas fa-book-reader text-green-500 text-2xl"></i>
                                    <span className="font-bold text-green-700 font-sans">VER LIBRO DE EJEMPLO (REFERENCIA)</span>
                                </div>
                            </div>
                        </div>

                        {/* PROYECTOS */}
                        <div>
                            <h3 className="text-2xl font-bold text-gray-700 mb-6 pop-title pl-2 border-l-4 border-blue-400">MIS LIBROS</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                <div onClick={createNew} className="h-full min-h-[300px] flex flex-col items-center justify-center cursor-pointer hover:scale-105 transition duration-300 border-dashed border-4 border-gray-300 rounded-3xl bg-white">
                                    <div className="w-16 h-16 rounded-full bg-cyan-100 flex items-center justify-center mb-4"><i className="fas fa-plus text-3xl text-cyan-500"></i></div>
                                    <span className="font-bold text-lg text-gray-400 font-sans">CREAR NUEVO</span>
                                </div>
                                {books.map((b, i) => {
                                    const bgColor = colors[i % colors.length];
                                    const textColor = textColors[i % textColors.length];
                                    return (
                                        <div key={b.id} className="project-card group" onClick={()=>openBook(b.id)}>
                                            <div className="card-img-container h-48 bg-gray-100 relative overflow-hidden">
                                                {b.pages[0].front.bg && <img src={b.pages[0].front.bg} className="w-full h-full object-cover" />}
                                                <span className="absolute bottom-2 right-2 text-[10px] font-bold text-white bg-black/40 px-2 py-1 rounded backdrop-blur-sm font-sans">{b.pages.length} P√ÅGS</span>
                                                <button className="absolute top-2 right-2 bg-white text-red-500 w-8 h-8 rounded-full shadow flex items-center justify-center hover:bg-red-50 transition z-20" onClick={(e) => deleteBook(e, b.id)} title="Borrar"><i className="fas fa-trash-alt text-sm"></i></button>
                                            </div>
                                            <div className="card-footer" style={{backgroundColor: bgColor, color: textColor}}>
                                                {editingId === b.id ? (
                                                    <div className="flex flex-col gap-2" onClick={e => e.stopPropagation()}>
                                                        <input className="simple-edit-input" value={tempTitle} onChange={e => setTempTitle(e.target.value)} autoFocus />
                                                        <div className="flex justify-center gap-2">
                                                            <button onClick={(e) => saveRename(e, b.id)} className="text-xs bg-white text-green-600 px-2 py-1 rounded font-bold"><i className="fas fa-check"></i></button>
                                                            <button onClick={(e) => {e.stopPropagation(); setEditingId(null);}} className="text-xs bg-white text-red-500 px-2 py-1 rounded font-bold"><i className="fas fa-times"></i></button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="flex flex-col items-center justify-center">
                                                        <h3 className="card-title truncate flex items-center gap-2">{b.title} <button className="text-sm opacity-60 hover:opacity-100" onClick={(e) => startRename(e, b)}><i className="fas fa-pencil-alt"></i></button></h3>
                                                        <span className="card-tag">EDITAR</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function ExternalToolView({ url, setView }) {
            return (
                <div className="w-full h-full bg-white relative flex flex-col">
                    <div className="h-14 bg-gray-800 flex items-center justify-between px-4 shadow-lg z-50">
                        <span className="text-white font-bold">Herramienta Externa</span>
                        <button onClick={() => setView('dashboard')} className="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded font-bold text-sm">CERRAR Y VOLVER</button>
                    </div>
                    <iframe src={url} className="flex-1 border-none w-full" title="Herramienta"></iframe>
                </div>
            );
        }

        // --- VISTA P√öBLICA (PORTAFOLIO) ---
        function PublicPortfolioView({ uid }) {
            const [portfolio, setPortfolio] = useState({});
            const [books, setBooks] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(!db) return;
                // Cargar datos
                const load = async () => {
                    // Portfolio (Moodboard/Storyboard)
                    onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', uid), (d) => {
                        if(d.exists()) setPortfolio(d.data());
                    });
                    // Libros
                    const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', uid, 'books'));
                    onSnapshot(q, (snap) => {
                        setBooks(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        setLoading(false);
                    });
                };
                load();
            }, [uid]);

            if(loading) return <div className="flex h-screen items-center justify-center">Cargando Portafolio...</div>;

            // Si hay libros, mostramos el primero en el visor grande
            const featuredBook = books.length > 0 ? books[0] : null;

            return (
                <div className="portfolio-container">
                    <div className="portfolio-header">
                        <h1 className="text-5xl font-bold kids-title mb-2">PORTAFOLIO CREATIVO</h1>
                        <p className="text-xl opacity-80 font-sans">Explorando el mundo de la narraci√≥n</p>
                    </div>

                    {/* 1. LIBRO DESTACADO */}
                    <div className="portfolio-section">
                        <h2 className="text-3xl text-center font-bold text-gray-700 mb-8 pop-title">MI LIBRO √ÅLBUM</h2>
                        <div className="bg-gray-200 rounded-3xl overflow-hidden shadow-2xl border-4 border-white" style={{height:'600px'}}>
                            {featuredBook ? (
                                <BookViewer pages={featuredBook.pages} activeIdx={-1} setActiveIdx={()=>{}} isEditor={false} />
                            ) : (
                                <div className="flex items-center justify-center h-full text-gray-400 font-bold">El estudiante a√∫n no ha publicado libros.</div>
                            )}
                        </div>
                    </div>

                    {/* 2. GALER√çA DE EVIDENCIAS */}
                    <div className="portfolio-section pb-20">
                        <h2 className="text-3xl text-center font-bold text-gray-700 mb-8 pop-title">PROCESO CREATIVO</h2>
                        <div className="portfolio-grid">
                            <div className="evidence-card">
                                <div className="evidence-title text-purple-600">MOODBOARD</div>
                                {portfolio.moodboard ? <img src={portfolio.moodboard} className="evidence-img" /> : <div className="evidence-img flex items-center justify-center text-gray-300">Sin entrega</div>}
                            </div>
                            <div className="evidence-card">
                                <div className="evidence-title text-orange-600">STORYBOARD</div>
                                {portfolio.storyboard ? <img src={portfolio.storyboard} className="evidence-img" /> : <div className="evidence-img flex items-center justify-center text-gray-300">Sin entrega</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- EDITOR PRINCIPAL ---
        function Editor({ user, setView }) {
            const [book, setBook] = useState(null);
            const [activeIdx, setActiveIdx] = useState(0); 

            useEffect(() => { const bid = localStorage.getItem('currentBookId'); if(!bid || !db) return; getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', bid)).then(snap => { if(snap.exists()) setBook({id: snap.id, ...snap.data()}); }); }, []);
            const save = async () => { try { await updateDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', book.id), { pages: book.pages, title: book.title }); alert("¬°GUARDADO!"); } catch (e) { alert("Error guardando."); } };
            const handlePageUpdate = (idx, side, field, val) => { const newPages = [...book.pages]; newPages[idx][side][field] = val; setBook({...book, pages: newPages}); };
            const addPage = () => { const np = [...book.pages]; np.splice(np.length-1, 0, { id: Date.now(), type: 'content', front: { type: 'image-page', bg: '' }, back: { type: 'image-page', bg: '' } }); setBook({...book, pages: np}); };

            if(!book) return <div className="flex h-screen items-center justify-center font-bold text-xl text-gray-400">ABRIENDO...</div>;

            return (
                <div className="flex h-full w-full relative overflow-hidden">
                    <div className="sidebar-studio">
                        <div className="icon-chunk btn-grape" onClick={()=>setView('dashboard')} data-tooltip="Inicio"><i className="fas fa-home"></i></div>
                        <div className="icon-chunk btn-lime" onClick={save} data-tooltip="Guardar"><i className="fas fa-save"></i></div>
                        <div className="mt-auto">
                            <div className="icon-chunk btn-orange" onClick={addPage} data-tooltip="Agregar P√°gina"><i className="fas fa-plus"></i></div>
                        </div>
                    </div>
                    <div className="canvas-grid editor-mode">
                        <BookViewer pages={book.pages} activeIdx={activeIdx} setActiveIdx={setActiveIdx} isEditor={true} onUpdatePage={handlePageUpdate} />
                    </div>
                </div>
            );
        }

        // --- COMPONENTE DEL LIBRO (REUTILIZABLE) ---
        function BookViewer({ pages, activeIdx, setActiveIdx, isEditor, onUpdatePage }) {
            const audioRef = useRef(null);
            // Estado local para visor p√∫blico si no se pasa control externo
            const [localIdx, setLocalIdx] = useState(activeIdx);
            const currentIdx = isEditor ? activeIdx : localIdx;
            
            const isOpen = currentIdx >= 0 && currentIdx < pages.length - 1;
            const isClosedBack = currentIdx === pages.length - 1;

            const changePage = (newIdx) => { 
                if(audioRef.current) { audioRef.current.currentTime=0; audioRef.current.play().catch(()=>{}); } 
                if(isEditor) setActiveIdx(newIdx); else setLocalIdx(newIdx);
            };
            
            // Teclado
            useEffect(() => {
                const handleKeyDown = (e) => { 
                    if (e.key === "ArrowRight" && currentIdx < pages.length-1) changePage(currentIdx+1); 
                    if (e.key === "ArrowLeft" && currentIdx >= 0) changePage(currentIdx-1); 
                };
                window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentIdx, pages]);

            const isEditableImage = (idx, side) => { if (idx === 1 && side === 'back') return false; if (idx === 2) return false; return true; };
            const isEditableTitle = (idx, side) => { if (idx === 2) return false; return true; };
            const isEditableText = (idx, side) => { if (idx === 1 && side === 'back') return false; return true; };

            const renderEditOverlay = (pageIdx, side, currentBg) => {
                if (!isEditor || !isEditableImage(pageIdx, side)) return null;
                return (
                    <div className="edit-overlay">
                        <div className="upload-card">
                            <label className="btn-gummy btn-pink" style={{width:'100%', fontSize:'0.9rem', padding:'8px'}}>
                                <i className="fas fa-camera mr-2"></i> {currentBg ? 'Cambiar' : 'Subir'}
                                <input type="file" accept="image/*" className="hidden" onChange={(e) => {
                                    const file = e.target.files[0]; if(file) processImage(file, (base64) => onUpdatePage(pageIdx, side, 'bg', base64));
                                }} />
                            </label>
                            <input className="input-pop" placeholder="O pega enlace..." value={currentBg && currentBg.startsWith('http') ? currentBg : ''} onClick={(e) => e.stopPropagation()} onChange={(e) => onUpdatePage(pageIdx, side, 'bg', e.target.value)} style={{fontSize:'0.8rem', marginTop:'10px'}} />
                            {currentBg && <button className="remove-btn" onClick={(e) => { e.stopPropagation(); onUpdatePage(pageIdx, side, 'bg', ''); }}>BORRAR IMAGEN</button>}
                        </div>
                    </div>
                );
            };

            return (
                <div style={{width:'100%', height:'100%', display:'flex', justifyContent:'center', alignItems:'center', position:'relative'}}>
                    <audio ref={audioRef} src="https://raw.githubusercontent.com/libroalbum/libro-lbum-pedag-gico/main/images/sonido%20deslizar.mp3"></audio>
                    <div id="stage">
                        <div className={`book ${isOpen ? 'opened' : ''} ${isClosedBack ? 'closed-back' : ''}`}>
                            {pages.map((p, i) => {
                                const zIndex = currentIdx >= i ? i + 1 : pages.length - i;
                                return (
                                    <div key={p.id} className={`paper ${i <= currentIdx ? 'flipped' : ''}`} style={{zIndex}}>
                                        <div className={`front ${p.front.type}`} style={p.front.bg ? {backgroundImage:`url(${p.front.bg})`}:{}}>
                                            {renderEditOverlay(i, 'front', p.front.bg)}
                                            {p.front.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center relative z-10">
                                                    <input disabled={!isEditor || !isEditableTitle(i, 'front')} value={p.front.title} onChange={(e)=>onUpdatePage(i, 'front', 'title', e.target.value)} className="inline-input-title" />
                                                    <textarea disabled={!isEditor || !isEditableText(i, 'front')} value={p.front.text} onChange={(e)=>onUpdatePage(i, 'front', 'text', e.target.value)} className="inline-input-text" rows="6" />
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2}</span>}
                                        </div>
                                        <div className={`back ${p.back.type}`} style={p.back.bg ? {backgroundImage:`url(${p.back.bg})`}:{}}>
                                            {renderEditOverlay(i, 'back', p.back.bg)}
                                            {p.back.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center relative z-10">
                                                    <input disabled={!isEditor || !isEditableTitle(i, 'back')} value={p.back.title} onChange={(e)=>onUpdatePage(i, 'back', 'title', e.target.value)} className="inline-input-title" />
                                                    <textarea disabled={!isEditor || !isEditableText(i, 'back')} value={p.back.text} onChange={(e)=>onUpdatePage(i, 'back', 'text', e.target.value)} className="inline-input-text" rows="6" />
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2+1}</span>}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                    {currentIdx >= 0 && <button className="nav-btn prev-btn" onClick={() => changePage(currentIdx - 1)}><i className="fas fa-chevron-left"></i></button>}
                    {currentIdx < pages.length - 1 && <button className="nav-btn next-btn" onClick={() => changePage(currentIdx + 1)}><i className="fas fa-chevron-right"></i></button>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
