<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libro √Ålbum Digital Pedag√≥gico</title>
    
    <!-- LIBRER√çAS DE ESTILO Y FUENTES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <!-- LIBRER√çAS REACT -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- ESTILOS DE LA REVISTA (LIENZO) --- */
        :root {
            --book-width: 460px;
            --book-height: 600px;
            --bg-color: #BDBDBD; 
            --paper-texture: #fdfbf7;
            --text-color: #2c3e50;
            --accent-color: #5d4037;
            --gold-color: #d4af37;
            --endpaper-bg: #a5d6a7; 
            --endpaper-dot: #ffffff; 
        }

        /* Lienzo de Trabajo */
        .canvas-area {
            background-color: var(--bg-color);
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ESCENARIO 3D */
        #stage {
            perspective: 2500px;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.5s ease;
            transform-style: preserve-3d;
        }

        .book {
            position: relative;
            width: var(--book-width);
            height: var(--book-height);
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
        }

        .book::before {
            content: ''; position: absolute; z-index: -1;
            width: 96%; height: 96%; left: 5%; top: 5%;
            background: rgba(0,0,0,0.4); filter: blur(25px); border-radius: 20px;
            transition: all 0.8s ease-in-out; opacity: 0.7;
        }
        .book.opened { transform: translateX(50%); }
        .book.opened::before { width: 196%; left: -95%; opacity: 0.5; background: rgba(0,0,0,0.3); }
        .book.closed-back { transform: translateX(100%); }
        .book.closed-back::before { width: 96%; left: -99%; }

        /* HOJAS */
        .paper {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            transform-origin: left center;
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
            transform-style: preserve-3d;
        }
        .paper.flipped { transform: rotateY(-180deg); z-index: 0; }

        .front, .back {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            background-color: var(--paper-texture);
            backface-visibility: hidden; overflow: hidden;
            border-radius: 2px 5px 5px 2px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
        .front { z-index: 2; border-right: 1px solid rgba(0,0,0,0.1); }
        .back { z-index: 1; transform: rotateY(180deg); border-left: 1px solid rgba(0,0,0,0.1); border-radius: 5px 2px 2px 5px; }

        /* Estilos Internos */
        .image-page { background-size: cover; background-position: center; background-color: #fff; position: relative; }
        .text-page { background-color: #fffefae6; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; }
        .text-page h2 { font-family: 'Cinzel', serif; color: var(--accent-color); font-size: 1.4rem; margin-bottom: 25px; border-bottom: 1px solid var(--gold-color); padding-bottom: 10px; }
        .text-page p { font-family: 'Merriweather', serif; font-size: 0.95rem; line-height: 1.8; color: #555; font-style: italic; white-space: pre-wrap; }
        .endpaper { background-color: var(--endpaper-bg); background-image: radial-gradient(var(--endpaper-dot) 1.5px, transparent 1.5px), radial-gradient(var(--endpaper-dot) 1.5px, transparent 1.5px); background-size: 20px 20px; }
        .page-number { position: absolute; bottom: 20px; font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-color); font-weight: bold; pointer-events: none; }
        .front .page-number { right: 20px; }
        .back .page-number { left: 20px; }

        /* OVERLAY DE EDICI√ìN (NUEVO) */
        .edit-overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
            z-index: 100;
        }
        /* Mostrar overlay al pasar el mouse SOLO si es modo editor */
        .canvas-area.editor-mode .image-page:hover .edit-overlay { opacity: 1; }

        .upload-btn {
            background: #fff; color: #5d4037; 
            padding: 10px 20px; border-radius: 30px; 
            font-family: 'Cinzel', serif; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 8px;
            transition: transform 0.2s;
        }
        .upload-btn:hover { transform: scale(1.05); background: #fdfbf7; color: #d4af37; }
        
        .url-input {
            margin-top: 10px; padding: 5px 10px; border-radius: 5px; border: none; 
            font-size: 0.7rem; width: 80%; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Capa Pedag√≥gica */
        .pedagogical-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 20px; }
        .ped-cloud { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 10px; max-width: 200px; opacity: 0; transform: translateY(20px); transition: 0.5s; border: 1px solid #ddd; }
        .ped-cloud.active { opacity: 1; transform: translateY(0); }
        .ped-cloud h3 { font-family: 'Cinzel', serif; color: var(--accent-color); font-size: 0.9rem; border-bottom: 2px solid var(--gold-color); margin-bottom: 5px; display: inline-block; }
        .ped-cloud p { font-family: 'Lato', sans-serif; font-size: 0.8rem; color: #666; }
        .ped-character { width: 100px; transition: 0.5s; opacity: 0; transform: translateY(20px); }
        .ped-character.active { opacity: 1; transform: translateY(0); }

        /* Controles Lienzo */
        .canvas-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 60; }
        .canvas-btn { background: rgba(255,255,255,0.9); border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s; color: #5d4037; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .canvas-btn:hover:not(:disabled) { transform: scale(1.1); background: #fff; color: #d4af37; }
        .canvas-btn:disabled { opacity: 0.5; cursor: default; }

        @media (max-width: 900px) {
            :root { --book-width: 44vw; --book-height: calc(44vw * 1.35); }
            #stage { perspective: 1200px; }
            .canvas-btn { width: 40px; height: 40px; font-size: 1rem; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // --- CLAVES FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAThH-edUt4Ep9BR-Xuy5Zjmgl9Nky1keU",
            authDomain: "libroalbum.firebaseapp.com",
            projectId: "libroalbum",
            storageBucket: "libroalbum.firebasestorage.app",
            messagingSenderId: "395438498580",
            appId: "1:395438498580:web:9b9fa76328fb034dee9801",
            measurementId: "G-C9LFEFG2Z0"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase Error", e); }

        // --- UTILS: PROCESAR IMAGEN ---
        const processImage = (file, callback) => {
            if (!file) return;
            if (file.size > 2000000) { if(!confirm("La imagen es grande. ¬øContinuar?")) return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // --- PLANTILLA MAESTRA ---
        const MASTER_TEMPLATE = {
            title: "Mi Revista Digital",
            pages: [
                { id: 'c1', type: 'structure', front: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/portada%20forntal.PNG?raw=true', tooltip: {title:"Portada", text:"La cara de tu revista."} }, back: { type: 'endpaper', tooltip: {title:"Guardas", text:"El interior de la tapa."} } },
                { id: 'c2', type: 'structure', front: { type: 'endpaper', tooltip: {title:"Guardas", text:"Transici√≥n."} }, back: { type: 'text-page', title: 'Hoja de Respeto', text: '(T√≠tulo de la Obra)', tooltip: {title:"Respeto", text:"Espacio para el t√≠tulo."} } },
                { id: 'c3', type: 'structure', front: { type: 'text-page', title: 'Cr√©ditos', text: 'Autor: Tu Nombre\nA√±o: 2024', tooltip: {title:"Cr√©ditos", text:"Datos legales."} }, back: { type: 'text-page', title: 'Dedicatoria', text: 'Para...', tooltip: {title:"Dedicatoria", text:"Un mensaje especial."} } },
                { id: 'p1', type: 'content', front: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/1x.png?raw=true', tooltip: {title:"Historia", text:"Inicio del cuento."} }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/pg2.jpg?raw=true', tooltip: {title:"Continuidad", text:"Sigue la acci√≥n."} } },
                { id: 'end', type: 'structure', front: { type: 'endpaper', tooltip: {title:"Fin", text:"Cierre."} }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/contraportada.jpg?raw=true', tooltip: {title:"Contraportada", text:"El final externo."} } }
            ]
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('loading'); 
            const [publicBook, setPublicBook] = useState(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const sharedUid = params.get('uid');
                const sharedBookId = params.get('book');

                if (sharedUid && sharedBookId) {
                    if(db) {
                        getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', sharedUid, 'books', sharedBookId))
                            .then(snap => {
                                if(snap.exists()) { setPublicBook({ id: snap.id, ...snap.data() }); setView('public-viewer'); }
                                else { alert("El libro no existe."); setView('login'); }
                            });
                    }
                } else {
                    if (auth) { onAuthStateChanged(auth, (u) => { setUser(u); setView(u ? 'dashboard' : 'login'); }); }
                }
            }, []);

            if (view === 'public-viewer' && publicBook) return <PublicViewer book={publicBook} />;
            if (view === 'loading') return <div className="flex h-screen items-center justify-center">Cargando...</div>;

            return (
                <div className="flex flex-col h-full font-sans">
                    {user && view !== 'editor' && (
                        <header className="bg-white shadow px-6 py-3 flex justify-between items-center z-50">
                            <h1 className="font-bold text-xl text-amber-800">Plataforma Pedag√≥gica</h1>
                            <div className="flex gap-4">
                                <span className="text-sm text-gray-500 pt-1">{user.email}</span>
                                <button onClick={() => signOut(auth)} className="text-red-500 hover:text-red-700 font-bold text-sm">Salir</button>
                            </div>
                        </header>
                    )}
                    <main className="flex-1 relative overflow-hidden bg-gray-100">
                        {view === 'login' && <LoginScreen setUser={setUser} setView={setView} />}
                        {view === 'dashboard' && <Dashboard user={user} setView={setView} />}
                        {view === 'editor' && <Editor user={user} setView={setView} />}
                    </main>
                </div>
            );
        }

        function LoginScreen({ setUser, setView }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegister, setIsRegister] = useState(false);
            const handleAuth = async (e) => {
                e.preventDefault();
                try {
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (err) { alert(err.message); }
            };
            return (
                <div className="flex items-center justify-center h-full">
                    <div className="bg-white p-8 rounded shadow-lg max-w-md w-full border-t-4 border-amber-800">
                        <h2 className="text-2xl font-bold text-center mb-4 text-amber-900">{isRegister ? 'Registro' : 'Iniciar Sesi√≥n'}</h2>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input className="w-full p-2 border rounded" placeholder="Correo" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <input className="w-full p-2 border rounded" type="password" placeholder="Contrase√±a" value={password} onChange={e=>setPassword(e.target.value)} required />
                            <button className="w-full bg-amber-800 text-white py-2 rounded font-bold hover:bg-amber-900">{isRegister ? 'Registrarse' : 'Entrar'}</button>
                        </form>
                        <p className="text-center mt-3 text-sm text-blue-600 cursor-pointer" onClick={()=>setIsRegister(!isRegister)}>{isRegister ? '¬øYa tienes cuenta? Entrar' : '¬øNo tienes cuenta? Registrarse'}</p>
                    </div>
                </div>
            );
        }

        function Dashboard({ user, setView }) {
            const [books, setBooks] = useState([]);
            useEffect(() => {
                if(!user || !db) return;
                const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books'));
                onSnapshot(q, (snap) => setBooks(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            }, [user]);
            const createNew = async () => {
                const ref = await addDoc(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books'), { ...MASTER_TEMPLATE, createdAt: new Date().toISOString() });
                localStorage.setItem('currentBookId', ref.id);
                setView('editor');
            };
            const openBook = (bookId) => {
                localStorage.setItem('currentBookId', bookId);
                setView('editor');
            };
            return (
                <div className="p-10 max-w-6xl mx-auto">
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-3xl font-bold text-gray-800">Mis Proyectos</h2>
                        <button onClick={createNew} className="bg-amber-700 text-white px-6 py-2 rounded shadow hover:bg-amber-800 font-bold flex items-center gap-2"><i className="fas fa-plus"></i> Crear Nuevo Libro</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {books.map(b => (
                            <div key={b.id} className="bg-white rounded-lg shadow overflow-hidden cursor-pointer hover:shadow-xl transition group" onClick={()=>openBook(b.id)}>
                                <div className="h-48 bg-gray-200 relative">
                                    {b.pages[0].front.bg && <img src={b.pages[0].front.bg} className="w-full h-full object-cover opacity-90 group-hover:scale-105 transition" />}
                                    <div className="absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-transparent transition"><i className="fas fa-book-open text-white text-4xl opacity-80"></i></div>
                                </div>
                                <div className="p-4 border-t"><h3 className="font-bold text-lg truncate">{b.title}</h3><p className="text-sm text-gray-500">{b.pages.length} p√°ginas</p></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- EDITOR ---
        function Editor({ user, setView }) {
            const [book, setBook] = useState(null);
            const [activeIdx, setActiveIdx] = useState(0); 
            const [selPageIdx, setSelPageIdx] = useState(0); 
            const [editSide, setEditSide] = useState('front');

            useEffect(() => {
                const bid = localStorage.getItem('currentBookId');
                if(!bid || !db) return;
                getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', bid)).then(snap => { if(snap.exists()) setBook({id: snap.id, ...snap.data()}); });
            }, []);

            const save = async () => {
                try { await updateDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', book.id), { pages: book.pages, title: book.title }); alert("¬°Guardado correctamente!"); } 
                catch (e) { alert("Error al guardar: La imagen puede ser muy pesada."); }
            };

            const share = () => {
                const url = `${window.location.origin}${window.location.pathname}?uid=${user.uid}&book=${book.id}`;
                navigator.clipboard.writeText(url);
                alert("¬°Enlace copiado! Comparte este link: " + url);
            };

            const handlePageUpdate = (idx, side, field, val) => {
                const newPages = [...book.pages];
                const page = newPages[idx][side];
                if (field === 'tooltipTitle') page.tooltip.title = val;
                else if (field === 'tooltipText') page.tooltip.text = val;
                else page[field] = val;
                setBook({...book, pages: newPages});
            };

            const addPage = () => {
                const np = [...book.pages];
                np.splice(np.length-1, 0, { id: Date.now(), type: 'content', front: { type: 'image-page', bg: '', tooltip: {title:"Nueva", text:"..."} }, back: { type: 'image-page', bg: '', tooltip: {title:"Nueva", text:"..."} } });
                setBook({...book, pages: np});
            };

            if(!book) return <div>Cargando editor...</div>;

            return (
                <div className="flex h-full">
                    {/* Panel Izquierdo (Textos y Estructura) */}
                    <div className="w-80 bg-white border-r flex flex-col z-20 shadow-xl overflow-hidden">
                        <div className="p-4 bg-amber-50 border-b border-amber-200">
                            <button onClick={()=>setView('dashboard')} className="text-xs text-gray-500 mb-2 hover:text-amber-800"><i className="fas fa-arrow-left"></i> Volver al panel</button>
                            <input className="w-full bg-transparent font-bold text-lg border-b border-amber-400 focus:outline-none mb-3" value={book.title} onChange={e=>setBook({...book, title: e.target.value})} />
                            <div className="flex gap-2">
                                <button onClick={save} className="flex-1 bg-green-600 text-white py-1 rounded text-sm hover:bg-green-700 shadow"><i className="fas fa-save"></i> Guardar</button>
                                <button onClick={share} className="flex-1 bg-blue-600 text-white py-1 rounded text-sm hover:bg-blue-700 shadow"><i className="fas fa-share-alt"></i> Compartir</button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            <h4 className="font-bold text-xs text-gray-400 uppercase mb-2">P√°gina {selPageIdx + 1}</h4>
                            <div className="flex bg-gray-100 p-1 rounded mb-4">
                                <button onClick={()=>setEditSide('front')} className={`flex-1 text-xs py-1 rounded ${editSide==='front'?'bg-white shadow font-bold text-amber-800':''}`}>Frente</button>
                                <button onClick={()=>setEditSide('back')} className={`flex-1 text-xs py-1 rounded ${editSide==='back'?'bg-white shadow font-bold text-amber-800':''}`}>Atr√°s</button>
                            </div>
                            {(() => {
                                const face = book.pages[selPageIdx][editSide];
                                if(face.type === 'endpaper') return <p className="text-xs text-gray-500 italic">P√°gina de estructura. No editable.</p>;
                                return (
                                    <div className="space-y-4">
                                        {face.type === 'image-page' && <p className="text-xs bg-blue-50 p-2 rounded text-blue-700">üí° <strong>Tip:</strong> Pasa el mouse sobre el libro para cambiar la imagen.</p>}
                                        {face.type === 'text-page' && (
                                            <>
                                                <div><label className="text-xs font-bold text-gray-600">T√≠tulo</label><input className="w-full border rounded p-1 text-sm" value={face.title} onChange={e=>handlePageUpdate(selPageIdx, editSide, 'title', e.target.value)} /></div>
                                                <div><label className="text-xs font-bold text-gray-600">Texto</label><textarea className="w-full border rounded p-1 text-sm" rows="4" value={face.text} onChange={e=>handlePageUpdate(selPageIdx, editSide, 'text', e.target.value)} /></div>
                                            </>
                                        )}
                                        <div className="bg-amber-50 p-2 rounded border border-amber-100 mt-4">
                                            <h5 className="text-xs font-bold text-amber-800 mb-2"><i className="fas fa-comment"></i> Gu√≠a Pedag√≥gica</h5>
                                            <input className="w-full border rounded p-1 text-xs mb-1" placeholder="T√≠tulo nube" value={face.tooltip?.title} onChange={e=>handlePageUpdate(selPageIdx, editSide, 'tooltipTitle', e.target.value)} />
                                            <textarea className="w-full border rounded p-1 text-xs" rows="2" placeholder="Texto nube" value={face.tooltip?.text} onChange={e=>handlePageUpdate(selPageIdx, editSide, 'tooltipText', e.target.value)} />
                                        </div>
                                    </div>
                                )
                            })()}
                            <hr className="my-6"/>
                            <button onClick={addPage} className="w-full py-2 border-2 border-dashed border-gray-300 text-gray-500 rounded hover:border-amber-500 hover:text-amber-600 text-xs font-bold">+ Agregar P√°gina al Libro</button>
                        </div>
                    </div>

                    {/* LIENZO */}
                    <div className="flex-1 bg-gray-200 relative flex flex-col">
                        <BookViewer pages={book.pages} activeIdx={activeIdx} setActiveIdx={(idx) => {
                                setActiveIdx(idx);
                                if(idx === -1) setSelPageIdx(0); 
                                else if(idx >= book.pages.length-1) setSelPageIdx(book.pages.length-1); 
                                else setSelPageIdx(idx); 
                            }} 
                            isEditor={true} 
                            onUpdatePage={handlePageUpdate} 
                        />
                    </div>
                </div>
            );
        }

        function PublicViewer({ book }) {
            const [activeIdx, setActiveIdx] = useState(-1);
            return <div className="h-screen w-screen bg-gray-800"><BookViewer pages={book.pages} activeIdx={activeIdx} setActiveIdx={setActiveIdx} isEditor={false} /></div>
        }

        // --- COMPONENTE DEL LIBRO ---
        function BookViewer({ pages, activeIdx, setActiveIdx, isEditor, onUpdatePage }) {
            const [showPed, setShowPed] = useState(false);
            const [pedData, setPedData] = useState({left:null, right:null});
            const audioRef = useRef(null);

            const isOpen = activeIdx >= 0 && activeIdx < pages.length - 1;
            const isClosedBack = activeIdx === pages.length - 1;

            const changePage = (newIdx) => {
                if(audioRef.current) { audioRef.current.currentTime=0; audioRef.current.play().catch(()=>{}); }
                setShowPed(false);
                setActiveIdx(newIdx);
                setTimeout(() => updatePedagogical(newIdx), 800);
            };

            const updatePedagogical = (idx) => {
                let left = null, right = null;
                if (idx === -1) { if(pages[0].front.tooltip) right = pages[0].front.tooltip; }
                else if (idx === pages.length - 1) { if(pages[pages.length-1].back.tooltip) left = pages[pages.length-1].back.tooltip; }
                else {
                    if(pages[idx].back.tooltip) left = pages[idx].back.tooltip;
                    if(pages[idx+1] && pages[idx+1].front.tooltip) right = pages[idx+1].front.tooltip;
                }
                setPedData({left, right});
                setShowPed(true);
            };

            useEffect(() => { setTimeout(() => updatePedagogical(activeIdx), 500); }, []);

            // Helper para renderizar Overlay de Edici√≥n en cada p√°gina
            const renderEditOverlay = (pageIdx, side) => {
                if (!isEditor) return null;
                return (
                    <div className="edit-overlay">
                        <label className="upload-btn">
                            <i className="fas fa-camera"></i> Reemplazar Imagen
                            <input type="file" accept="image/*" className="hidden" onChange={(e) => {
                                const file = e.target.files[0];
                                if(file) processImage(file, (base64) => onUpdatePage(pageIdx, side, 'bg', base64));
                            }} />
                        </label>
                        <input className="url-input" placeholder="O pega enlace aqu√≠..." 
                               onClick={(e) => e.stopPropagation()}
                               onChange={(e) => onUpdatePage(pageIdx, side, 'bg', e.target.value)} />
                    </div>
                );
            };

            return (
                <div className={`canvas-area ${isEditor ? 'editor-mode' : ''}`}>
                    <audio ref={audioRef} src="https://raw.githubusercontent.com/libroalbum/libro-lbum-pedag-gico/main/images/sonido%20deslizar.mp3"></audio>

                    <div id="stage">
                        <div className={`book ${isOpen ? 'opened' : ''} ${isClosedBack ? 'closed-back' : ''}`}>
                            {pages.map((p, i) => {
                                const zIndex = activeIdx >= i ? i + 1 : pages.length - i;
                                return (
                                    <div key={p.id} className={`paper ${i <= activeIdx ? 'flipped' : ''}`} style={{zIndex}}>
                                        <div className={`front ${p.front.type}`} style={p.front.bg ? {backgroundImage:`url(${p.front.bg})`}:{}}>
                                            {p.front.type==='image-page' && renderEditOverlay(i, 'front')}
                                            {p.front.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center">
                                                    <h2>{p.front.title}</h2><p dangerouslySetInnerHTML={{__html: p.front.text?.replace(/\n/g, '<br>')}}></p>
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2}</span>}
                                        </div>
                                        <div className={`back ${p.back.type}`} style={p.back.bg ? {backgroundImage:`url(${p.back.bg})`}:{}}>
                                            {p.back.type==='image-page' && renderEditOverlay(i, 'back')}
                                            {p.back.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center">
                                                    <h2>{p.back.title}</h2><p dangerouslySetInnerHTML={{__html: p.back.text?.replace(/\n/g, '<br>')}}></p>
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2+1}</span>}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    <div className="canvas-controls">
                        <button className="canvas-btn" disabled={activeIdx < -1} onClick={() => changePage(activeIdx - 1)}><i className="fas fa-chevron-left"></i></button>
                        <span className="bg-white/80 px-4 py-2 rounded-full font-bold text-sm text-gray-600 flex items-center">
                            {activeIdx === -1 ? 'Portada' : activeIdx === pages.length-1 ? 'Fin' : `P√°g ${activeIdx*2+1}-${activeIdx*2+2}`}
                        </span>
                        <button className="canvas-btn" disabled={activeIdx >= pages.length - 1} onClick={() => changePage(activeIdx + 1)}><i className="fas fa-chevron-right"></i></button>
                    </div>

                    <div className="pedagogical-layer">
                        <div className="flex flex-col items-end w-64 pb-20 pl-4">
                            <div className={`ped-cloud ${showPed && pedData.left ? 'active' : ''}`}><h3>{pedData.left?.title}</h3><p>{pedData.left?.text}</p></div>
                            <img src="https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/personaje%20izquierda.png?raw=true" className={`ped-character ${showPed && pedData.left ? 'active' : ''}`} />
                        </div>
                        <div className="flex flex-col items-start w-64 pt-20 pr-4 h-full justify-start mt-20">
                            <div className={`ped-cloud ${showPed && pedData.right ? 'active' : ''}`}><h3>{pedData.right?.title}</h3><p>{pedData.right?.text}</p></div>
                            <img src="https://github.com/libroalbum/libro-lbum-pedag-gico/blob/main/images/personaje%20derecha.png?raw=true" className={`ped-character ${showPed && pedData.right ? 'active' : ''}`} style={{transform:'scaleX(-1)'}} />
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
