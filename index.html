<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Studio - Album Lab</title>
    
    <!-- LIBRERÍAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=Dosis:wght@400;600;800&family=Cinzel:wght@700&family=Merriweather&family=Luckiest+Guy&display=swap" rel="stylesheet">

    <!-- REACT -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- 1. PALETA "NEON GLASS" (GEN Z AESTHETIC) --- */
        :root {
            /* Fondos con personalidad */
            --bg-main: #F3F4F6;
            --sidebar-bg: rgba(255, 255, 255, 0.85);
            
            /* Colores de Marca */
            --accent-primary: #6366f1; /* Indigo moderno */
            --accent-secondary: #ec4899; /* Pink pop */
            --accent-tertiary: #06b6d4; /* Cyan electric */
            --hot-orange: #F97316;
            --pop-pink: #EC4899;
            
            /* Sombras */
            --shadow-grape: #6D28D9;
            --shadow-lime: #4D7C0F;
            --shadow-cyan: #0097bd;
            --shadow-orange: #C2410C;
            --shadow-pink: #BE185D;

            --dark-text: #1e293b;
            --muted-text: #64748b;

            /* Variables Libro (INTACTAS) */
            --book-width: 460px; --book-height: 600px; --paper-texture: #fdfbf7; --text-color: #2c3e50; --accent-color: #5d4037; --gold-color: #d4af37; --endpaper-bg: #a5d6a7; --endpaper-dot: #ffffff; 
        }

        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        
        /* Fondo general */
        body { 
            font-family: 'Outfit', sans-serif; 
            color: var(--dark-text); 
            background-color: var(--bg-main);
        }
        
        /* Tipografía Jerárquica */
        h1, h2, .brand-title, .module-title, .pop-title { font-family: 'Dosis', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
        .kids-title { font-family: 'Luckiest Guy', cursive; letter-spacing: 1px; }
        .section-label { font-family: 'Outfit', sans-serif; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; font-size: 0.75rem; color: #94a3b8; margin-top: 1.5rem; margin-bottom: 0.5rem; padding-left: 1rem; }

        /* --- UI COMPONENTS MODERNOS --- */
        
        /* Glassmorphism Panels */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5); 
            border-radius: 24px; 
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.05); 
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .glass-panel:hover { box-shadow: 0 12px 40px rgba(31, 38, 135, 0.1); transform: translateY(-2px); }

        /* Botones "Pill" Modernos */
        .btn-modern, .btn-gummy { 
            border: none; outline: none; cursor: pointer; 
            font-family: 'Outfit', sans-serif; font-weight: 600; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            padding: 10px 24px; border-radius: 100px; 
            color: white; transition: all 0.2s ease; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-modern:hover, .btn-gummy:hover { transform: scale(1.03); filter: brightness(1.1); }
        .btn-modern:active, .btn-gummy:active { transform: scale(0.97); }
        
        .btn-grape { background: var(--hyper-grape); box-shadow: 0 4px 0 #6D28D9; }
        .btn-lime { background: var(--lime-punch); box-shadow: 0 4px 0 #4D7C0F; }
        .btn-cyan { background: var(--electric-cyan); box-shadow: 0 4px 0 #0097bd; }
        .btn-orange { background: var(--hot-orange); box-shadow: 0 4px 0 #C2410C; }
        .btn-pink { background: var(--pop-pink); box-shadow: 0 4px 0 #BE185D; }
        .btn-indigo { background: #6366f1; box-shadow: 0 4px 0 #4338ca; }
        
        .bg-gradient-primary { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .bg-gradient-accent { background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); }
        .bg-gradient-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bg-gradient-dark { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }

        /* --- LOGIN STYLES (SPLIT LAYOUT REDESIGN) --- */
        .login-split-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            background: white;
            overflow: hidden;
        }
        
        /* Lado Izquierdo: Imagen Inmersiva */
        .login-visual-side {
            flex: 1.2; /* Ocupa un poco más de la mitad en pantallas grandes */
            background-image: url('https://github.com/libroalbum/crear-libro-album-digital/blob/main/bienvenida.png?raw=true');
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        /* Overlay decorativo sobre la imagen para textos */
        .visual-overlay {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
            padding: 60px 40px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        /* Lado Derecho: Contenido y Formulario */
        .login-form-side {
            flex: 0 0 500px; /* Ancho fijo óptimo para formularios */
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 60px;
            background-color: #ffffff;
            position: relative;
            overflow-y: auto;
        }

        .login-brand-title {
            font-family: 'Luckiest Guy', cursive;
            font-size: 3rem;
            color: var(--accent-primary);
            margin-bottom: 10px;
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .login-description {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .features-mini {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
        }
        .feature-pill {
            background: #f1f5f9;
            padding: 8px 15px;
            border-radius: 12px;
            font-size: 0.85rem;
            color: #475569;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .feature-pill i { color: var(--accent-secondary); }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
        }

        .input-field-clean { 
            width: 100%; padding: 14px 15px 14px 45px; 
            border: 2px solid #f1f5f9; border-radius: 12px; 
            font-family: 'Outfit', sans-serif; font-size: 1rem; color: #334155; 
            background: #f8fafc; transition: all 0.2s; 
        }
        .input-field-clean:focus { border-color: var(--accent-primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); outline: none; }
        
        .btn-login-clean { 
            background-color: #0284c7; color: white; 
            font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1rem; 
            padding: 14px; width: 100%; border-radius: 12px; 
            border: none; cursor: pointer; margin-top: 10px; 
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(2, 132, 199, 0.2); 
        }
        .btn-login-clean:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(2, 132, 199, 0.3); }

        /* RESPONSIVE LOGIN */
        @media (max-width: 900px) {
            .login-split-wrapper { flex-direction: column; }
            .login-visual-side { 
                flex: 0 0 30vh; /* La imagen ocupa el 30% de la altura en celular */
                order: -1; /* Asegura que la imagen vaya arriba */
            }
            .visual-overlay { padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); }
            .login-form-side { flex: 1; padding: 30px 20px; width: 100%; }
            .login-brand-title { font-size: 2.5rem; }
            .features-mini { flex-wrap: wrap; }
        }
        
        /* --- LAYOUT SIDEBAR --- */
        .classroom-container { display: flex; height: 100%; width: 100%; }
        .classroom-sidebar { 
            width: 280px; background: var(--sidebar-bg); 
            backdrop-filter: blur(10px); border-right: 1px solid rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; padding: 25px; z-index: 50; flex-shrink: 0; overflow-y: auto; 
        }
        .sidebar-logo { 
            font-family: 'Dosis', sans-serif; font-weight: 800; font-size: 1.8rem; 
            background: linear-gradient(to right, #6366f1, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 30px; text-align: left; letter-spacing: -1px;
        }
        
        .menu-item { 
            padding: 10px 16px; margin-bottom: 4px; border-radius: 12px; 
            cursor: pointer; font-weight: 500; color: #64748b; 
            display: flex; align-items: center; gap: 12px; transition: all 0.2s; 
            font-family: 'Outfit', sans-serif; font-size: 0.95rem; 
        }
        .menu-item:hover { background: white; color: var(--accent-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.03); transform: translateX(4px); }
        .menu-item.active { 
            background: var(--accent-primary); color: white; 
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); 
        }
        .menu-item.active i { color: white; }
        .menu-item i { width: 24px; text-align: center; font-size: 1.1rem; transition: 0.2s; }

        /* --- AJUSTE SOLICITADO: FONDO DEL TABLERO --- */
        .classroom-content { 
            flex: 1; 
            background-color: #F0F4F8; /* Nuevo color solicitado */
            overflow-y: auto; 
            padding: 30px 50px; 
            position: relative; 
        }
        
        /* Dashboard Grid System */
        .bento-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 20px; }
        .activity-card {
            background: white; border-radius: 20px; padding: 20px;
            border: 1px solid #f1f5f9; position: relative; overflow: hidden;
            transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; height: 220px;
        }
        .activity-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); border-color: var(--accent-primary); }
        .activity-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: var(--card-color, #cbd5e1); }
        .ac-icon { width: 50px; height: 50px; border-radius: 14px; background: #f8fafc; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--card-color); margin-bottom: 15px; }
        .ac-title { font-family: 'Dosis', sans-serif; font-weight: 700; font-size: 1.4rem; color: var(--dark-text); line-height: 1.1; }
        .ac-desc { font-size: 0.85rem; color: #94a3b8; margin-top: 5px; line-height: 1.4; }
        .ac-arrow { align-self: flex-end; width: 30px; height: 30px; border-radius: 50%; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; color: #cbd5e1; transition: 0.2s; }
        .activity-card:hover .ac-arrow { background: var(--card-color); border-color: var(--card-color); color: white; }

        /* --- TOP BAR PROFILE --- */
        .top-bar-glass { 
            position: sticky; top: 0; z-index: 40; 
            margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; 
            padding-bottom: 10px;
        }
        .page-header-title { font-size: 2rem; font-weight: 800; color: var(--dark-text); font-family: 'Dosis'; letter-spacing: -1px; }
        
        .user-chip { display: flex; align-items: center; gap: 12px; background: white; padding: 6px 8px 6px 15px; border-radius: 50px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .user-chip:hover { transform: translateY(-2px); border-color: var(--accent-primary); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #e2e8f0; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-info { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.1; margin-right: 5px; }
        .user-name { font-weight: 700; font-size: 0.9rem; color: var(--dark-text); font-family: 'Outfit'; }
        .user-role { font-size: 0.7rem; color: var(--accent-primary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- EDITOR STYLES (Canvas) --- */
        .canvas-grid { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background-color: #2b2d42; background-image: radial-gradient(#3d405b 1px, transparent 1px); background-size: 30px 30px; width: 100%; height: 100%; }
        .sidebar-editor { width: 70px; height: 100%; background: #1e1e24; border-right: 1px solid #333; display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 40; gap: 15px; flex-shrink: 0; }
        .icon-chunk { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.1); }
        .icon-chunk:hover { background: var(--accent-primary); transform: scale(1.1); }
        
        /* ESTILOS DEL LIBRO */
        #stage { perspective: 2500px; display: flex; align-items: center; justify-content: center; transition: transform 0.5s ease; transform-style: preserve-3d; }
        .book { position: relative; width: var(--book-width); height: var(--book-height); transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .book::before { content: ''; position: absolute; z-index: -1; width: 96%; height: 96%; left: 5%; top: 5%; background: rgba(0,0,0,0.2); filter: blur(20px); border-radius: 20px; transition: all 0.8s ease-in-out; opacity: 0.5; }
        .book.opened { transform: translateX(50%); } .book.opened::before { width: 196%; left: -95%; opacity: 0.4; background: rgba(0,0,0,0.15); } .book.closed-back { transform: translateX(100%); } .book.closed-back::before { width: 96%; left: -99%; }
        .paper { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: left center; transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1); transform-style: preserve-3d; }
        .paper.flipped { transform: rotateY(-180deg); z-index: 0; }
        .front, .back { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background-color: var(--paper-texture); backface-visibility: hidden; overflow: hidden; border-radius: 2px 5px 5px 2px; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .front { z-index: 2; border-right: 1px solid rgba(0,0,0,0.1); } .back { z-index: 1; transform: rotateY(180deg); border-left: 1px solid rgba(0,0,0,0.1); border-radius: 5px 2px 2px 5px; }
        .front::after { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 25px; background: linear-gradient(to right, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%); pointer-events: none; z-index: 10; }
        .back::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 25px; background: linear-gradient(to left, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0) 100%); pointer-events: none; z-index: 10; }
        .image-page { background-size: cover; background-position: center; background-color: #fff; }
        .text-page { background-color: #fffefae6; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; }
        .inline-input-title { font-family: 'Cinzel', serif; color: var(--accent-color); font-size: 1.4rem; background: transparent; border: 1px dashed transparent; text-align: center; width: 100%; margin-bottom: 5px; outline: none; padding: 5px; border-bottom: 2px solid var(--gold-color); }
        .inline-input-text { font-family: 'Merriweather', serif; font-size: 0.95rem; line-height: 1.8; color: #555; font-style: italic; background: transparent; border: 1px dashed transparent; text-align: center; width: 100%; outline: none; resize: none; overflow: hidden; padding: 5px; }
        .endpaper { background-color: var(--endpaper-bg); background-size: cover; background-position: center; background-repeat: no-repeat; }
        .page-number { position: absolute; bottom: 20px; font-family: 'Cinzel', serif; font-size: 12px; color: var(--text-color); font-weight: bold; pointer-events: none; }
        .front .page-number { right: 20px; } .back .page-number { left: 20px; }

        /* Overlays Editor */
        .edit-overlay { position: absolute; inset: 0; background: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(4px); z-index: 20; }
        .editor-mode .front:hover .edit-overlay, .editor-mode .back:hover .edit-overlay { opacity: 1; }
        .nav-btn { position: fixed; top: 50%; transform: translateY(-50%); width: 50px; height: 50px; border-radius: 50%; background: white; border: none; color: var(--dark-text); font-size: 1.2rem; cursor: pointer; transition: 0.2s; z-index: 90; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .nav-btn:hover { transform: translateY(-55%) scale(1.1); background: var(--accent-primary); color: white; }
        .prev-btn { left: 40px; } .next-btn { right: 40px; }
        
        /* Modal y Overlays Generales */
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); text-align: center; animation: floatUp 0.3s ease-out; }
        
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ESTILOS RESPONSIVOS MÓVIL --- */
        @media (max-width: 900px) {
            :root { --book-width: 35vw; --book-height: calc(35vw * 1.35); }
            .classroom-container { flex-direction: column; }
            .classroom-sidebar { 
                width: 100%; height: auto; flex-direction: row; overflow-x: auto; 
                padding: 10px; border-right: none; border-bottom: 1px solid #e2e8f0; 
                background: white; gap: 10px; align-items: center;
            }
            .sidebar-logo { display: none; }
            .menu-item { margin-bottom: 0; white-space: nowrap; font-size: 0.85rem; padding: 8px 12px; flex-shrink: 0; }
            .section-label { display: none; } /* Ocultar etiquetas en móvil */
            .classroom-content { padding: 15px; }
            .bento-grid { grid-template-columns: 1fr; }
            .user-info { display: none; }
            .user-avatar { width: 32px; height: 32px; }
            #stage { transform: scale(1); }
            .book-showcase { height: 300px; }
            .nav-btn { width: 35px; height: 35px; font-size: 0.9rem; }
            .prev-btn { left: 5px; } .next-btn { right: 5px; }
        }
    </style>
</head>
<body>
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const { useState, useEffect, useRef } = React;

        // FIREBASE CONFIG (TU LLAVE)
        const firebaseConfig = {
            apiKey: "AIzaSyAThH-edUt4Ep9BR-Xuy5Zjmgl9Nky1keU",
            authDomain: "libroalbum.firebaseapp.com",
            projectId: "libroalbum",
            storageBucket: "libroalbum.firebasestorage.app",
            messagingSenderId: "395438498580",
            appId: "1:395438498580:web:9b9fa76328fb034dee9801",
            measurementId: "G-C9LFEFG2Z0"
        };

        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error(e); }

        // --- UTILS ---
        const processImage = (file, callback) => {
            if (!file) return;
            if (file.size > 2000000) { if(!confirm("Imagen grande. ¿Seguir?")) return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800; let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.8));
                }; img.src = e.target.result;
            }; reader.readAsDataURL(file);
        };

        // --- MASTER TEMPLATE ---
        const MASTER_TEMPLATE = {
            title: "Nuevo Libro",
            pages: [
                { 
                    id: 'c1', 
                    type: 'structure', 
                    front: { type: 'image-page', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20portada.png?raw=true' }, 
                    back: { type: 'endpaper', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20paginas%20guardas.png?raw=true' } 
                },
                { 
                    id: 'c2', 
                    type: 'structure', 
                    front: { type: 'endpaper', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20paginas%20guardas.png?raw=true' }, 
                    back: { type: 'text-page', title: 'Hoja de Respeto', text: '(Título de la Obra)' } 
                },
                { id: 'c3', type: 'structure', front: { type: 'text-page', title: 'Créditos', text: 'Autor: Tu Nombre\nAño: 2024' }, back: { type: 'text-page', title: 'Dedicatoria', text: 'Para...' } },
                { id: 'p1', type: 'content', front: { type: 'image-page', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20cuerpo.png?raw=true' }, back: { type: 'image-page', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20cuerpo.png?raw=true' } },
                { 
                    id: 'end', 
                    type: 'structure', 
                    front: { type: 'endpaper', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20paginas%20guardas.png?raw=true' }, 
                    back: { type: 'image-page', bg: 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20contraportada.png?raw=true' } 
                }
            ]
        };

        // --- COMPONENTES (BOOKVIEWER) ---
        function BookViewer({ pages, activeIdx, setActiveIdx, isEditor, onUpdatePage }) {
            const audioRef = useRef(null);
            const [localIdx, setLocalIdx] = useState(activeIdx); 
            const currentIdx = isEditor ? activeIdx : localIdx;
            const isOpen = currentIdx >= 0 && currentIdx < pages.length - 1;
            const isClosedBack = currentIdx === pages.length - 1;
            const changePage = (newIdx) => { if(audioRef.current) { audioRef.current.currentTime=0; audioRef.current.play().catch(()=>{}); } if(isEditor) setActiveIdx(newIdx); else setLocalIdx(newIdx); };
            
            useEffect(() => {
                const handleKeyDown = (e) => { 
                    if (e.key === "ArrowRight" && currentIdx < pages.length-1) changePage(currentIdx+1); 
                    if (e.key === "ArrowLeft" && currentIdx >= 0) changePage(currentIdx-1); 
                };
                window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown);
            }, [currentIdx, pages]);

            const isEditableImage = (idx, side) => { if (idx === 1 && side === 'back') return false; if (idx === 2) return false; return true; };
            const isEditableTitle = (idx, side) => { if (idx === 2) return false; return true; };
            const isEditableText = (idx, side) => { if (idx === 1 && side === 'back') return false; return true; };

            const renderEditOverlay = (pageIdx, side, currentBg) => {
                if (!isEditor || !isEditableImage(pageIdx, side)) return null;
                return (
                    <div className="edit-overlay">
                        <div className="upload-card">
                            <label className="btn-modern bg-gradient-accent" style={{width:'100%', fontSize:'0.9rem', padding:'8px'}}>
                                <i className="fas fa-camera mr-2"></i> {currentBg ? 'Cambiar' : 'Subir'}
                                <input type="file" accept="image/*" className="hidden" onChange={(e) => { const file = e.target.files[0]; if(file) processImage(file, (base64) => onUpdatePage(pageIdx, side, 'bg', base64)); }} />
                            </label>
                            <input className="input-field-clean" placeholder="O pega enlace..." value={currentBg && currentBg.startsWith('http') ? currentBg : ''} onClick={(e) => e.stopPropagation()} onChange={(e) => onUpdatePage(pageIdx, side, 'bg', e.target.value)} style={{fontSize:'0.8rem', marginTop:'10px', padding:'8px'}} />
                            {currentBg && <button className="remove-btn" style={{marginTop:'10px', color:'#ef4444', fontWeight:'bold'}} onClick={(e) => { e.stopPropagation(); onUpdatePage(pageIdx, side, 'bg', ''); }}>ELIMINAR</button>}
                        </div>
                    </div>
                );
            };

            return (
                <div style={{width:'100%', height:'100%', display:'flex', justifyContent:'center', alignItems:'center', position:'relative'}}>
                    <audio ref={audioRef} src="https://raw.githubusercontent.com/libroalbum/libro-lbum-pedag-gico/main/images/sonido%20deslizar.mp3"></audio>
                    <div id="stage">
                        <div className={`book ${isOpen ? 'opened' : ''} ${isClosedBack ? 'closed-back' : ''}`}>
                            {pages.map((p, i) => {
                                const zIndex = currentIdx >= i ? i + 1 : pages.length - i;
                                return (
                                    <div key={p.id} className={`paper ${i <= currentIdx ? 'flipped' : ''}`} style={{zIndex}}>
                                        <div className={`front ${p.front.type}`} style={p.front.bg ? {backgroundImage:`url(${p.front.bg})`}:{}}>
                                            {renderEditOverlay(i, 'front', p.front.bg)}
                                            {p.front.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center relative z-10">
                                                    <input disabled={!isEditor || !isEditableTitle(i, 'front')} value={p.front.title} onChange={(e)=>onUpdatePage(i, 'front', 'title', e.target.value)} className="inline-input-title" />
                                                    <textarea disabled={!isEditor || !isEditableText(i, 'front')} value={p.front.text} onChange={(e)=>onUpdatePage(i, 'front', 'text', e.target.value)} className="inline-input-text" rows="6" />
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2}</span>}
                                        </div>
                                        <div className={`back ${p.back.type}`} style={p.back.bg ? {backgroundImage:`url(${p.back.bg})`}:{}}>
                                            {renderEditOverlay(i, 'back', p.back.bg)}
                                            {p.back.type==='text-page' && (
                                                <div className="w-full h-full p-8 flex flex-col items-center justify-center relative z-10">
                                                    <input disabled={!isEditor || !isEditableTitle(i, 'back')} value={p.back.title} onChange={(e)=>onUpdatePage(i, 'back', 'title', e.target.value)} className="inline-input-title" />
                                                    <textarea disabled={!isEditor || !isEditableText(i, 'back')} value={p.back.text} onChange={(e)=>onUpdatePage(i, 'back', 'text', e.target.value)} className="inline-input-text" rows="6" />
                                                </div>
                                            )}
                                            {i>0 && i<pages.length-1 && <span className="page-number">{i*2+1}</span>}
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                    {currentIdx >= 0 && <button className="nav-btn prev-btn" onClick={() => changePage(currentIdx - 1)}><i className="fas fa-arrow-left"></i></button>}
                    {currentIdx < pages.length - 1 && <button className="nav-btn next-btn" onClick={() => changePage(currentIdx + 1)}><i className="fas fa-arrow-right"></i></button>}
                </div>
            );
        }

        // --- VISOR PÚBLICO (MODO INVITADO) ---
        function PublicActivityViewer({ activity }) {
            const [zoom, setZoom] = useState(1);
            const handleZoomIn = () => setZoom(p => Math.min(p + 0.1, 1.5));
            const handleZoomOut = () => setZoom(p => Math.max(p - 0.1, 0.5));
            const resetZoom = () => setZoom(1);

            const getTitle = () => {
                const map = {
                    'guia': "Libro Guía", 'reference_book': "Libro Guía",
                    'moodboard': "Moodboard", 'storyboard': "Storyboard",
                    'quiz': "Quiz Time", 'ficha': "Ficha Personajes", 
                    'ficha_personajes': "Ficha Personajes", 'ficha_narrativa': "Ficha Narrativa",
                    'padlet': "Muro Colaborativo", 'muro': "Muro Colaborativo"
                };
                return map[activity] || "Actividad";
            };

            const renderContent = () => {
                const iframeStyle = { width: `${100/zoom}%`, height: `${100/zoom}%`, transform: `scale(${zoom})`, transformOrigin: '0 0', transition: '0.2s' };
                const wrapperClass = "flex-1 bg-white rounded-2xl overflow-hidden shadow-lg border border-gray-200 relative";

                if(activity === 'guia' || activity === 'reference_book') 
                    return <div className={wrapperClass}><iframe src="https://libroalbum.github.io/libro-lbum-pedag-gico/" className="w-full h-full border-none"></iframe></div>;
                
                if(activity === 'moodboard') 
                    return <div className={wrapperClass}><div style={iframeStyle}><iframe src="https://libroalbum.github.io/mooboard/" className="w-full h-full border-none"></iframe></div></div>;
                
                if(activity === 'storyboard') 
                    return <div className={wrapperClass}><div style={iframeStyle}><iframe src="https://libroalbum.github.io/tablero/" className="w-full h-full border-none"></iframe></div></div>;
                
                if(activity === 'padlet' || activity === 'muro') 
                    return <div className={wrapperClass}><div style={iframeStyle}><iframe src="https://padlet.com/embed/kz78sfkwdm9abosj" className="w-full h-full border-none" allow="camera;microphone;geolocation;display-capture"></iframe></div></div>;

                if(activity === 'quiz') return (
                    <div className="flex-1 bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden relative group">
                        <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/Kahoot-1.png?raw=true" className="w-full h-full object-cover blur-sm opacity-50"/>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <a href="https://create.kahoot.it/share/quiz-interactivo/f8f5983d-25e9-44e7-aa46-eab37837811f" target="_blank" className="btn-modern bg-gradient-primary text-xl px-10 py-4"><i className="fas fa-play mr-2"></i> INICIAR QUIZ</a>
                        </div>
                    </div>
                );

                if(activity === 'ficha' || activity === 'ficha_personajes') return (
                    <div className="flex-1 bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden relative group">
                        <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20de%20personajes.png?raw=true" className="w-full h-full object-contain"/>
                        <div className="absolute inset-0 bg-black/10 flex items-center justify-center">
                            <a href="https://docs.google.com/forms/d/e/1FAIpQLSdeATljdt5PMVoLzJ1x6S7sItasYY9hW2aiClLJpE1Yr1OyQw/viewform" target="_blank" className="btn-modern bg-gradient-primary text-xl px-10 py-4"><i className="fas fa-pen mr-2"></i> COMPLETAR</a>
                        </div>
                    </div>
                );

                if(activity === 'ficha_narrativa') return (
                    <div className="flex-1 bg-white rounded-2xl shadow-lg border border-indigo-100 overflow-hidden relative group">
                        <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20narrativa.jpg?raw=true" className="w-full h-full object-cover blur-sm opacity-50"/>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <a href="https://www.canva.com/design/DAG4JQ_26mk/yYHgZbuApHUSdalSG2938g/view" target="_blank" className="btn-modern bg-gradient-primary text-xl px-10 py-4"><i className="fas fa-pen-nib mr-2"></i> RELLENAR FICHA</a>
                        </div>
                    </div>
                );

                return <div>404</div>;
            };

            return (
                <div className="h-screen w-full bg-gray-50 flex flex-col font-sans">
                    <div className="h-16 bg-white border-b shadow-sm sticky top-0 z-50 px-6 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <div className="font-bold text-xl text-indigo-600 tracking-tight">CREATOR STUDIO</div>
                            <span className="text-gray-300">/</span>
                            <div className="font-semibold text-gray-600 uppercase tracking-widest text-sm">{getTitle()}</div>
                        </div>
                        <div className="flex items-center gap-3">
                            {['moodboard','storyboard','padlet','muro'].includes(activity) && (
                                <div className="flex bg-gray-100 rounded-lg p-1 mr-4">
                                    <button onClick={handleZoomOut} className="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-white rounded-md transition"><i className="fas fa-minus"></i></button>
                                    <button onClick={resetZoom} className="px-2 text-xs font-bold text-gray-500">{Math.round(zoom*100)}%</button>
                                    <button onClick={handleZoomIn} className="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-white rounded-md transition"><i className="fas fa-plus"></i></button>
                                </div>
                            )}
                            <button onClick={() => window.location.href = window.location.pathname} className="btn-modern bg-gradient-primary text-xs px-4 py-2">REGISTRARME</button>
                        </div>
                    </div>
                    <div className="flex-1 p-6 overflow-hidden flex flex-col relative">
                        {renderContent()}
                    </div>
                </div>
            );
        }

        // --- EDITOR COMPONENT ---
        function Editor({ user, setView }) {
            const [book, setBook] = useState(null);
            const [activeIdx, setActiveIdx] = useState(-1); 
            
            useEffect(() => { 
                const bid = localStorage.getItem('currentBookId'); 
                if(!bid || !db) return; 
                getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', bid)).then(snap => { 
                    if(snap.exists()) setBook({id: snap.id, ...snap.data()}); 
                }); 
            }, []);

            const save = async () => { 
                try { 
                    // 1. Guardar copia de edición (Privada)
                    await updateDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', book.id), { pages: book.pages, title: book.title }); 
                    
                    // 2. PUBLICAR COPIA (Pública)
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), { 
                        featuredBookId: book.id,
                        publishedBook: { 
                            title: book.title,
                            pages: book.pages
                        }
                    }, { merge: true });

                    alert("¡GUARDADO Y PUBLICADO CORRECTAMENTE!"); 
                } catch (e) { alert("Error: " + e.message); } 
            };

            const resetBook = async () => {
                if(!confirm("¿Estás seguro de reiniciar el libro? Se perderán todos los cambios actuales.")) return;
                const resetState = { ...MASTER_TEMPLATE, createdAt: new Date().toISOString() }; 
                setBook({ id: book.id, ...resetState }); 
                try {
                    await updateDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books', book.id), resetState);
                    alert("¡Libro reiniciado a la plantilla original!");
                } catch(e) {
                    alert("Error al reiniciar: " + e.message);
                }
            };

            const handlePageUpdate = (idx, side, field, val) => { 
                const newPages = [...book.pages]; 
                newPages[idx][side][field] = val; 
                setBook({...book, pages: newPages}); 
            };

            const addPage = () => { 
                const np = [...book.pages]; 
                const bodyImg = 'https://github.com/libroalbum/crear-libro-album-digital/blob/main/plantilla%20cuerpo.png?raw=true';
                np.splice(np.length-1, 0, { 
                    id: Date.now(), 
                    type: 'content', 
                    front: { type: 'image-page', bg: bodyImg }, 
                    back: { type: 'image-page', bg: bodyImg } 
                }); 
                setBook({...book, pages: np}); 
            };

            if(!book) return <div className="flex h-full items-center justify-center text-white">Cargando Libro...</div>;

            return (
                <div className="flex h-full w-full relative overflow-hidden">
                    <div className="sidebar-editor">
                        <div className="icon-chunk" onClick={()=>setView('dashboard')} title="Volver"><i className="fas fa-arrow-left"></i></div>
                        <div className="icon-chunk" onClick={save} title="Guardar"><i className="fas fa-save text-green-400"></i></div>
                        <div className="icon-chunk" onClick={resetBook} title="Reiniciar Libro"><i className="fas fa-undo-alt text-red-400"></i></div>
                        <div className="mt-auto"><div className="icon-chunk" onClick={addPage} title="Agregar Página"><i className="fas fa-plus text-blue-400"></i></div></div>
                    </div>
                    <div className="canvas-grid editor-mode">
                        <BookViewer pages={book.pages} activeIdx={activeIdx} setActiveIdx={setActiveIdx} isEditor={true} onUpdatePage={handlePageUpdate} />
                    </div>
                </div>
            );
        }

        // --- PUBLIC GALLERY COMPONENT (Restaurado) ---
        function PublicGallery({ uid }) {
            const [portfolio, setPortfolio] = useState({});
            const [book, setBook] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProfile, setUserProfile] = useState({ name: 'Creador' });
            const [showGuide, setShowGuide] = useState(true); // Control de la burbuja

            useEffect(() => {
                if(!db) return;
                const load = async () => {
                    const docSnap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', uid));
                    if(docSnap.exists()) {
                        const data = docSnap.data();
                        setPortfolio(data);
                        
                        if (data.publishedBook) {
                            setBook(data.publishedBook);
                        } else if (data.featuredBookId) {
                            try {
                                const bookSnap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', uid, 'books', data.featuredBookId));
                                if(bookSnap.exists()) setBook({id: bookSnap.id, ...bookSnap.data()});
                            } catch(err) { console.log("No se pudo cargar libro privado", err); }
                        }
                    }
                    
                    const profileSnap = await getDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', uid, 'profile', 'user_info'));
                    if(profileSnap.exists()) setUserProfile(profileSnap.data());
                    
                    setLoading(false);
                }; 
                load();
            }, [uid]);

            if(loading) return <div className="flex h-screen items-center justify-center text-indigo-500 font-bold">Cargando Portafolio...</div>;

            return (
                <div className="h-full overflow-y-auto bg-gray-50 relative">

                    <div className="bg-white border-b shadow-sm sticky top-0 z-50 px-8 py-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-black text-gray-800 font-dosis">PORTAFOLIO</h1>
                            <p className="text-gray-500 text-sm">De: {userProfile.name}</p>
                        </div>
                        <button onClick={()=>window.location.href=window.location.pathname} className="btn-modern bg-gradient-primary text-xs px-4">CREAR MI CUENTA</button>
                    </div>

                    <div className="max-w-6xl mx-auto p-8">
                        <div className="bg-white rounded-3xl p-8 border border-gray-100 shadow-lg mb-8 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-20 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                            <div className="relative z-10">
                                <div className="w-full h-[500px] relative z-10">
                                    {book ? <div className="transform scale-90 origin-top h-full"><BookViewer pages={book.pages} activeIdx={-1} setActiveIdx={()=>{}} isEditor={false} /></div> : <div className="text-center text-gray-400 mt-20">Este creador aún no ha publicado su libro.</div>}
                                </div>
                            </div>
                        </div>

                        <h3 className="text-xl font-bold text-gray-400 uppercase tracking-widest mb-6">Galería de Evidencias</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="bg-white rounded-3xl p-6 border border-gray-200 shadow-md">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 bg-purple-100 text-purple-600 rounded-lg"><i className="fas fa-palette"></i></div>
                                    <h4 className="font-bold text-gray-700">Moodboard</h4>
                                </div>
                                <div className="aspect-video bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center">
                                    {portfolio.moodboard ? <img src={portfolio.moodboard} className="w-full h-full object-cover" /> : <span className="text-gray-400 text-sm">Sin evidencia</span>}
                                </div>
                            </div>
                            <div className="bg-white rounded-3xl p-6 border border-gray-200 shadow-md">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="p-2 bg-orange-100 text-orange-600 rounded-lg"><i className="fas fa-film"></i></div>
                                    <h4 className="font-bold text-gray-700">Storyboard</h4>
                                </div>
                                <div className="aspect-video bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center">
                                    {portfolio.storyboard ? <img src={portfolio.storyboard} className="w-full h-full object-cover" /> : <span className="text-gray-400 text-sm">Sin evidencia</span>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- LOGIN (REDESIGN SPLIT SCREEN) ---
        function LoginScreen({ setUser }) {
            const [email, setEmail] = useState(''); 
            const [password, setPassword] = useState(''); 
            const [isRegister, setIsRegister] = useState(false);
            const [isReset, setIsReset] = useState(false);

            const handleAuth = async (e) => { 
                e.preventDefault(); 
                try { 
                    if (isRegister) await createUserWithEmailAndPassword(auth, email, password); 
                    else await signInWithEmailAndPassword(auth, email, password); 
                } catch (err) { alert(err.message); } 
            };

            const handleReset = async (e) => {
                e.preventDefault();
                if (!email) return alert("Escribe tu correo.");
                try { await sendPasswordResetEmail(auth, email); alert("Revisa tu correo."); setIsReset(false); } catch (err) { alert(err.message); }
            };

            return (
                <div className="login-split-wrapper">
                    {/* Lado Izquierdo: Visual con Imagen */}
                    <div className="login-visual-side">
                        <div className="visual-overlay">
                            <h2 className="text-4xl font-bold font-dosis mb-2">Tu Imaginación no tiene límites</h2>
                            <p className="text-lg opacity-90 font-outfit">Crea, diseña y comparte tus historias con el mundo.</p>
                        </div>
                    </div>

                    {/* Lado Derecho: Formulario y Contenido */}
                    <div className="login-form-side">
                        <div className="w-full max-w-md">
                            <h1 className="login-brand-title">CREATOR STUDIO</h1>
                            <p className="login-description">
                                La plataforma definitiva para crear tu Libro Álbum Digital. 
                                <br/>Empieza tu aventura creativa ahora.
                            </p>

                            {/* Feature Badges */}
                            <div className="features-mini">
                                <div className="feature-pill"><i className="fas fa-magic"></i> Edición Fácil</div>
                                <div className="feature-pill"><i className="fas fa-palette"></i> Arte & Color</div>
                                <div className="feature-pill"><i className="fas fa-share-alt"></i> Compartir</div>
                            </div>
                            
                            {/* Login Box */}
                            <div className="login-box">
                                {isReset ? (
                                    <form onSubmit={handleReset} className="space-y-4">
                                        <input className="input-field-clean" placeholder="Tu correo para recuperar" value={email} onChange={e=>setEmail(e.target.value)} />
                                        <button className="btn-modern bg-gradient-primary w-full py-3 text-lg">Enviar Enlace</button>
                                        <div onClick={()=>setIsReset(false)} className="text-center text-gray-500 text-sm cursor-pointer hover:text-indigo-500 mt-4 font-bold">Cancelar</div>
                                    </form>
                                ) : (
                                    <form onSubmit={handleAuth} className="space-y-4">
                                        <div className="relative">
                                            <i className="fas fa-envelope absolute left-4 top-4 text-gray-400"></i>
                                            <input className="input-field-clean" placeholder="Correo electrónico" value={email} onChange={e=>setEmail(e.target.value)} />
                                        </div>
                                        <div className="relative">
                                            <i className="fas fa-lock absolute left-4 top-4 text-gray-400"></i>
                                            <input className="input-field-clean" type="password" placeholder="Contraseña" value={password} onChange={e=>setPassword(e.target.value)} />
                                        </div>
                                        
                                        <div className="text-right">
                                            <span className="text-xs text-indigo-500 font-bold cursor-pointer hover:underline" onClick={()=>setIsReset(true)}>¿Olvidaste tu contraseña?</span>
                                        </div>

                                        <button className="btn-modern bg-gradient-primary w-full py-3 text-lg shadow-lg mt-2">
                                            {isRegister ? 'Crear Cuenta Gratis' : 'Ingresar al Estudio'}
                                        </button>
                                        
                                        <div className="mt-6 text-center">
                                            <span className="text-sm text-indigo-600 cursor-pointer hover:text-indigo-800 font-bold border-b-2 border-indigo-100 hover:border-indigo-600 transition" onClick={()=>setIsRegister(!isRegister)}>
                                                {isRegister ? '¿Ya tienes cuenta? Inicia Sesión' : '¿Eres nuevo? Regístrate aquí'}
                                            </span>
                                        </div>
                                    </form>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD (ESTRUCTURA REDISEÑADA) ---
        function Dashboard({ user, setView }) {
            const [activeSection, setActiveSection] = useState('inicio');
            const [books, setBooks] = useState([]);
            const [portfolioData, setPortfolioData] = useState({});
            const [userProfile, setUserProfile] = useState({ name: user.email.split('@')[0], photo: '' });
            const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
            
            // Zoom states para las actividades embebidas
            const [zoom, setZoom] = useState(1);

            useEffect(() => { 
                if(!user) return; 
                const q = query(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books')); 
                onSnapshot(q, (snap) => setBooks(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), (doc) => { if(doc.exists()) setPortfolioData(doc.data()); });
                onSnapshot(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'profile', 'user_info'), (doc) => { if(doc.exists()) setUserProfile(doc.data()); });
            }, [user]);

            const saveProfile = async () => {
                await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'profile', 'user_info'), userProfile, { merge: true });
                setIsProfileModalOpen(false);
            };

            const handleProfilePic = (e) => {
                const file = e.target.files[0];
                if(file) processImage(file, (base64) => setUserProfile({...userProfile, photo: base64}));
            };

            const handleMyBook = async () => {
                if (books.length > 0) {
                    localStorage.setItem('currentBookId', books[0].id);
                    setView('editor');
                } else {
                    const ref = await addDoc(collection(db, 'artifacts', 'libroalbum-app', 'users', user.uid, 'books'), { ...MASTER_TEMPLATE, createdAt: new Date().toISOString() });
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), { featuredBookId: ref.id }, { merge: true });
                    localStorage.setItem('currentBookId', ref.id);
                    setView('editor');
                }
            };

            const uploadEvidence = (type, e) => {
                const file = e.target.files[0]; if(!file) return;
                processImage(file, async (base64) => {
                    await setDoc(doc(db, 'artifacts', 'libroalbum-app', 'portfolios', user.uid), { [type]: base64 }, { merge: true });
                    alert("¡Imagen actualizada!");
                });
            };

            // --- FUNCIÓN PARA OBTENER EL TÍTULO DINÁMICO EN LA BARRA SUPERIOR (MODIFICADO) ---
            const getSectionTitle = () => {
                const titles = {
                    'inicio': 'MI ESTUDIO',
                    'portafolio': 'MI PORTAFOLIO',
                    'reference_book': 'LIBRO GUÍA',
                    'moodboard': 'MOODBOARD',
                    'ficha_personajes': 'PERSONAJES',
                    'storyboard': 'STORYBOARD',
                    'ficha_narrativa': 'FICHA NARRATIVA',
                    'padlet': 'MURO SOCIAL',
                    'quiz': 'QUIZ TIME'
                };
                return titles[activeSection] || 'CREATOR STUDIO';
            };

            const getTitleColor = () => {
                // Todos los títulos usan el color primario
                return 'text-indigo-600';
            };

            const renderActivityContent = () => {
                const zoomControls = (
                    <div className="flex items-center gap-2 bg-white rounded-full px-3 py-1 border border-gray-200 shadow-sm ml-auto">
                        <button onClick={()=>setZoom(z=>Math.max(0.5, z-0.1))} className="text-gray-500 hover:text-indigo-600"><i className="fas fa-minus"></i></button>
                        <span className="text-xs font-bold w-8 text-center">{Math.round(zoom*100)}%</span>
                        <button onClick={()=>setZoom(z=>Math.min(1.5, z+0.1))} className="text-gray-500 hover:text-indigo-600"><i className="fas fa-plus"></i></button>
                    </div>
                );

                const frameStyle = { width: `${100/zoom}%`, height: `${100/zoom}%`, transform: `scale(${zoom})`, transformOrigin: '0 0' };
                const containerClass = "flex-1 bg-white rounded-3xl overflow-hidden shadow-sm border-4 relative h-full"; 

                switch(activeSection) {
                    case 'inicio':
                        return (
                            <div className="animate-fade-in">
                                <div className="glass-panel p-8 mb-8 flex flex-col md:flex-row gap-8 items-center">
                                    <div className="flex-1">
                                        <h2 className="text-3xl font-bold mb-4 text-gray-800">Bienvenido al Estudio, {userProfile.name}</h2>
                                        <p className="text-gray-600 mb-6 text-lg leading-relaxed">
                                            Este es tu espacio creativo profesional. Aquí tienes todas las herramientas para construir, diseñar y publicar tu propio Libro Álbum Digital. 
                                            <br/><br/>Empieza revisando el video introductorio o salta directo a una misión.
                                        </p>
                                        <button onClick={handleMyBook} className="btn-modern bg-gradient-primary text-lg px-8 py-3">
                                            <i className="fas fa-rocket mr-2"></i> {books.length > 0 ? 'Continuar mi Libro' : 'Crear Nuevo Libro'}
                                        </button>
                                    </div>
                                    <div className="w-full md:w-1/2 aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-white transform rotate-1 hover:rotate-0 transition duration-500">
                                        <iframe className="w-full h-full" src="https://www.youtube.com/embed/Ex037JX3-BI?si=rZx7OSizIczac_-8" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                                    </div>
                                </div>

                                <h3 className="text-xl font-bold text-gray-400 uppercase tracking-widest mb-4">Acceso Rápido a Misiones</h3>
                                <div className="bento-grid">
                                    <div className="activity-card" style={{'--card-color': '#8b5cf6'}} onClick={()=>setActiveSection('moodboard')}>
                                        <div><div className="ac-icon"><i className="fas fa-palette"></i></div><div className="ac-title">Moodboard</div><div className="ac-desc">Define el estilo visual.</div></div><div className="ac-arrow"><i className="fas fa-arrow-right"></i></div>
                                    </div>
                                    <div className="activity-card" style={{'--card-color': '#ec4899'}} onClick={()=>setActiveSection('ficha_personajes')}>
                                        <div><div className="ac-icon"><i className="fas fa-users"></i></div><div className="ac-title">Personajes</div><div className="ac-desc">Crea a tus protagonistas.</div></div><div className="ac-arrow"><i className="fas fa-arrow-right"></i></div>
                                    </div>
                                    <div className="activity-card" style={{'--card-color': '#f97316'}} onClick={()=>setActiveSection('storyboard')}>
                                        <div><div className="ac-icon"><i className="fas fa-film"></i></div><div className="ac-title">Storyboard</div><div className="ac-desc">Planea escena por escena.</div></div><div className="ac-arrow"><i className="fas fa-arrow-right"></i></div>
                                    </div>
                                    <div className="activity-card" style={{'--card-color': '#06b6d4'}} onClick={()=>setActiveSection('padlet')}>
                                        <div><div className="ac-icon"><i className="fas fa-comments"></i></div><div className="ac-title">Muro Social</div><div className="ac-desc">Comparte con la clase.</div></div><div className="ac-arrow"><i className="fas fa-arrow-right"></i></div>
                                    </div>
                                </div>
                            </div>
                        );
                    
                    case 'portafolio':
                        return (
                            <div className="h-full flex flex-col">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="page-header-title">MI PORTAFOLIO</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => window.open(`${window.location.origin}${window.location.pathname}?portfolio=${user.uid}`, '_blank')} className="btn-modern bg-white text-indigo-600 border border-indigo-100 text-xs shadow-sm hover:bg-indigo-50">
                                            <i className="fas fa-eye mr-2"></i> PREVISUALIZAR
                                        </button>
                                        <button onClick={()=>{navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?portfolio=${user.uid}`); alert("Link copiado")}} className="btn-modern bg-gradient-dark text-xs">
                                            <i className="fas fa-share-alt mr-2"></i> COMPARTIR
                                        </button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto pr-2">
                                    <div className="bg-white rounded-3xl p-8 border border-gray-100 shadow-sm mb-8 text-center relative overflow-hidden">
                                        <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                                        <div className="relative z-10">
                                            <div className="w-full max-w-4xl mx-auto h-[500px] mt-8 relative">
                                                {books.length > 0 ? (
                                                    <div className="transform scale-90 origin-top h-full"><BookViewer pages={books[0].pages} activeIdx={-1} setActiveIdx={()=>{}} isEditor={false} /></div>
                                                ) : <div className="h-full flex items-center justify-center text-gray-400">No has creado tu libro aún.</div>}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h3 className="text-xl font-bold text-gray-400 uppercase tracking-widest mb-4">Evidencias del Proceso</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
                                            <div className="bg-white rounded-2xl p-4 border border-gray-200 relative group cursor-pointer overflow-hidden h-80" onClick={()=>document.getElementById('upl-mood').click()}>
                                                <div className="absolute top-4 left-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-full text-xs font-bold z-10">MOODBOARD</div>
                                                {portfolioData.moodboard ? <img src={portfolioData.moodboard} className="w-full h-full object-cover rounded-xl"/> : <div className="w-full h-full flex items-center justify-center text-gray-300 font-bold">SUBIR IMAGEN</div>}
                                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i className="fas fa-upload text-white text-3xl"></i></div>
                                                <input type="file" id="upl-mood" className="hidden" onChange={(e)=>uploadEvidence('moodboard', e)}/>
                                            </div>
                                            <div className="bg-white rounded-2xl p-4 border border-gray-200 relative group cursor-pointer overflow-hidden h-80" onClick={()=>document.getElementById('upl-story').click()}>
                                                <div className="absolute top-4 left-4 bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold z-10">STORYBOARD</div>
                                                {portfolioData.storyboard ? <img src={portfolioData.storyboard} className="w-full h-full object-cover rounded-xl"/> : <div className="w-full h-full flex items-center justify-center text-gray-300 font-bold">SUBIR IMAGEN</div>}
                                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i className="fas fa-upload text-white text-3xl"></i></div>
                                                <input type="file" id="upl-story" className="hidden" onChange={(e)=>uploadEvidence('storyboard', e)}/>
                                            </div>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'reference_book':
                        return <div className="h-full flex flex-col"><div className="flex justify-between mb-2"><h2 className="page-header-title text-indigo-500">Libro Guía</h2></div><div className={containerClass}><iframe src="https://libroalbum.github.io/libro-lbum-pedag-gico/" className="w-full h-full border-none"></iframe></div></div>;
                    
                    case 'moodboard':
                        return <div className="h-full flex flex-col"><div className="flex justify-between mb-2"><h2 className="page-header-title text-purple-500">Moodboard</h2>{zoomControls}</div><div className={containerClass}><div style={frameStyle}><iframe src="https://libroalbum.github.io/mooboard/" className="w-full h-full border-none"></iframe></div></div></div>;
                    
                    case 'storyboard':
                        return <div className="h-full flex flex-col"><div className="flex justify-between mb-2"><h2 className="page-header-title text-orange-500">Storyboard</h2>{zoomControls}</div><div className={containerClass}><div style={frameStyle}><iframe src="https://libroalbum.github.io/tablero/" className="w-full h-full border-none"></iframe></div></div></div>;
                    
                    case 'padlet':
                        return <div className="h-full flex flex-col"><div className="flex justify-between mb-2"><h2 className="page-header-title text-cyan-500">Muro Colaborativo</h2>{zoomControls}</div><div className={containerClass}><div style={frameStyle}><iframe src="https://padlet.com/embed/kz78sfkwdm9abosj" className="w-full h-full border-none" allow="camera;microphone;geolocation;display-capture"></iframe></div></div></div>;

                    case 'quiz':
                        return (
                            <div className="h-full flex flex-col">
                                <div className="mb-2"><h2 className="module-title text-indigo-600 mb-2 text-3xl">QUIZ TIME</h2></div>
                                <div className={`${containerClass} border-indigo-100 group`}>
                                    <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/Kahoot-1.png?raw=true" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                        <a href="https://create.kahoot.it/share/quiz-interactivo/f8f5983d-25e9-44e7-aa46-eab37837811f" target="_blank" className="btn-modern bg-gradient-primary text-2xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform" style={{textDecoration: 'none'}}><i className="fas fa-play-circle mr-3"></i> HACER QUIZ</a>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'ficha_narrativa':
                        return (
                            <div className="h-full flex flex-col">
                                <div className="mb-2"><h2 className="module-title text-indigo-600 mb-2 text-3xl">FICHA NARRATIVA</h2></div>
                                <div className={`${containerClass} border-indigo-100 group`}>
                                    <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20narrativa.jpg?raw=true" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <a href="https://www.canva.com/design/DAG4JQ_26mk/yYHgZbuApHUSdalSG2938g/view" target="_blank" className="btn-modern bg-gradient-primary text-xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform decoration-none flex items-center gap-3" style={{textDecoration: 'none'}}><i className="fas fa-pen-nib"></i> RELLENAR LA FICHA</a>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'ficha_personajes':
                        return (
                            <div className="h-full flex flex-col">
                                <div className="mb-2"><h2 className="module-title text-indigo-600 mb-2 text-3xl">FICHA DE PERSONAJES</h2></div>
                                <div className={`${containerClass} border-indigo-100 group`}>
                                    <img src="https://github.com/libroalbum/crear-libro-album-digital/blob/main/ficha%20de%20personajes.png?raw=true" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/20 flex items-center justify-center">
                                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSdeATljdt5PMVoLzJ1x6S7sItasYY9hW2aiClLJpE1Yr1OyQw/viewform" target="_blank" className="btn-modern bg-gradient-primary text-2xl px-8 py-4 shadow-xl transform hover:scale-105 transition-transform" style={{textDecoration: 'none'}}><i className="fas fa-edit mr-3"></i> COMPLETAR FORMULARIO</a>
                                    </div>
                                </div>
                            </div>
                        );

                    default: return <div>Selecciona una opción</div>;
                }
            };

            return (
                <div className="flex flex-col h-full overflow-hidden bg-white">
                    {isProfileModalOpen && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <h3 className="text-2xl font-bold text-gray-800 mb-6">EDITAR PERFIL</h3>
                                <div className="flex flex-col items-center gap-6">
                                    <div className="relative group cursor-pointer w-32 h-32">
                                        {userProfile.photo ? <img src={userProfile.photo} className="w-full h-full rounded-full object-cover border-4 border-indigo-100"/> : <div className="w-full h-full rounded-full bg-indigo-50 flex items-center justify-center text-4xl text-indigo-300"><i className="fas fa-user"></i></div>}
                                        <div className="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i className="fas fa-camera text-white"></i></div>
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleProfilePic}/>
                                    </div>
                                    <input className="input-field-clean text-center text-xl" value={userProfile.name} onChange={(e)=>setUserProfile({...userProfile, name: e.target.value})} placeholder="Tu Nombre Artístico"/>
                                    <div className="flex gap-3 w-full">
                                        <button className="btn-modern bg-gradient-success flex-1" onClick={saveProfile}>GUARDAR</button>
                                        <button className="btn-modern bg-gray-400" onClick={()=>setIsProfileModalOpen(false)}>CANCELAR</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="classroom-container">
                        <div className="classroom-sidebar">
                            <div className="sidebar-logo">CREATOR STUDIO</div>
                            <div className="section-label">MI ESTUDIO</div>
                            <div className={`menu-item ${activeSection==='inicio'?'active':''}`} onClick={()=>setActiveSection('inicio')}><i className="fas fa-home"></i> Inicio</div>
                            <div className="menu-item" onClick={handleMyBook}><i className="fas fa-book-open"></i> Mi Libro</div>
                            <div className={`menu-item ${activeSection==='portafolio'?'active':''}`} onClick={()=>setActiveSection('portafolio')}><i className="fas fa-briefcase"></i> Portafolio</div>
                            <div className={`menu-item ${activeSection==='reference_book'?'active':''}`} onClick={()=>setActiveSection('reference_book')}><i className="fas fa-book"></i> Libro Guía</div>
                            <div className="section-label">LABORATORIO CREATIVO</div>
                            <div className={`menu-item ${activeSection==='moodboard'?'active':''}`} onClick={()=>setActiveSection('moodboard')}><i className="fas fa-palette text-purple-500"></i> Moodboard</div>
                            <div className={`menu-item ${activeSection==='ficha_personajes'?'active':''}`} onClick={()=>setActiveSection('ficha_personajes')}><i className="fas fa-user-tag text-pink-500"></i> Personajes</div>
                            <div className={`menu-item ${activeSection==='storyboard'?'active':''}`} onClick={()=>setActiveSection('storyboard')}><i className="fas fa-layer-group text-orange-500"></i> Storyboard</div>
                            <div className={`menu-item ${activeSection==='ficha_narrativa'?'active':''}`} onClick={()=>setActiveSection('ficha_narrativa')}><i className="fas fa-feather-alt text-rose-500"></i> Ficha Narrativa</div>
                            <div className={`menu-item ${activeSection==='padlet'?'active':''}`} onClick={()=>setActiveSection('padlet')}><i className="fas fa-comments text-cyan-500"></i> Muro Social</div>
                            <div className={`menu-item ${activeSection==='quiz'?'active':''}`} onClick={()=>setActiveSection('quiz')}><i className="fas fa-puzzle-piece text-yellow-500"></i> Quiz Time</div>
                        </div>
                        <div className="classroom-content">
                            <div className="top-bar-glass">
                                <div></div> 
                                <div className="flex items-center gap-4">
                                    <div className="user-chip" onClick={()=>setIsProfileModalOpen(true)}>
                                        <div className="user-info"><span className="user-name">{userProfile.name}</span><span className="user-role">CREATOR</span></div>
                                        {userProfile.photo ? <img src={userProfile.photo} className="user-avatar"/> : <div className="user-avatar flex items-center justify-center bg-gray-100 text-gray-400 font-bold">{userProfile.name.charAt(0)}</div>}
                                    </div>
                                    <button onClick={()=>signOut(auth)} className="w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition shadow-sm"><i className="fas fa-power-off"></i></button>
                                </div>
                            </div>
                            {renderActivityContent()}
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('loading'); 
            const [portfolioUid, setPortfolioUid] = useState(null);
            const [publicActivity, setPublicActivity] = useState(null);
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const pUid = params.get('portfolio');
                const activityParam = params.get('activity'); 
                if (pUid) { setPortfolioUid(pUid); setView('public-view'); } 
                else if (activityParam) { setPublicActivity(activityParam); setView('public-activity'); } 
                else { if (auth) { onAuthStateChanged(auth, (u) => { setUser(u); setView(u ? 'dashboard' : 'login'); }); } }
            }, []);
            if (view === 'public-view') return <PublicGallery uid={portfolioUid} />;
            if (view === 'public-activity') return <PublicActivityViewer activity={publicActivity} />;
            if (view === 'loading') return <div className="flex h-screen items-center justify-center font-bold text-xl text-indigo-500 font-outfit animate-pulse">CARGANDO STUDIO...</div>;
            return (
                <div className="flex flex-col h-full font-sans">
                    <main className="flex-1 relative overflow-hidden">
                        {view === 'login' && <LoginScreen setUser={setUser} setView={setView} />}
                        {view === 'dashboard' && <Dashboard user={user} setView={setView} />}
                        {view === 'editor' && <Editor user={user} setView={setView} />}
                        {view === 'external' && (
                            <div className="w-full h-full bg-white relative flex flex-col">
                                <div className="h-14 bg-gray-900 flex items-center justify-between px-6 shadow-lg z-50"><span className="text-white font-bold font-outfit">Herramienta Externa</span><button onClick={() => setView('dashboard')} className="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded-full font-bold text-sm transition">CERRAR</button></div>
                                <iframe src={user.toolUrl} style={{width:'100%', height:'100%', border:'none'}}></iframe>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
